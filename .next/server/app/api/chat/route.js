"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
(() => {
var exports = {};
exports.id = "app/api/chat/route";
exports.ids = ["app/api/chat/route"];
exports.modules = {

/***/ "mongodb":
/*!**************************!*\
  !*** external "mongodb" ***!
  \**************************/
/***/ ((module) => {

module.exports = require("mongodb");

/***/ }),

/***/ "next/dist/compiled/next-server/app-route.runtime.dev.js":
/*!**************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-route.runtime.dev.js" ***!
  \**************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/app-route.runtime.dev.js");

/***/ }),

/***/ "fs":
/*!*********************!*\
  !*** external "fs" ***!
  \*********************/
/***/ ((module) => {

module.exports = require("fs");

/***/ }),

/***/ "http":
/*!***********************!*\
  !*** external "http" ***!
  \***********************/
/***/ ((module) => {

module.exports = require("http");

/***/ }),

/***/ "https":
/*!************************!*\
  !*** external "https" ***!
  \************************/
/***/ ((module) => {

module.exports = require("https");

/***/ }),

/***/ "node:fs":
/*!**************************!*\
  !*** external "node:fs" ***!
  \**************************/
/***/ ((module) => {

module.exports = require("node:fs");

/***/ }),

/***/ "node:stream":
/*!******************************!*\
  !*** external "node:stream" ***!
  \******************************/
/***/ ((module) => {

module.exports = require("node:stream");

/***/ }),

/***/ "node:stream/web":
/*!**********************************!*\
  !*** external "node:stream/web" ***!
  \**********************************/
/***/ ((module) => {

module.exports = require("node:stream/web");

/***/ }),

/***/ "path":
/*!***********************!*\
  !*** external "path" ***!
  \***********************/
/***/ ((module) => {

module.exports = require("path");

/***/ }),

/***/ "punycode":
/*!***************************!*\
  !*** external "punycode" ***!
  \***************************/
/***/ ((module) => {

module.exports = require("punycode");

/***/ }),

/***/ "stream":
/*!*************************!*\
  !*** external "stream" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("stream");

/***/ }),

/***/ "url":
/*!**********************!*\
  !*** external "url" ***!
  \**********************/
/***/ ((module) => {

module.exports = require("url");

/***/ }),

/***/ "util":
/*!***********************!*\
  !*** external "util" ***!
  \***********************/
/***/ ((module) => {

module.exports = require("util");

/***/ }),

/***/ "worker_threads":
/*!*********************************!*\
  !*** external "worker_threads" ***!
  \*********************************/
/***/ ((module) => {

module.exports = require("worker_threads");

/***/ }),

/***/ "zlib":
/*!***********************!*\
  !*** external "zlib" ***!
  \***********************/
/***/ ((module) => {

module.exports = require("zlib");

/***/ }),

/***/ "(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fchat%2Froute&page=%2Fapi%2Fchat%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2Froute.ts&appDir=C%3A%5CUsers%5CDeborah%5CDocuments%5CCursor%20Projects%5Cchatpye%5Csrc%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CUsers%5CDeborah%5CDocuments%5CCursor%20Projects%5Cchatpye&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!":
/*!******************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************!*\
  !*** ./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fchat%2Froute&page=%2Fapi%2Fchat%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2Froute.ts&appDir=C%3A%5CUsers%5CDeborah%5CDocuments%5CCursor%20Projects%5Cchatpye%5Csrc%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CUsers%5CDeborah%5CDocuments%5CCursor%20Projects%5Cchatpye&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D! ***!
  \******************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   headerHooks: () => (/* binding */ headerHooks),\n/* harmony export */   originalPathname: () => (/* binding */ originalPathname),\n/* harmony export */   patchFetch: () => (/* binding */ patchFetch),\n/* harmony export */   requestAsyncStorage: () => (/* binding */ requestAsyncStorage),\n/* harmony export */   routeModule: () => (/* binding */ routeModule),\n/* harmony export */   serverHooks: () => (/* binding */ serverHooks),\n/* harmony export */   staticGenerationAsyncStorage: () => (/* binding */ staticGenerationAsyncStorage),\n/* harmony export */   staticGenerationBailout: () => (/* binding */ staticGenerationBailout)\n/* harmony export */ });\n/* harmony import */ var next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/dist/server/future/route-modules/app-route/module.compiled */ \"(rsc)/./node_modules/next/dist/server/future/route-modules/app-route/module.compiled.js\");\n/* harmony import */ var next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/dist/server/future/route-kind */ \"(rsc)/./node_modules/next/dist/server/future/route-kind.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! next/dist/server/lib/patch-fetch */ \"(rsc)/./node_modules/next/dist/server/lib/patch-fetch.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var C_Users_Deborah_Documents_Cursor_Projects_chatpye_src_app_api_chat_route_ts__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./src/app/api/chat/route.ts */ \"(rsc)/./src/app/api/chat/route.ts\");\n\n\n\n\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new next_dist_server_future_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__.AppRouteRouteModule({\n    definition: {\n        kind: next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__.RouteKind.APP_ROUTE,\n        page: \"/api/chat/route\",\n        pathname: \"/api/chat\",\n        filename: \"route\",\n        bundlePath: \"app/api/chat/route\"\n    },\n    resolvedPagePath: \"C:\\\\Users\\\\Deborah\\\\Documents\\\\Cursor Projects\\\\chatpye\\\\src\\\\app\\\\api\\\\chat\\\\route.ts\",\n    nextConfigOutput,\n    userland: C_Users_Deborah_Documents_Cursor_Projects_chatpye_src_app_api_chat_route_ts__WEBPACK_IMPORTED_MODULE_3__\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { requestAsyncStorage, staticGenerationAsyncStorage, serverHooks, headerHooks, staticGenerationBailout } = routeModule;\nconst originalPathname = \"/api/chat/route\";\nfunction patchFetch() {\n    return (0,next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__.patchFetch)({\n        serverHooks,\n        staticGenerationAsyncStorage\n    });\n}\n\n\n//# sourceMappingURL=app-route.js.map//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9ub2RlX21vZHVsZXMvbmV4dC9kaXN0L2J1aWxkL3dlYnBhY2svbG9hZGVycy9uZXh0LWFwcC1sb2FkZXIuanM/bmFtZT1hcHAlMkZhcGklMkZjaGF0JTJGcm91dGUmcGFnZT0lMkZhcGklMkZjaGF0JTJGcm91dGUmYXBwUGF0aHM9JnBhZ2VQYXRoPXByaXZhdGUtbmV4dC1hcHAtZGlyJTJGYXBpJTJGY2hhdCUyRnJvdXRlLnRzJmFwcERpcj1DJTNBJTVDVXNlcnMlNUNEZWJvcmFoJTVDRG9jdW1lbnRzJTVDQ3Vyc29yJTIwUHJvamVjdHMlNUNjaGF0cHllJTVDc3JjJTVDYXBwJnBhZ2VFeHRlbnNpb25zPXRzeCZwYWdlRXh0ZW5zaW9ucz10cyZwYWdlRXh0ZW5zaW9ucz1qc3gmcGFnZUV4dGVuc2lvbnM9anMmcm9vdERpcj1DJTNBJTVDVXNlcnMlNUNEZWJvcmFoJTVDRG9jdW1lbnRzJTVDQ3Vyc29yJTIwUHJvamVjdHMlNUNjaGF0cHllJmlzRGV2PXRydWUmdHNjb25maWdQYXRoPXRzY29uZmlnLmpzb24mYmFzZVBhdGg9JmFzc2V0UHJlZml4PSZuZXh0Q29uZmlnT3V0cHV0PSZwcmVmZXJyZWRSZWdpb249Jm1pZGRsZXdhcmVDb25maWc9ZTMwJTNEISIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFzRztBQUN2QztBQUNjO0FBQ3NDO0FBQ25IO0FBQ0E7QUFDQTtBQUNBLHdCQUF3QixnSEFBbUI7QUFDM0M7QUFDQSxjQUFjLHlFQUFTO0FBQ3ZCO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxZQUFZO0FBQ1osQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBLFFBQVEsdUdBQXVHO0FBQy9HO0FBQ0E7QUFDQSxXQUFXLDRFQUFXO0FBQ3RCO0FBQ0E7QUFDQSxLQUFLO0FBQ0w7QUFDNko7O0FBRTdKIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vY2hhdHB5ZS8/MDcxZCJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHBSb3V0ZVJvdXRlTW9kdWxlIH0gZnJvbSBcIm5leHQvZGlzdC9zZXJ2ZXIvZnV0dXJlL3JvdXRlLW1vZHVsZXMvYXBwLXJvdXRlL21vZHVsZS5jb21waWxlZFwiO1xuaW1wb3J0IHsgUm91dGVLaW5kIH0gZnJvbSBcIm5leHQvZGlzdC9zZXJ2ZXIvZnV0dXJlL3JvdXRlLWtpbmRcIjtcbmltcG9ydCB7IHBhdGNoRmV0Y2ggYXMgX3BhdGNoRmV0Y2ggfSBmcm9tIFwibmV4dC9kaXN0L3NlcnZlci9saWIvcGF0Y2gtZmV0Y2hcIjtcbmltcG9ydCAqIGFzIHVzZXJsYW5kIGZyb20gXCJDOlxcXFxVc2Vyc1xcXFxEZWJvcmFoXFxcXERvY3VtZW50c1xcXFxDdXJzb3IgUHJvamVjdHNcXFxcY2hhdHB5ZVxcXFxzcmNcXFxcYXBwXFxcXGFwaVxcXFxjaGF0XFxcXHJvdXRlLnRzXCI7XG4vLyBXZSBpbmplY3QgdGhlIG5leHRDb25maWdPdXRwdXQgaGVyZSBzbyB0aGF0IHdlIGNhbiB1c2UgdGhlbSBpbiB0aGUgcm91dGVcbi8vIG1vZHVsZS5cbmNvbnN0IG5leHRDb25maWdPdXRwdXQgPSBcIlwiXG5jb25zdCByb3V0ZU1vZHVsZSA9IG5ldyBBcHBSb3V0ZVJvdXRlTW9kdWxlKHtcbiAgICBkZWZpbml0aW9uOiB7XG4gICAgICAgIGtpbmQ6IFJvdXRlS2luZC5BUFBfUk9VVEUsXG4gICAgICAgIHBhZ2U6IFwiL2FwaS9jaGF0L3JvdXRlXCIsXG4gICAgICAgIHBhdGhuYW1lOiBcIi9hcGkvY2hhdFwiLFxuICAgICAgICBmaWxlbmFtZTogXCJyb3V0ZVwiLFxuICAgICAgICBidW5kbGVQYXRoOiBcImFwcC9hcGkvY2hhdC9yb3V0ZVwiXG4gICAgfSxcbiAgICByZXNvbHZlZFBhZ2VQYXRoOiBcIkM6XFxcXFVzZXJzXFxcXERlYm9yYWhcXFxcRG9jdW1lbnRzXFxcXEN1cnNvciBQcm9qZWN0c1xcXFxjaGF0cHllXFxcXHNyY1xcXFxhcHBcXFxcYXBpXFxcXGNoYXRcXFxccm91dGUudHNcIixcbiAgICBuZXh0Q29uZmlnT3V0cHV0LFxuICAgIHVzZXJsYW5kXG59KTtcbi8vIFB1bGwgb3V0IHRoZSBleHBvcnRzIHRoYXQgd2UgbmVlZCB0byBleHBvc2UgZnJvbSB0aGUgbW9kdWxlLiBUaGlzIHNob3VsZFxuLy8gYmUgZWxpbWluYXRlZCB3aGVuIHdlJ3ZlIG1vdmVkIHRoZSBvdGhlciByb3V0ZXMgdG8gdGhlIG5ldyBmb3JtYXQuIFRoZXNlXG4vLyBhcmUgdXNlZCB0byBob29rIGludG8gdGhlIHJvdXRlLlxuY29uc3QgeyByZXF1ZXN0QXN5bmNTdG9yYWdlLCBzdGF0aWNHZW5lcmF0aW9uQXN5bmNTdG9yYWdlLCBzZXJ2ZXJIb29rcywgaGVhZGVySG9va3MsIHN0YXRpY0dlbmVyYXRpb25CYWlsb3V0IH0gPSByb3V0ZU1vZHVsZTtcbmNvbnN0IG9yaWdpbmFsUGF0aG5hbWUgPSBcIi9hcGkvY2hhdC9yb3V0ZVwiO1xuZnVuY3Rpb24gcGF0Y2hGZXRjaCgpIHtcbiAgICByZXR1cm4gX3BhdGNoRmV0Y2goe1xuICAgICAgICBzZXJ2ZXJIb29rcyxcbiAgICAgICAgc3RhdGljR2VuZXJhdGlvbkFzeW5jU3RvcmFnZVxuICAgIH0pO1xufVxuZXhwb3J0IHsgcm91dGVNb2R1bGUsIHJlcXVlc3RBc3luY1N0b3JhZ2UsIHN0YXRpY0dlbmVyYXRpb25Bc3luY1N0b3JhZ2UsIHNlcnZlckhvb2tzLCBoZWFkZXJIb29rcywgc3RhdGljR2VuZXJhdGlvbkJhaWxvdXQsIG9yaWdpbmFsUGF0aG5hbWUsIHBhdGNoRmV0Y2gsICB9O1xuXG4vLyMgc291cmNlTWFwcGluZ1VSTD1hcHAtcm91dGUuanMubWFwIl0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fchat%2Froute&page=%2Fapi%2Fchat%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2Froute.ts&appDir=C%3A%5CUsers%5CDeborah%5CDocuments%5CCursor%20Projects%5Cchatpye%5Csrc%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CUsers%5CDeborah%5CDocuments%5CCursor%20Projects%5Cchatpye&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!\n");

/***/ }),

/***/ "(rsc)/./src/app/api/chat/route.ts":
/*!***********************************!*\
  !*** ./src/app/api/chat/route.ts ***!
  \***********************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   POST: () => (/* binding */ POST)\n/* harmony export */ });\n/* harmony import */ var next_dist_server_web_exports_next_response__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/dist/server/web/exports/next-response */ \"(rsc)/./node_modules/next/dist/server/web/exports/next-response.js\");\n/* harmony import */ var _lib_mongodb__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! @/lib/mongodb */ \"(rsc)/./src/lib/mongodb.ts\");\n/* harmony import */ var _lib_embeddings__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! @/lib/embeddings */ \"(rsc)/./src/lib/embeddings.ts\");\n/* harmony import */ var _lib_openai__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! @/lib/openai */ \"(rsc)/./src/lib/openai.ts\");\n/* harmony import */ var _lib_anthropic__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! @/lib/anthropic */ \"(rsc)/./src/lib/anthropic.ts\");\n/* harmony import */ var _lib_gemini__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! @/lib/gemini */ \"(rsc)/./src/lib/gemini.ts\");\n\n\n\n\n\n\n// Helper to normalize questions for consistent cache keys\nfunction normalizeQuestion(question) {\n    return question.toLowerCase().trim().replace(/\\s+/g, \" \");\n}\n// Utility to convert AsyncIterable<string> to ReadableStream<Uint8Array>\n// and call an onComplete callback with the accumulated text.\nasync function processStreamForResponseAndCache(streamGenerator, onComplete) {\n    let accumulatedText = \"\";\n    const encoder = new TextEncoder();\n    let streamClosed = false; // Flag to prevent multiple onComplete calls\n    const readableStream = new ReadableStream({\n        async pull (controller) {\n            try {\n                const { value, done } = await streamGenerator.next();\n                if (done) {\n                    if (!streamClosed) {\n                        streamClosed = true;\n                        controller.close();\n                        // Call onComplete asynchronously without blocking stream closure\n                        onComplete(accumulatedText).catch((cacheError)=>{\n                            console.error(\"Error saving to cache post-stream:\", cacheError);\n                        });\n                    }\n                } else {\n                    accumulatedText += value;\n                    controller.enqueue(encoder.encode(value));\n                }\n            } catch (error) {\n                console.error(\"Error in stream generator during pull:\", error);\n                if (!streamClosed) {\n                    streamClosed = true;\n                    controller.error(error); // Propagate error to the stream consumer\n                }\n            }\n        },\n        async cancel (reason) {\n            console.log(\"Stream cancelled by client:\", reason);\n            if (!streamClosed) {\n                streamClosed = true;\n                if (typeof streamGenerator.return === \"function\") {\n                    try {\n                        await streamGenerator.return(undefined); // Ensure generator cleanup\n                    } catch (genError) {\n                        console.error(\"Error during generator return on cancel:\", genError);\n                    }\n                }\n            }\n        }\n    });\n    return readableStream;\n}\nasync function POST(request) {\n    try {\n        const { message, jobId, modelId, videoId } = await request.json();\n        if (!message || !modelId) {\n            return next_dist_server_web_exports_next_response__WEBPACK_IMPORTED_MODULE_0__[\"default\"].json({\n                error: \"Message and modelId are required\",\n                stream: false,\n                fromCache: false\n            }, {\n                status: 400\n            });\n        }\n        // For non-Gemini models, jobId is required\n        if (modelId !== \"gemini\" && !jobId) {\n            return next_dist_server_web_exports_next_response__WEBPACK_IMPORTED_MODULE_0__[\"default\"].json({\n                error: \"jobId is required for non-Gemini models\",\n                stream: false,\n                fromCache: false\n            }, {\n                status: 400\n            });\n        }\n        // For Gemini model, either jobId or videoId is required\n        if (modelId === \"gemini\" && !jobId && !videoId) {\n            return next_dist_server_web_exports_next_response__WEBPACK_IMPORTED_MODULE_0__[\"default\"].json({\n                error: \"Either jobId or videoId is required for Gemini model\",\n                stream: false,\n                fromCache: false\n            }, {\n                status: 400\n            });\n        }\n        const supportedModels = [\n            \"gemini\",\n            \"openai\",\n            \"anthropic\"\n        ];\n        if (!supportedModels.includes(modelId)) {\n            return next_dist_server_web_exports_next_response__WEBPACK_IMPORTED_MODULE_0__[\"default\"].json({\n                error: `Invalid modelId. Supported models are: ${supportedModels.join(\", \")}`\n            }, {\n                status: 400\n            });\n        }\n        const normalizedQuestion = normalizeQuestion(message);\n        // Define model used for cache key based on actual model being used by the service\n        // This might need to be more dynamic if model versions change in services\n        let modelUsedForCacheKey;\n        // --- Gemini Model Path (Defaulting to Direct YouTube URL Streaming with Cache) ---\n        if (modelId === \"gemini\") {\n            modelUsedForCacheKey = \"gemini-1.5-pro\"; // Updated cache key\n            // 1. Check Cache First\n            const cachedResponse = await (0,_lib_mongodb__WEBPACK_IMPORTED_MODULE_1__.getCachedQAResponse)(jobId, normalizedQuestion, modelUsedForCacheKey);\n            if (cachedResponse) {\n                console.log(`CACHE_HIT: Gemini - JobId: ${jobId}, Question: \"${normalizedQuestion}\"`);\n                return next_dist_server_web_exports_next_response__WEBPACK_IMPORTED_MODULE_0__[\"default\"].json({\n                    message: cachedResponse.responseText,\n                    fromCache: true,\n                    stream: false\n                });\n            }\n            console.log(`CACHE_MISS: Gemini - JobId: ${jobId}, Question: \"${normalizedQuestion}\"`);\n            // 2. Get transcript chunks for RAG-based approach\n            const chunks = await (0,_lib_mongodb__WEBPACK_IMPORTED_MODULE_1__.getTranscriptChunks)(jobId);\n            if (!chunks || chunks.length === 0) {\n                return next_dist_server_web_exports_next_response__WEBPACK_IMPORTED_MODULE_0__[\"default\"].json({\n                    error: \"No transcript chunks found for this video.\",\n                    stream: false,\n                    fromCache: false\n                }, {\n                    status: 404\n                });\n            }\n            // 3. Find relevant chunks for the question\n            const relevantChunks = await (0,_lib_embeddings__WEBPACK_IMPORTED_MODULE_2__.findRelevantChunks)(message, chunks);\n            const serviceContext = relevantChunks.map((chunk)=>({\n                    text: chunk.textContent,\n                    startTimestamp: chunk.startTimestamp.toString(),\n                    endTimestamp: chunk.endTimestamp.toString()\n                }));\n            if (!serviceContext || serviceContext.length === 0) {\n                return next_dist_server_web_exports_next_response__WEBPACK_IMPORTED_MODULE_0__[\"default\"].json({\n                    error: \"Could not derive relevant context for this question from the video transcript.\"\n                }, {\n                    status: 404\n                });\n            }\n            // 4. Generate response using RAG-based approach\n            try {\n                const liveStreamGenerator = _lib_gemini__WEBPACK_IMPORTED_MODULE_5__.geminiService.generateAnswer(serviceContext, message, videoId);\n                const streamForClient = await processStreamForResponseAndCache(liveStreamGenerator, async (fullText)=>{\n                    if (fullText && fullText.trim().length > 0) {\n                        await (0,_lib_mongodb__WEBPACK_IMPORTED_MODULE_1__.saveQAResponse)(jobId, normalizedQuestion, modelUsedForCacheKey, fullText, \"user_question\");\n                        console.log(`Gemini response for JobId '${jobId}', Question '${normalizedQuestion}' cached successfully.`);\n                    }\n                });\n                return new Response(streamForClient, {\n                    headers: {\n                        \"Content-Type\": \"text/plain; charset=utf-8\",\n                        \"Transfer-Encoding\": \"chunked\"\n                    }\n                });\n            } catch (error) {\n                console.error(`Error during Gemini stream setup or service call (JobId: ${jobId}):`, error.message, error.stack);\n                return next_dist_server_web_exports_next_response__WEBPACK_IMPORTED_MODULE_0__[\"default\"].json({\n                    error: \"Failed to get or start Gemini stream.\",\n                    errorMessage: error.message,\n                    stream: false,\n                    fromCache: false\n                }, {\n                    status: 500\n                });\n            }\n        } else {\n            const chunks = await (0,_lib_mongodb__WEBPACK_IMPORTED_MODULE_1__.getTranscriptChunks)(jobId);\n            if (!chunks || chunks.length === 0) {\n                return next_dist_server_web_exports_next_response__WEBPACK_IMPORTED_MODULE_0__[\"default\"].json({\n                    error: \"No transcript chunks found for this video to use with selected model.\",\n                    stream: false,\n                    fromCache: false\n                }, {\n                    status: 404\n                });\n            }\n            const relevantChunks = await (0,_lib_embeddings__WEBPACK_IMPORTED_MODULE_2__.findRelevantChunks)(message, chunks);\n            const serviceContext = relevantChunks.map((chunk)=>({\n                    text: chunk.textContent,\n                    startTimestamp: chunk.startTimestamp.toString(),\n                    endTimestamp: chunk.endTimestamp.toString()\n                }));\n            if (!serviceContext || serviceContext.length === 0) {\n                return next_dist_server_web_exports_next_response__WEBPACK_IMPORTED_MODULE_0__[\"default\"].json({\n                    error: \"Could not derive relevant context for this question from the video transcript.\"\n                }, {\n                    status: 404\n                });\n            }\n            let text = \"\";\n            if (modelId === \"openai\") {\n                modelUsedForCacheKey = \"openai-gpt-3.5-turbo\"; // Example\n                // TODO: Implement caching for OpenAI if desired, following similar pattern as Gemini\n                text = await _lib_openai__WEBPACK_IMPORTED_MODULE_3__.openAIService.generateAnswer(serviceContext, message);\n            } else if (modelId === \"anthropic\") {\n                modelUsedForCacheKey = \"anthropic-claude-3-opus\"; // Example\n                // TODO: Implement caching for Anthropic if desired\n                text = await _lib_anthropic__WEBPACK_IMPORTED_MODULE_4__.anthropicService.generateAnswer(serviceContext, message);\n            } else {\n                return next_dist_server_web_exports_next_response__WEBPACK_IMPORTED_MODULE_0__[\"default\"].json({\n                    error: \"Invalid modelId provided.\"\n                }, {\n                    status: 400\n                });\n            }\n            // For now, OpenAI and Anthropic are non-streaming and don't use the new cache write path.\n            // If they were to be cached, the saveQAResponse would be called here.\n            return next_dist_server_web_exports_next_response__WEBPACK_IMPORTED_MODULE_0__[\"default\"].json({\n                message: text,\n                fromCache: false,\n                stream: false\n            });\n        }\n    } catch (error) {\n        console.error(\"General error in /api/chat POST:\", error.message, error.stack);\n        // Ensure a JSON response for errors not caught by specific blocks\n        return next_dist_server_web_exports_next_response__WEBPACK_IMPORTED_MODULE_0__[\"default\"].json({\n            error: \"Failed to generate response due to an unexpected internal server error.\",\n            errorMessage: error.message,\n            stream: false,\n            fromCache: false\n        }, {\n            status: 500\n        });\n    }\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9zcmMvYXBwL2FwaS9jaGF0L3JvdXRlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBMEM7QUFDMkQ7QUFDaEQ7QUFDUjtBQUNNO0FBQ047QUFFN0MsMERBQTBEO0FBQzFELFNBQVNRLGtCQUFrQkMsUUFBZ0I7SUFDekMsT0FBT0EsU0FBU0MsV0FBVyxHQUFHQyxJQUFJLEdBQUdDLE9BQU8sQ0FBQyxRQUFRO0FBQ3ZEO0FBRUEseUVBQXlFO0FBQ3pFLDZEQUE2RDtBQUM3RCxlQUFlQyxpQ0FDYkMsZUFBdUMsRUFDdkNDLFVBQStDO0lBRS9DLElBQUlDLGtCQUFrQjtJQUN0QixNQUFNQyxVQUFVLElBQUlDO0lBQ3BCLElBQUlDLGVBQWUsT0FBTyw0Q0FBNEM7SUFFdEUsTUFBTUMsaUJBQWlCLElBQUlDLGVBQTJCO1FBQ3BELE1BQU1DLE1BQUtDLFVBQVU7WUFDbkIsSUFBSTtnQkFDRixNQUFNLEVBQUVDLEtBQUssRUFBRUMsSUFBSSxFQUFFLEdBQUcsTUFBTVgsZ0JBQWdCWSxJQUFJO2dCQUNsRCxJQUFJRCxNQUFNO29CQUNSLElBQUksQ0FBQ04sY0FBYzt3QkFDakJBLGVBQWU7d0JBQ2ZJLFdBQVdJLEtBQUs7d0JBQ2hCLGlFQUFpRTt3QkFDakVaLFdBQVdDLGlCQUFpQlksS0FBSyxDQUFDQyxDQUFBQTs0QkFDaENDLFFBQVFDLEtBQUssQ0FBQyxzQ0FBc0NGO3dCQUN0RDtvQkFDRjtnQkFDRixPQUFPO29CQUNMYixtQkFBbUJRO29CQUNuQkQsV0FBV1MsT0FBTyxDQUFDZixRQUFRZ0IsTUFBTSxDQUFDVDtnQkFDcEM7WUFDRixFQUFFLE9BQU9PLE9BQU87Z0JBQ2RELFFBQVFDLEtBQUssQ0FBQywwQ0FBMENBO2dCQUN4RCxJQUFJLENBQUNaLGNBQWM7b0JBQ2pCQSxlQUFlO29CQUNmSSxXQUFXUSxLQUFLLENBQUNBLFFBQVEseUNBQXlDO2dCQUNwRTtZQUNGO1FBQ0Y7UUFDQSxNQUFNRyxRQUFPQyxNQUFNO1lBQ2pCTCxRQUFRTSxHQUFHLENBQUMsK0JBQStCRDtZQUMzQyxJQUFJLENBQUNoQixjQUFjO2dCQUNqQkEsZUFBZTtnQkFDZixJQUFJLE9BQU9MLGdCQUFnQnVCLE1BQU0sS0FBSyxZQUFZO29CQUNoRCxJQUFJO3dCQUNGLE1BQU12QixnQkFBZ0J1QixNQUFNLENBQUNDLFlBQVksMkJBQTJCO29CQUN0RSxFQUFFLE9BQU9DLFVBQVU7d0JBQ2pCVCxRQUFRQyxLQUFLLENBQUMsNENBQTRDUTtvQkFDNUQ7Z0JBQ0Y7WUFDRjtRQUNGO0lBQ0Y7SUFDQSxPQUFPbkI7QUFDVDtBQUVPLGVBQWVvQixLQUFLQyxPQUFnQjtJQUN6QyxJQUFJO1FBQ0YsTUFBTSxFQUFFQyxPQUFPLEVBQUVDLEtBQUssRUFBRUMsT0FBTyxFQUFFQyxPQUFPLEVBQUUsR0FBRyxNQUFNSixRQUFRSyxJQUFJO1FBRS9ELElBQUksQ0FBQ0osV0FBVyxDQUFDRSxTQUFTO1lBQ3hCLE9BQU81QyxrRkFBWUEsQ0FBQzhDLElBQUksQ0FDdEI7Z0JBQUVmLE9BQU87Z0JBQW9DZ0IsUUFBUTtnQkFBT0MsV0FBVztZQUFNLEdBQzdFO2dCQUFFQyxRQUFRO1lBQUk7UUFFbEI7UUFFQSwyQ0FBMkM7UUFDM0MsSUFBSUwsWUFBWSxZQUFZLENBQUNELE9BQU87WUFDbEMsT0FBTzNDLGtGQUFZQSxDQUFDOEMsSUFBSSxDQUN0QjtnQkFBRWYsT0FBTztnQkFBMkNnQixRQUFRO2dCQUFPQyxXQUFXO1lBQU0sR0FDcEY7Z0JBQUVDLFFBQVE7WUFBSTtRQUVsQjtRQUVBLHdEQUF3RDtRQUN4RCxJQUFJTCxZQUFZLFlBQVksQ0FBQ0QsU0FBUyxDQUFDRSxTQUFTO1lBQzlDLE9BQU83QyxrRkFBWUEsQ0FBQzhDLElBQUksQ0FDdEI7Z0JBQUVmLE9BQU87Z0JBQXdEZ0IsUUFBUTtnQkFBT0MsV0FBVztZQUFNLEdBQ2pHO2dCQUFFQyxRQUFRO1lBQUk7UUFFbEI7UUFFQSxNQUFNQyxrQkFBa0I7WUFBQztZQUFVO1lBQVU7U0FBWTtRQUN6RCxJQUFJLENBQUNBLGdCQUFnQkMsUUFBUSxDQUFDUCxVQUFVO1lBQ3RDLE9BQU81QyxrRkFBWUEsQ0FBQzhDLElBQUksQ0FDdEI7Z0JBQUVmLE9BQU8sQ0FBQyx1Q0FBdUMsRUFBRW1CLGdCQUFnQkUsSUFBSSxDQUFDLE1BQU0sQ0FBQztZQUFDLEdBQ2hGO2dCQUFFSCxRQUFRO1lBQUk7UUFFbEI7UUFFQSxNQUFNSSxxQkFBcUI3QyxrQkFBa0JrQztRQUM3QyxrRkFBa0Y7UUFDbEYsMEVBQTBFO1FBQzFFLElBQUlZO1FBRUosb0ZBQW9GO1FBQ3BGLElBQUlWLFlBQVksVUFBVTtZQUN4QlUsdUJBQXVCLGtCQUFrQixvQkFBb0I7WUFFN0QsdUJBQXVCO1lBQ3ZCLE1BQU1DLGlCQUFpQixNQUFNckQsaUVBQW1CQSxDQUFDeUMsT0FBT1Usb0JBQW9CQztZQUM1RSxJQUFJQyxnQkFBZ0I7Z0JBQ2xCekIsUUFBUU0sR0FBRyxDQUFDLENBQUMsMkJBQTJCLEVBQUVPLE1BQU0sYUFBYSxFQUFFVSxtQkFBbUIsQ0FBQyxDQUFDO2dCQUNwRixPQUFPckQsa0ZBQVlBLENBQUM4QyxJQUFJLENBQUM7b0JBQ3ZCSixTQUFTYSxlQUFlQyxZQUFZO29CQUNwQ1IsV0FBVztvQkFDWEQsUUFBUTtnQkFDVjtZQUNGO1lBQ0FqQixRQUFRTSxHQUFHLENBQUMsQ0FBQyw0QkFBNEIsRUFBRU8sTUFBTSxhQUFhLEVBQUVVLG1CQUFtQixDQUFDLENBQUM7WUFFckYsa0RBQWtEO1lBQ2xELE1BQU1JLFNBQVMsTUFBTXhELGlFQUFtQkEsQ0FBQzBDO1lBQ3pDLElBQUksQ0FBQ2MsVUFBVUEsT0FBT0MsTUFBTSxLQUFLLEdBQUc7Z0JBQ2xDLE9BQU8xRCxrRkFBWUEsQ0FBQzhDLElBQUksQ0FDdEI7b0JBQUVmLE9BQU87b0JBQThDZ0IsUUFBUTtvQkFBT0MsV0FBVztnQkFBTSxHQUN2RjtvQkFBRUMsUUFBUTtnQkFBSTtZQUVsQjtZQUVBLDJDQUEyQztZQUMzQyxNQUFNVSxpQkFBaUIsTUFBTXZELG1FQUFrQkEsQ0FBQ3NDLFNBQVNlO1lBQ3pELE1BQU1HLGlCQUFpQkQsZUFBZUUsR0FBRyxDQUFDQyxDQUFBQSxRQUFVO29CQUNsREMsTUFBTUQsTUFBTUUsV0FBVztvQkFDdkJDLGdCQUFnQkgsTUFBTUcsY0FBYyxDQUFDQyxRQUFRO29CQUM3Q0MsY0FBY0wsTUFBTUssWUFBWSxDQUFDRCxRQUFRO2dCQUMzQztZQUVBLElBQUksQ0FBQ04sa0JBQWtCQSxlQUFlRixNQUFNLEtBQUssR0FBRztnQkFDbEQsT0FBTzFELGtGQUFZQSxDQUFDOEMsSUFBSSxDQUN0QjtvQkFBRWYsT0FBTztnQkFBaUYsR0FDMUY7b0JBQUVrQixRQUFRO2dCQUFJO1lBRWxCO1lBRUEsZ0RBQWdEO1lBQ2hELElBQUk7Z0JBQ0YsTUFBTW1CLHNCQUFzQjdELHNEQUFhQSxDQUFDOEQsY0FBYyxDQUFDVCxnQkFBZ0JsQixTQUFTRztnQkFFbEYsTUFBTXlCLGtCQUFrQixNQUFNekQsaUNBQzVCdUQscUJBQ0EsT0FBT0c7b0JBQ0wsSUFBSUEsWUFBWUEsU0FBUzVELElBQUksR0FBRytDLE1BQU0sR0FBRyxHQUFHO3dCQUMxQyxNQUFNdkQsNERBQWNBLENBQUN3QyxPQUFPVSxvQkFBb0JDLHNCQUFzQmlCLFVBQVU7d0JBQ2hGekMsUUFBUU0sR0FBRyxDQUFDLENBQUMsMkJBQTJCLEVBQUVPLE1BQU0sYUFBYSxFQUFFVSxtQkFBbUIsc0JBQXNCLENBQUM7b0JBQzNHO2dCQUNGO2dCQUVGLE9BQU8sSUFBSW1CLFNBQVNGLGlCQUFpQjtvQkFDbkNHLFNBQVM7d0JBQ1AsZ0JBQWdCO3dCQUNoQixxQkFBcUI7b0JBQ3ZCO2dCQUNGO1lBQ0YsRUFBRSxPQUFPMUMsT0FBWTtnQkFDbkJELFFBQVFDLEtBQUssQ0FBQyxDQUFDLHlEQUF5RCxFQUFFWSxNQUFNLEVBQUUsQ0FBQyxFQUFFWixNQUFNVyxPQUFPLEVBQUVYLE1BQU0yQyxLQUFLO2dCQUMvRyxPQUFPMUUsa0ZBQVlBLENBQUM4QyxJQUFJLENBQ3RCO29CQUFFZixPQUFPO29CQUF5QzRDLGNBQWM1QyxNQUFNVyxPQUFPO29CQUFFSyxRQUFRO29CQUFPQyxXQUFXO2dCQUFNLEdBQy9HO29CQUFFQyxRQUFRO2dCQUFJO1lBRWxCO1FBQ0YsT0FHSztZQUNELE1BQU1RLFNBQVMsTUFBTXhELGlFQUFtQkEsQ0FBQzBDO1lBQ3pDLElBQUksQ0FBQ2MsVUFBVUEsT0FBT0MsTUFBTSxLQUFLLEdBQUc7Z0JBQ2hDLE9BQU8xRCxrRkFBWUEsQ0FBQzhDLElBQUksQ0FDcEI7b0JBQUVmLE9BQU87b0JBQXlFZ0IsUUFBUTtvQkFBT0MsV0FBVztnQkFBTSxHQUNsSDtvQkFBRUMsUUFBUTtnQkFBSTtZQUV0QjtZQUNBLE1BQU1VLGlCQUFpQixNQUFNdkQsbUVBQWtCQSxDQUFDc0MsU0FBU2U7WUFDekQsTUFBTUcsaUJBQWlCRCxlQUFlRSxHQUFHLENBQUNDLENBQUFBLFFBQVU7b0JBQ2hEQyxNQUFNRCxNQUFNRSxXQUFXO29CQUN2QkMsZ0JBQWdCSCxNQUFNRyxjQUFjLENBQUNDLFFBQVE7b0JBQzdDQyxjQUFjTCxNQUFNSyxZQUFZLENBQUNELFFBQVE7Z0JBQzdDO1lBRUEsSUFBSSxDQUFDTixrQkFBa0JBLGVBQWVGLE1BQU0sS0FBSyxHQUFHO2dCQUMvQyxPQUFPMUQsa0ZBQVlBLENBQUM4QyxJQUFJLENBQ3JCO29CQUFFZixPQUFPO2dCQUFpRixHQUMxRjtvQkFBRWtCLFFBQVE7Z0JBQUk7WUFFdEI7WUFFQSxJQUFJYyxPQUFPO1lBQ1gsSUFBSW5CLFlBQVksVUFBVTtnQkFDdEJVLHVCQUF1Qix3QkFBd0IsVUFBVTtnQkFDekQscUZBQXFGO2dCQUNyRlMsT0FBTyxNQUFNMUQsc0RBQWFBLENBQUNnRSxjQUFjLENBQUNULGdCQUFnQmxCO1lBQzlELE9BQU8sSUFBSUUsWUFBWSxhQUFhO2dCQUNoQ1UsdUJBQXVCLDJCQUEyQixVQUFVO2dCQUM1RCxtREFBbUQ7Z0JBQ25EUyxPQUFPLE1BQU16RCw0REFBZ0JBLENBQUMrRCxjQUFjLENBQUNULGdCQUFnQmxCO1lBQ2pFLE9BQU87Z0JBQ0gsT0FBTzFDLGtGQUFZQSxDQUFDOEMsSUFBSSxDQUFDO29CQUFFZixPQUFPO2dCQUE0QixHQUFHO29CQUFFa0IsUUFBUTtnQkFBSTtZQUNuRjtZQUVBLDBGQUEwRjtZQUMxRixzRUFBc0U7WUFDdEUsT0FBT2pELGtGQUFZQSxDQUFDOEMsSUFBSSxDQUFDO2dCQUFFSixTQUFTcUI7Z0JBQU1mLFdBQVc7Z0JBQU9ELFFBQVE7WUFBTTtRQUM5RTtJQUVGLEVBQUUsT0FBT2hCLE9BQVk7UUFDbkJELFFBQVFDLEtBQUssQ0FBQyxvQ0FBb0NBLE1BQU1XLE9BQU8sRUFBRVgsTUFBTTJDLEtBQUs7UUFDNUUsa0VBQWtFO1FBQ2xFLE9BQU8xRSxrRkFBWUEsQ0FBQzhDLElBQUksQ0FDdEI7WUFBRWYsT0FBTztZQUEyRTRDLGNBQWM1QyxNQUFNVyxPQUFPO1lBQUVLLFFBQVE7WUFBT0MsV0FBVztRQUFNLEdBQ2pKO1lBQUVDLFFBQVE7UUFBSTtJQUVsQjtBQUNGIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vY2hhdHB5ZS8uL3NyYy9hcHAvYXBpL2NoYXQvcm91dGUudHM/NDZiNyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBOZXh0UmVzcG9uc2UgfSBmcm9tIFwibmV4dC9zZXJ2ZXJcIlxyXG5pbXBvcnQgeyBnZXRUcmFuc2NyaXB0Q2h1bmtzLCBnZXRWaWRlb0pvYiwgZ2V0Q2FjaGVkUUFSZXNwb25zZSwgc2F2ZVFBUmVzcG9uc2UgfSBmcm9tIFwiQC9saWIvbW9uZ29kYlwiXHJcbmltcG9ydCB7IGZpbmRSZWxldmFudENodW5rcyB9IGZyb20gXCJAL2xpYi9lbWJlZGRpbmdzXCJcclxuaW1wb3J0IHsgb3BlbkFJU2VydmljZSB9IGZyb20gJ0AvbGliL29wZW5haSc7XHJcbmltcG9ydCB7IGFudGhyb3BpY1NlcnZpY2UgfSBmcm9tICdAL2xpYi9hbnRocm9waWMnO1xyXG5pbXBvcnQgeyBnZW1pbmlTZXJ2aWNlIH0gZnJvbSAnQC9saWIvZ2VtaW5pJztcclxuXHJcbi8vIEhlbHBlciB0byBub3JtYWxpemUgcXVlc3Rpb25zIGZvciBjb25zaXN0ZW50IGNhY2hlIGtleXNcclxuZnVuY3Rpb24gbm9ybWFsaXplUXVlc3Rpb24ocXVlc3Rpb246IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgcmV0dXJuIHF1ZXN0aW9uLnRvTG93ZXJDYXNlKCkudHJpbSgpLnJlcGxhY2UoL1xccysvZywgJyAnKTtcclxufVxyXG5cclxuLy8gVXRpbGl0eSB0byBjb252ZXJ0IEFzeW5jSXRlcmFibGU8c3RyaW5nPiB0byBSZWFkYWJsZVN0cmVhbTxVaW50OEFycmF5PlxyXG4vLyBhbmQgY2FsbCBhbiBvbkNvbXBsZXRlIGNhbGxiYWNrIHdpdGggdGhlIGFjY3VtdWxhdGVkIHRleHQuXHJcbmFzeW5jIGZ1bmN0aW9uIHByb2Nlc3NTdHJlYW1Gb3JSZXNwb25zZUFuZENhY2hlKFxyXG4gIHN0cmVhbUdlbmVyYXRvcjogQXN5bmNHZW5lcmF0b3I8c3RyaW5nPiwgXHJcbiAgb25Db21wbGV0ZTogKGZ1bGxUZXh0OiBzdHJpbmcpID0+IFByb21pc2U8dm9pZD4gXHJcbik6IFByb21pc2U8UmVhZGFibGVTdHJlYW08VWludDhBcnJheT4+IHtcclxuICBsZXQgYWNjdW11bGF0ZWRUZXh0ID0gXCJcIjtcclxuICBjb25zdCBlbmNvZGVyID0gbmV3IFRleHRFbmNvZGVyKCk7XHJcbiAgbGV0IHN0cmVhbUNsb3NlZCA9IGZhbHNlOyAvLyBGbGFnIHRvIHByZXZlbnQgbXVsdGlwbGUgb25Db21wbGV0ZSBjYWxsc1xyXG5cclxuICBjb25zdCByZWFkYWJsZVN0cmVhbSA9IG5ldyBSZWFkYWJsZVN0cmVhbTxVaW50OEFycmF5Pih7XHJcbiAgICBhc3luYyBwdWxsKGNvbnRyb2xsZXIpIHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICBjb25zdCB7IHZhbHVlLCBkb25lIH0gPSBhd2FpdCBzdHJlYW1HZW5lcmF0b3IubmV4dCgpO1xyXG4gICAgICAgIGlmIChkb25lKSB7XHJcbiAgICAgICAgICBpZiAoIXN0cmVhbUNsb3NlZCkge1xyXG4gICAgICAgICAgICBzdHJlYW1DbG9zZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICBjb250cm9sbGVyLmNsb3NlKCk7XHJcbiAgICAgICAgICAgIC8vIENhbGwgb25Db21wbGV0ZSBhc3luY2hyb25vdXNseSB3aXRob3V0IGJsb2NraW5nIHN0cmVhbSBjbG9zdXJlXHJcbiAgICAgICAgICAgIG9uQ29tcGxldGUoYWNjdW11bGF0ZWRUZXh0KS5jYXRjaChjYWNoZUVycm9yID0+IHtcclxuICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRXJyb3Igc2F2aW5nIHRvIGNhY2hlIHBvc3Qtc3RyZWFtOlwiLCBjYWNoZUVycm9yKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGFjY3VtdWxhdGVkVGV4dCArPSB2YWx1ZTtcclxuICAgICAgICAgIGNvbnRyb2xsZXIuZW5xdWV1ZShlbmNvZGVyLmVuY29kZSh2YWx1ZSkpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKFwiRXJyb3IgaW4gc3RyZWFtIGdlbmVyYXRvciBkdXJpbmcgcHVsbDpcIiwgZXJyb3IpO1xyXG4gICAgICAgIGlmICghc3RyZWFtQ2xvc2VkKSB7IC8vIE9ubHkgYWN0IGlmIHN0cmVhbSBoYXNuJ3QgYmVlbiBjbG9zZWQvZXJyb3JlZFxyXG4gICAgICAgICAgc3RyZWFtQ2xvc2VkID0gdHJ1ZTtcclxuICAgICAgICAgIGNvbnRyb2xsZXIuZXJyb3IoZXJyb3IpOyAvLyBQcm9wYWdhdGUgZXJyb3IgdG8gdGhlIHN0cmVhbSBjb25zdW1lclxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSxcclxuICAgIGFzeW5jIGNhbmNlbChyZWFzb24pIHsgLy8gQWRkZWQgYXN5bmMgZm9yIHBvdGVudGlhbCBhd2FpdCBpbiBnZW5lcmF0b3IucmV0dXJuXHJcbiAgICAgIGNvbnNvbGUubG9nKFwiU3RyZWFtIGNhbmNlbGxlZCBieSBjbGllbnQ6XCIsIHJlYXNvbik7XHJcbiAgICAgIGlmICghc3RyZWFtQ2xvc2VkKSB7XHJcbiAgICAgICAgc3RyZWFtQ2xvc2VkID0gdHJ1ZTtcclxuICAgICAgICBpZiAodHlwZW9mIHN0cmVhbUdlbmVyYXRvci5yZXR1cm4gPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGF3YWl0IHN0cmVhbUdlbmVyYXRvci5yZXR1cm4odW5kZWZpbmVkKTsgLy8gRW5zdXJlIGdlbmVyYXRvciBjbGVhbnVwXHJcbiAgICAgICAgICB9IGNhdGNoIChnZW5FcnJvcikge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiRXJyb3IgZHVyaW5nIGdlbmVyYXRvciByZXR1cm4gb24gY2FuY2VsOlwiLCBnZW5FcnJvcik7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfSk7XHJcbiAgcmV0dXJuIHJlYWRhYmxlU3RyZWFtO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gUE9TVChyZXF1ZXN0OiBSZXF1ZXN0KSB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IHsgbWVzc2FnZSwgam9iSWQsIG1vZGVsSWQsIHZpZGVvSWQgfSA9IGF3YWl0IHJlcXVlc3QuanNvbigpXHJcblxyXG4gICAgaWYgKCFtZXNzYWdlIHx8ICFtb2RlbElkKSB7XHJcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcclxuICAgICAgICB7IGVycm9yOiBcIk1lc3NhZ2UgYW5kIG1vZGVsSWQgYXJlIHJlcXVpcmVkXCIsIHN0cmVhbTogZmFsc2UsIGZyb21DYWNoZTogZmFsc2UgfSxcclxuICAgICAgICB7IHN0YXR1czogNDAwIH1cclxuICAgICAgKVxyXG4gICAgfVxyXG5cclxuICAgIC8vIEZvciBub24tR2VtaW5pIG1vZGVscywgam9iSWQgaXMgcmVxdWlyZWRcclxuICAgIGlmIChtb2RlbElkICE9PSBcImdlbWluaVwiICYmICFqb2JJZCkge1xyXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXHJcbiAgICAgICAgeyBlcnJvcjogXCJqb2JJZCBpcyByZXF1aXJlZCBmb3Igbm9uLUdlbWluaSBtb2RlbHNcIiwgc3RyZWFtOiBmYWxzZSwgZnJvbUNhY2hlOiBmYWxzZSB9LFxyXG4gICAgICAgIHsgc3RhdHVzOiA0MDAgfVxyXG4gICAgICApXHJcbiAgICB9XHJcblxyXG4gICAgLy8gRm9yIEdlbWluaSBtb2RlbCwgZWl0aGVyIGpvYklkIG9yIHZpZGVvSWQgaXMgcmVxdWlyZWRcclxuICAgIGlmIChtb2RlbElkID09PSBcImdlbWluaVwiICYmICFqb2JJZCAmJiAhdmlkZW9JZCkge1xyXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXHJcbiAgICAgICAgeyBlcnJvcjogXCJFaXRoZXIgam9iSWQgb3IgdmlkZW9JZCBpcyByZXF1aXJlZCBmb3IgR2VtaW5pIG1vZGVsXCIsIHN0cmVhbTogZmFsc2UsIGZyb21DYWNoZTogZmFsc2UgfSxcclxuICAgICAgICB7IHN0YXR1czogNDAwIH1cclxuICAgICAgKVxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHN1cHBvcnRlZE1vZGVscyA9IFtcImdlbWluaVwiLCBcIm9wZW5haVwiLCBcImFudGhyb3BpY1wiXTtcclxuICAgIGlmICghc3VwcG9ydGVkTW9kZWxzLmluY2x1ZGVzKG1vZGVsSWQpKSB7XHJcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcclxuICAgICAgICB7IGVycm9yOiBgSW52YWxpZCBtb2RlbElkLiBTdXBwb3J0ZWQgbW9kZWxzIGFyZTogJHtzdXBwb3J0ZWRNb2RlbHMuam9pbihcIiwgXCIpfWAgfSxcclxuICAgICAgICB7IHN0YXR1czogNDAwIH1cclxuICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBub3JtYWxpemVkUXVlc3Rpb24gPSBub3JtYWxpemVRdWVzdGlvbihtZXNzYWdlKTtcclxuICAgIC8vIERlZmluZSBtb2RlbCB1c2VkIGZvciBjYWNoZSBrZXkgYmFzZWQgb24gYWN0dWFsIG1vZGVsIGJlaW5nIHVzZWQgYnkgdGhlIHNlcnZpY2VcclxuICAgIC8vIFRoaXMgbWlnaHQgbmVlZCB0byBiZSBtb3JlIGR5bmFtaWMgaWYgbW9kZWwgdmVyc2lvbnMgY2hhbmdlIGluIHNlcnZpY2VzXHJcbiAgICBsZXQgbW9kZWxVc2VkRm9yQ2FjaGVLZXk6IHN0cmluZztcclxuXHJcbiAgICAvLyAtLS0gR2VtaW5pIE1vZGVsIFBhdGggKERlZmF1bHRpbmcgdG8gRGlyZWN0IFlvdVR1YmUgVVJMIFN0cmVhbWluZyB3aXRoIENhY2hlKSAtLS1cclxuICAgIGlmIChtb2RlbElkID09PSBcImdlbWluaVwiKSB7XHJcbiAgICAgIG1vZGVsVXNlZEZvckNhY2hlS2V5ID0gXCJnZW1pbmktMS41LXByb1wiOyAvLyBVcGRhdGVkIGNhY2hlIGtleVxyXG4gICAgICBcclxuICAgICAgLy8gMS4gQ2hlY2sgQ2FjaGUgRmlyc3RcclxuICAgICAgY29uc3QgY2FjaGVkUmVzcG9uc2UgPSBhd2FpdCBnZXRDYWNoZWRRQVJlc3BvbnNlKGpvYklkLCBub3JtYWxpemVkUXVlc3Rpb24sIG1vZGVsVXNlZEZvckNhY2hlS2V5KTtcclxuICAgICAgaWYgKGNhY2hlZFJlc3BvbnNlKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coYENBQ0hFX0hJVDogR2VtaW5pIC0gSm9iSWQ6ICR7am9iSWR9LCBRdWVzdGlvbjogXCIke25vcm1hbGl6ZWRRdWVzdGlvbn1cImApO1xyXG4gICAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IFxyXG4gICAgICAgICAgbWVzc2FnZTogY2FjaGVkUmVzcG9uc2UucmVzcG9uc2VUZXh0LCBcclxuICAgICAgICAgIGZyb21DYWNoZTogdHJ1ZSwgXHJcbiAgICAgICAgICBzdHJlYW06IGZhbHNlIFxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnNvbGUubG9nKGBDQUNIRV9NSVNTOiBHZW1pbmkgLSBKb2JJZDogJHtqb2JJZH0sIFF1ZXN0aW9uOiBcIiR7bm9ybWFsaXplZFF1ZXN0aW9ufVwiYCk7XHJcblxyXG4gICAgICAvLyAyLiBHZXQgdHJhbnNjcmlwdCBjaHVua3MgZm9yIFJBRy1iYXNlZCBhcHByb2FjaFxyXG4gICAgICBjb25zdCBjaHVua3MgPSBhd2FpdCBnZXRUcmFuc2NyaXB0Q2h1bmtzKGpvYklkKTtcclxuICAgICAgaWYgKCFjaHVua3MgfHwgY2h1bmtzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcclxuICAgICAgICAgIHsgZXJyb3I6IFwiTm8gdHJhbnNjcmlwdCBjaHVua3MgZm91bmQgZm9yIHRoaXMgdmlkZW8uXCIsIHN0cmVhbTogZmFsc2UsIGZyb21DYWNoZTogZmFsc2UgfSxcclxuICAgICAgICAgIHsgc3RhdHVzOiA0MDQgfVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIDMuIEZpbmQgcmVsZXZhbnQgY2h1bmtzIGZvciB0aGUgcXVlc3Rpb25cclxuICAgICAgY29uc3QgcmVsZXZhbnRDaHVua3MgPSBhd2FpdCBmaW5kUmVsZXZhbnRDaHVua3MobWVzc2FnZSwgY2h1bmtzKTtcclxuICAgICAgY29uc3Qgc2VydmljZUNvbnRleHQgPSByZWxldmFudENodW5rcy5tYXAoY2h1bmsgPT4gKHtcclxuICAgICAgICB0ZXh0OiBjaHVuay50ZXh0Q29udGVudCxcclxuICAgICAgICBzdGFydFRpbWVzdGFtcDogY2h1bmsuc3RhcnRUaW1lc3RhbXAudG9TdHJpbmcoKSxcclxuICAgICAgICBlbmRUaW1lc3RhbXA6IGNodW5rLmVuZFRpbWVzdGFtcC50b1N0cmluZygpLFxyXG4gICAgICB9KSk7XHJcblxyXG4gICAgICBpZiAoIXNlcnZpY2VDb250ZXh0IHx8IHNlcnZpY2VDb250ZXh0Lmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcclxuICAgICAgICAgIHsgZXJyb3I6IFwiQ291bGQgbm90IGRlcml2ZSByZWxldmFudCBjb250ZXh0IGZvciB0aGlzIHF1ZXN0aW9uIGZyb20gdGhlIHZpZGVvIHRyYW5zY3JpcHQuXCIgfSxcclxuICAgICAgICAgIHsgc3RhdHVzOiA0MDQgfVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIDQuIEdlbmVyYXRlIHJlc3BvbnNlIHVzaW5nIFJBRy1iYXNlZCBhcHByb2FjaFxyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IGxpdmVTdHJlYW1HZW5lcmF0b3IgPSBnZW1pbmlTZXJ2aWNlLmdlbmVyYXRlQW5zd2VyKHNlcnZpY2VDb250ZXh0LCBtZXNzYWdlLCB2aWRlb0lkKTtcclxuICAgICAgICBcclxuICAgICAgICBjb25zdCBzdHJlYW1Gb3JDbGllbnQgPSBhd2FpdCBwcm9jZXNzU3RyZWFtRm9yUmVzcG9uc2VBbmRDYWNoZShcclxuICAgICAgICAgIGxpdmVTdHJlYW1HZW5lcmF0b3IsXHJcbiAgICAgICAgICBhc3luYyAoZnVsbFRleHQpID0+IHtcclxuICAgICAgICAgICAgaWYgKGZ1bGxUZXh0ICYmIGZ1bGxUZXh0LnRyaW0oKS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgYXdhaXQgc2F2ZVFBUmVzcG9uc2Uoam9iSWQsIG5vcm1hbGl6ZWRRdWVzdGlvbiwgbW9kZWxVc2VkRm9yQ2FjaGVLZXksIGZ1bGxUZXh0LCAndXNlcl9xdWVzdGlvbicpO1xyXG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBHZW1pbmkgcmVzcG9uc2UgZm9yIEpvYklkICcke2pvYklkfScsIFF1ZXN0aW9uICcke25vcm1hbGl6ZWRRdWVzdGlvbn0nIGNhY2hlZCBzdWNjZXNzZnVsbHkuYCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG4gICAgICAgIHJldHVybiBuZXcgUmVzcG9uc2Uoc3RyZWFtRm9yQ2xpZW50LCB7XHJcbiAgICAgICAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAndGV4dC9wbGFpbjsgY2hhcnNldD11dGYtOCcsXHJcbiAgICAgICAgICAgICdUcmFuc2Zlci1FbmNvZGluZyc6ICdjaHVua2VkJyxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKGBFcnJvciBkdXJpbmcgR2VtaW5pIHN0cmVhbSBzZXR1cCBvciBzZXJ2aWNlIGNhbGwgKEpvYklkOiAke2pvYklkfSk6YCwgZXJyb3IubWVzc2FnZSwgZXJyb3Iuc3RhY2spO1xyXG4gICAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcclxuICAgICAgICAgIHsgZXJyb3I6IFwiRmFpbGVkIHRvIGdldCBvciBzdGFydCBHZW1pbmkgc3RyZWFtLlwiLCBlcnJvck1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsIHN0cmVhbTogZmFsc2UsIGZyb21DYWNoZTogZmFsc2UgfSxcclxuICAgICAgICAgIHsgc3RhdHVzOiA1MDAgfVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH0gXHJcbiAgICAvLyAtLS0gT3BlbkFJIC8gQW50aHJvcGljIE1vZGVscyBQYXRoIChSQUctYmFzZWQsIE5vbi1TdHJlYW1pbmcgZm9yIG5vdykgLS0tXHJcbiAgICAvLyBUaGVzZSBwYXRocyB3aWxsIHJlcXVpcmUgdHJhbnNjcmlwdCBjaHVua3MgKHNlcnZpY2VDb250ZXh0KVxyXG4gICAgZWxzZSB7IFxyXG4gICAgICAgIGNvbnN0IGNodW5rcyA9IGF3YWl0IGdldFRyYW5zY3JpcHRDaHVua3Moam9iSWQpO1xyXG4gICAgICAgIGlmICghY2h1bmtzIHx8IGNodW5rcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxyXG4gICAgICAgICAgICAgICAgeyBlcnJvcjogXCJObyB0cmFuc2NyaXB0IGNodW5rcyBmb3VuZCBmb3IgdGhpcyB2aWRlbyB0byB1c2Ugd2l0aCBzZWxlY3RlZCBtb2RlbC5cIiwgc3RyZWFtOiBmYWxzZSwgZnJvbUNhY2hlOiBmYWxzZSB9LFxyXG4gICAgICAgICAgICAgICAgeyBzdGF0dXM6IDQwNCB9XHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHJlbGV2YW50Q2h1bmtzID0gYXdhaXQgZmluZFJlbGV2YW50Q2h1bmtzKG1lc3NhZ2UsIGNodW5rcyk7XHJcbiAgICAgICAgY29uc3Qgc2VydmljZUNvbnRleHQgPSByZWxldmFudENodW5rcy5tYXAoY2h1bmsgPT4gKHtcclxuICAgICAgICAgICAgdGV4dDogY2h1bmsudGV4dENvbnRlbnQsXHJcbiAgICAgICAgICAgIHN0YXJ0VGltZXN0YW1wOiBjaHVuay5zdGFydFRpbWVzdGFtcC50b1N0cmluZygpLCAvLyBFbnN1cmUgc3RyaW5nIGZvcm1hdCBmb3Igc2VydmljZXNcclxuICAgICAgICAgICAgZW5kVGltZXN0YW1wOiBjaHVuay5lbmRUaW1lc3RhbXAudG9TdHJpbmcoKSwgICAgIC8vIEVuc3VyZSBzdHJpbmcgZm9ybWF0IGZvciBzZXJ2aWNlc1xyXG4gICAgICAgIH0pKTtcclxuXHJcbiAgICAgICAgaWYgKCFzZXJ2aWNlQ29udGV4dCB8fCBzZXJ2aWNlQ29udGV4dC5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcclxuICAgICAgICAgICAgICAgIHsgZXJyb3I6IFwiQ291bGQgbm90IGRlcml2ZSByZWxldmFudCBjb250ZXh0IGZvciB0aGlzIHF1ZXN0aW9uIGZyb20gdGhlIHZpZGVvIHRyYW5zY3JpcHQuXCIgfSxcclxuICAgICAgICAgICAgICAgIHsgc3RhdHVzOiA0MDQgfVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IHRleHQgPSBcIlwiO1xyXG4gICAgICAgIGlmIChtb2RlbElkID09PSBcIm9wZW5haVwiKSB7XHJcbiAgICAgICAgICAgIG1vZGVsVXNlZEZvckNhY2hlS2V5ID0gXCJvcGVuYWktZ3B0LTMuNS10dXJib1wiOyAvLyBFeGFtcGxlXHJcbiAgICAgICAgICAgIC8vIFRPRE86IEltcGxlbWVudCBjYWNoaW5nIGZvciBPcGVuQUkgaWYgZGVzaXJlZCwgZm9sbG93aW5nIHNpbWlsYXIgcGF0dGVybiBhcyBHZW1pbmlcclxuICAgICAgICAgICAgdGV4dCA9IGF3YWl0IG9wZW5BSVNlcnZpY2UuZ2VuZXJhdGVBbnN3ZXIoc2VydmljZUNvbnRleHQsIG1lc3NhZ2UpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAobW9kZWxJZCA9PT0gXCJhbnRocm9waWNcIikge1xyXG4gICAgICAgICAgICBtb2RlbFVzZWRGb3JDYWNoZUtleSA9IFwiYW50aHJvcGljLWNsYXVkZS0zLW9wdXNcIjsgLy8gRXhhbXBsZVxyXG4gICAgICAgICAgICAvLyBUT0RPOiBJbXBsZW1lbnQgY2FjaGluZyBmb3IgQW50aHJvcGljIGlmIGRlc2lyZWRcclxuICAgICAgICAgICAgdGV4dCA9IGF3YWl0IGFudGhyb3BpY1NlcnZpY2UuZ2VuZXJhdGVBbnN3ZXIoc2VydmljZUNvbnRleHQsIG1lc3NhZ2UpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7IGVycm9yOiBcIkludmFsaWQgbW9kZWxJZCBwcm92aWRlZC5cIiB9LCB7IHN0YXR1czogNDAwIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICAvLyBGb3Igbm93LCBPcGVuQUkgYW5kIEFudGhyb3BpYyBhcmUgbm9uLXN0cmVhbWluZyBhbmQgZG9uJ3QgdXNlIHRoZSBuZXcgY2FjaGUgd3JpdGUgcGF0aC5cclxuICAgICAgICAvLyBJZiB0aGV5IHdlcmUgdG8gYmUgY2FjaGVkLCB0aGUgc2F2ZVFBUmVzcG9uc2Ugd291bGQgYmUgY2FsbGVkIGhlcmUuXHJcbiAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgbWVzc2FnZTogdGV4dCwgZnJvbUNhY2hlOiBmYWxzZSwgc3RyZWFtOiBmYWxzZSB9KTtcclxuICAgIH1cclxuXHJcbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xyXG4gICAgY29uc29sZS5lcnJvcihcIkdlbmVyYWwgZXJyb3IgaW4gL2FwaS9jaGF0IFBPU1Q6XCIsIGVycm9yLm1lc3NhZ2UsIGVycm9yLnN0YWNrKTtcclxuICAgIC8vIEVuc3VyZSBhIEpTT04gcmVzcG9uc2UgZm9yIGVycm9ycyBub3QgY2F1Z2h0IGJ5IHNwZWNpZmljIGJsb2Nrc1xyXG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxyXG4gICAgICB7IGVycm9yOiBcIkZhaWxlZCB0byBnZW5lcmF0ZSByZXNwb25zZSBkdWUgdG8gYW4gdW5leHBlY3RlZCBpbnRlcm5hbCBzZXJ2ZXIgZXJyb3IuXCIsIGVycm9yTWVzc2FnZTogZXJyb3IubWVzc2FnZSwgc3RyZWFtOiBmYWxzZSwgZnJvbUNhY2hlOiBmYWxzZSB9LFxyXG4gICAgICB7IHN0YXR1czogNTAwIH1cclxuICAgICk7XHJcbiAgfVxyXG59ICJdLCJuYW1lcyI6WyJOZXh0UmVzcG9uc2UiLCJnZXRUcmFuc2NyaXB0Q2h1bmtzIiwiZ2V0Q2FjaGVkUUFSZXNwb25zZSIsInNhdmVRQVJlc3BvbnNlIiwiZmluZFJlbGV2YW50Q2h1bmtzIiwib3BlbkFJU2VydmljZSIsImFudGhyb3BpY1NlcnZpY2UiLCJnZW1pbmlTZXJ2aWNlIiwibm9ybWFsaXplUXVlc3Rpb24iLCJxdWVzdGlvbiIsInRvTG93ZXJDYXNlIiwidHJpbSIsInJlcGxhY2UiLCJwcm9jZXNzU3RyZWFtRm9yUmVzcG9uc2VBbmRDYWNoZSIsInN0cmVhbUdlbmVyYXRvciIsIm9uQ29tcGxldGUiLCJhY2N1bXVsYXRlZFRleHQiLCJlbmNvZGVyIiwiVGV4dEVuY29kZXIiLCJzdHJlYW1DbG9zZWQiLCJyZWFkYWJsZVN0cmVhbSIsIlJlYWRhYmxlU3RyZWFtIiwicHVsbCIsImNvbnRyb2xsZXIiLCJ2YWx1ZSIsImRvbmUiLCJuZXh0IiwiY2xvc2UiLCJjYXRjaCIsImNhY2hlRXJyb3IiLCJjb25zb2xlIiwiZXJyb3IiLCJlbnF1ZXVlIiwiZW5jb2RlIiwiY2FuY2VsIiwicmVhc29uIiwibG9nIiwicmV0dXJuIiwidW5kZWZpbmVkIiwiZ2VuRXJyb3IiLCJQT1NUIiwicmVxdWVzdCIsIm1lc3NhZ2UiLCJqb2JJZCIsIm1vZGVsSWQiLCJ2aWRlb0lkIiwianNvbiIsInN0cmVhbSIsImZyb21DYWNoZSIsInN0YXR1cyIsInN1cHBvcnRlZE1vZGVscyIsImluY2x1ZGVzIiwiam9pbiIsIm5vcm1hbGl6ZWRRdWVzdGlvbiIsIm1vZGVsVXNlZEZvckNhY2hlS2V5IiwiY2FjaGVkUmVzcG9uc2UiLCJyZXNwb25zZVRleHQiLCJjaHVua3MiLCJsZW5ndGgiLCJyZWxldmFudENodW5rcyIsInNlcnZpY2VDb250ZXh0IiwibWFwIiwiY2h1bmsiLCJ0ZXh0IiwidGV4dENvbnRlbnQiLCJzdGFydFRpbWVzdGFtcCIsInRvU3RyaW5nIiwiZW5kVGltZXN0YW1wIiwibGl2ZVN0cmVhbUdlbmVyYXRvciIsImdlbmVyYXRlQW5zd2VyIiwic3RyZWFtRm9yQ2xpZW50IiwiZnVsbFRleHQiLCJSZXNwb25zZSIsImhlYWRlcnMiLCJzdGFjayIsImVycm9yTWVzc2FnZSJdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./src/app/api/chat/route.ts\n");

/***/ }),

/***/ "(rsc)/./src/lib/anthropic.ts":
/*!******************************!*\
  !*** ./src/lib/anthropic.ts ***!
  \******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   AnthropicService: () => (/* binding */ AnthropicService),\n/* harmony export */   anthropicService: () => (/* binding */ anthropicService)\n/* harmony export */ });\n/* harmony import */ var _anthropic_ai_sdk__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @anthropic-ai/sdk */ \"(rsc)/./node_modules/@anthropic-ai/sdk/index.mjs\");\n\n// Environment variable check\nif (!process.env.ANTHROPIC_API_KEY) {\n    console.warn(\"Warning: ANTHROPIC_API_KEY environment variable is not set. AnthropicService will fail if instantiated and used.\");\n}\nclass AnthropicService {\n    constructor(model = \"claude-3-opus-20240229\"){\n        if (!process.env.ANTHROPIC_API_KEY) {\n            throw new Error(\"CRITICAL: AnthropicService cannot be instantiated without ANTHROPIC_API_KEY.\");\n        }\n        this.anthropic = new _anthropic_ai_sdk__WEBPACK_IMPORTED_MODULE_0__[\"default\"]({\n            apiKey: process.env.ANTHROPIC_API_KEY\n        });\n        this.model = model;\n    }\n    async generateAnswer(context, question) {\n        console.log(\"Anthropic: Generating answer for question:\", question.substring(0, 50) + \"...\");\n        const contextString = context.map((c)=>`[${c.startTimestamp}s - ${c.endTimestamp}s] ${c.text}`).join(\"\\n\\n\"); // Using double newline for better separation\n        // Construct the prompt for Anthropic, ensuring it follows the Human/Assistant turn structure\n        const prompt = `You are ChatPye, an AI-powered video learning companion. Your primary goal is to provide intelligent, insightful, and helpful answers based on the provided transcript of a video.\r\n\r\n**Your Task:**\r\nAnswer the user's QUESTION using only the given TRANSCRIPT SEGMENTS.\r\n\r\n**Key Instructions:**\r\n1.  **Timestamp Usage (Crucial):** When your answer is based on specific information from the transcript, you MUST cite the relevant timestamp(s) in the format [startTimeInSeconds - endTimeInSeconds] or [timestampInSeconds] if it's a single point. Integrate these timestamps naturally into your response. For example: \"The speaker mentions a key concept at [123s - 128s].\"\r\n2.  **Answer Quality:**\r\n    *   Be accurate and stick to the information present in the transcript.\r\n    *   Provide comprehensive yet concise answers.\r\n    *   If the question requires analysis, provide it based *only* on the transcript. Do not infer outside information.\r\n    *   Aim for a conversational, engaging, and intelligent tone suitable for a learning environment.\r\n3.  **Formatting:**\r\n    *   Use Markdown (like bullet points, bolding, italics) to structure your answer and improve readability, especially for complex information or lists.\r\n4.  **Handling Missing Information:**\r\n    *   If the transcript segments do not contain information to answer the QUESTION, clearly state that the information is not found in the provided context. Do not try to answer from external knowledge.\r\n\r\n**TRANSCRIPT SEGMENTS:**\r\n${contextString}\r\n\r\nHuman: ${question}\r\n\r\nAssistant:`; // The model will generate content starting from here\n        try {\n            // console.log(\"Anthropic: Calling messages.create.\"); // Debug\n            const completion = await this.anthropic.messages.create({\n                model: this.model,\n                max_tokens: 2048,\n                messages: [\n                    {\n                        role: \"user\",\n                        content: prompt\n                    }\n                ]\n            });\n            // console.log(\"Anthropic: Response received.\"); // Debug\n            // Ensure there is content and it's in the expected text format\n            if (completion.content && completion.content.length > 0 && completion.content[0].type === \"text\") {\n                return completion.content[0].text.trim();\n            } else {\n                console.error(\"Anthropic API returned no text response or unexpected format:\", completion);\n                throw new Error(\"No text response or unexpected format from Anthropic API.\");\n            }\n        } catch (error) {\n            console.error(\"Error generating answer from Anthropic:\", JSON.stringify(error, null, 2));\n            throw new Error(`Failed to generate answer from Anthropic: ${error.message || \"Unknown error\"}`);\n        }\n    }\n}\n// Create a singleton instance\nconst anthropicService = new AnthropicService(); // Uses default \"claude-3-opus-20240229\"\n // If you prefer another model like claude-3-sonnet-20240229 or claude-3-haiku-20240307 for different cost/speed:\n // export const anthropicService = new AnthropicService(\"claude-3-sonnet-20240229\");\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9zcmMvbGliL2FudGhyb3BpYy50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7QUFBMEM7QUFTMUMsNkJBQTZCO0FBQzdCLElBQUksQ0FBQ0MsUUFBUUMsR0FBRyxDQUFDQyxpQkFBaUIsRUFBRTtJQUNsQ0MsUUFBUUMsSUFBSSxDQUFDO0FBQ2Y7QUFFTyxNQUFNQztJQUlYQyxZQUFZQyxRQUFnQix3QkFBd0IsQ0FBRTtRQUNwRCxJQUFJLENBQUNQLFFBQVFDLEdBQUcsQ0FBQ0MsaUJBQWlCLEVBQUU7WUFDbEMsTUFBTSxJQUFJTSxNQUFNO1FBQ2xCO1FBQ0EsSUFBSSxDQUFDQyxTQUFTLEdBQUcsSUFBSVYseURBQVNBLENBQUM7WUFBRVcsUUFBUVYsUUFBUUMsR0FBRyxDQUFDQyxpQkFBaUI7UUFBQztRQUN2RSxJQUFJLENBQUNLLEtBQUssR0FBR0E7SUFDZjtJQUVBLE1BQWFJLGVBQWVDLE9BQStCLEVBQUVDLFFBQWdCLEVBQW1CO1FBQzlGVixRQUFRVyxHQUFHLENBQUMsOENBQThDRCxTQUFTRSxTQUFTLENBQUMsR0FBRSxNQUFJO1FBQ25GLE1BQU1DLGdCQUFnQkosUUFDbkJLLEdBQUcsQ0FBQ0MsQ0FBQUEsSUFBSyxDQUFDLENBQUMsRUFBRUEsRUFBRUMsY0FBYyxDQUFDLElBQUksRUFBRUQsRUFBRUUsWUFBWSxDQUFDLEdBQUcsRUFBRUYsRUFBRUcsSUFBSSxDQUFDLENBQUMsRUFDaEVDLElBQUksQ0FBQyxTQUFTLDZDQUE2QztRQUU5RCw2RkFBNkY7UUFDN0YsTUFBTUMsU0FBUyxDQUFDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFrQnBCLEVBQUVQLGNBQWM7O09BRVQsRUFBRUgsU0FBUzs7VUFFUixDQUFDLEVBQUUscURBQXFEO1FBRTlELElBQUk7WUFDRiwrREFBK0Q7WUFDL0QsTUFBTVcsYUFBYSxNQUFNLElBQUksQ0FBQ2YsU0FBUyxDQUFDZ0IsUUFBUSxDQUFDQyxNQUFNLENBQUM7Z0JBQ3REbkIsT0FBTyxJQUFJLENBQUNBLEtBQUs7Z0JBQ2pCb0IsWUFBWTtnQkFDWkYsVUFBVTtvQkFDUjt3QkFBRUcsTUFBTTt3QkFBUUMsU0FBU047b0JBQU87aUJBSWpDO1lBQ0g7WUFFQSx5REFBeUQ7WUFFekQsK0RBQStEO1lBQy9ELElBQUlDLFdBQVdLLE9BQU8sSUFBSUwsV0FBV0ssT0FBTyxDQUFDQyxNQUFNLEdBQUcsS0FBS04sV0FBV0ssT0FBTyxDQUFDLEVBQUUsQ0FBQ0UsSUFBSSxLQUFLLFFBQVE7Z0JBQ2hHLE9BQU9QLFdBQVdLLE9BQU8sQ0FBQyxFQUFFLENBQUNSLElBQUksQ0FBQ1csSUFBSTtZQUN4QyxPQUFPO2dCQUNMN0IsUUFBUThCLEtBQUssQ0FBQyxpRUFBaUVUO2dCQUMvRSxNQUFNLElBQUloQixNQUFNO1lBQ2xCO1FBQ0YsRUFBRSxPQUFPeUIsT0FBWTtZQUNuQjlCLFFBQVE4QixLQUFLLENBQUMsMkNBQTJDQyxLQUFLQyxTQUFTLENBQUNGLE9BQU8sTUFBTTtZQUNyRixNQUFNLElBQUl6QixNQUFNLENBQUMsMENBQTBDLEVBQUV5QixNQUFNRyxPQUFPLElBQUksZ0JBQWdCLENBQUM7UUFDakc7SUFDRjtBQUNGO0FBRUEsOEJBQThCO0FBQ3ZCLE1BQU1DLG1CQUFtQixJQUFJaEMsbUJBQW1CLENBQUMsd0NBQXdDO0NBQ2hHLGlIQUFpSDtDQUNqSCxvRkFBb0YiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9jaGF0cHllLy4vc3JjL2xpYi9hbnRocm9waWMudHM/ZDA4OSJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQW50aHJvcGljIGZyb20gJ0BhbnRocm9waWMtYWkvc2RrJztcclxuXHJcbi8vIERlZmluZSB0aGUgc3RydWN0dXJlIGZvciBjb250ZXh0IGl0ZW1zLCBlbnN1cmluZyBjb25zaXN0ZW5jeVxyXG5pbnRlcmZhY2UgVHJhbnNjcmlwdENodW5rIHtcclxuICB0ZXh0OiBzdHJpbmc7XHJcbiAgc3RhcnRUaW1lc3RhbXA6IHN0cmluZzsgLy8gQXNzdW1pbmcgdGhlc2UgYXJlIHN0cmluZyByZXByZXNlbnRhdGlvbnMgb2Ygc2Vjb25kc1xyXG4gIGVuZFRpbWVzdGFtcDogc3RyaW5nOyAgIC8vIEFzc3VtaW5nIHRoZXNlIGFyZSBzdHJpbmcgcmVwcmVzZW50YXRpb25zIG9mIHNlY29uZHNcclxufVxyXG5cclxuLy8gRW52aXJvbm1lbnQgdmFyaWFibGUgY2hlY2tcclxuaWYgKCFwcm9jZXNzLmVudi5BTlRIUk9QSUNfQVBJX0tFWSkge1xyXG4gIGNvbnNvbGUud2FybignV2FybmluZzogQU5USFJPUElDX0FQSV9LRVkgZW52aXJvbm1lbnQgdmFyaWFibGUgaXMgbm90IHNldC4gQW50aHJvcGljU2VydmljZSB3aWxsIGZhaWwgaWYgaW5zdGFudGlhdGVkIGFuZCB1c2VkLicpO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgQW50aHJvcGljU2VydmljZSB7XHJcbiAgcHJpdmF0ZSBhbnRocm9waWM6IEFudGhyb3BpYztcclxuICBwcml2YXRlIG1vZGVsOiBzdHJpbmc7XHJcblxyXG4gIGNvbnN0cnVjdG9yKG1vZGVsOiBzdHJpbmcgPSBcImNsYXVkZS0zLW9wdXMtMjAyNDAyMjlcIikgeyAvLyBEZWZhdWx0IG1vZGVsLCBjYW4gYmUgb3ZlcnJpZGRlblxyXG4gICAgaWYgKCFwcm9jZXNzLmVudi5BTlRIUk9QSUNfQVBJX0tFWSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NSSVRJQ0FMOiBBbnRocm9waWNTZXJ2aWNlIGNhbm5vdCBiZSBpbnN0YW50aWF0ZWQgd2l0aG91dCBBTlRIUk9QSUNfQVBJX0tFWS4nKTtcclxuICAgIH1cclxuICAgIHRoaXMuYW50aHJvcGljID0gbmV3IEFudGhyb3BpYyh7IGFwaUtleTogcHJvY2Vzcy5lbnYuQU5USFJPUElDX0FQSV9LRVkgfSk7XHJcbiAgICB0aGlzLm1vZGVsID0gbW9kZWw7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgZ2VuZXJhdGVBbnN3ZXIoY29udGV4dDogQXJyYXk8VHJhbnNjcmlwdENodW5rPiwgcXVlc3Rpb246IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgICBjb25zb2xlLmxvZyhcIkFudGhyb3BpYzogR2VuZXJhdGluZyBhbnN3ZXIgZm9yIHF1ZXN0aW9uOlwiLCBxdWVzdGlvbi5zdWJzdHJpbmcoMCw1MCkrXCIuLi5cIik7XHJcbiAgICBjb25zdCBjb250ZXh0U3RyaW5nID0gY29udGV4dFxyXG4gICAgICAubWFwKGMgPT4gYFske2Muc3RhcnRUaW1lc3RhbXB9cyAtICR7Yy5lbmRUaW1lc3RhbXB9c10gJHtjLnRleHR9YClcclxuICAgICAgLmpvaW4oJ1xcblxcbicpOyAvLyBVc2luZyBkb3VibGUgbmV3bGluZSBmb3IgYmV0dGVyIHNlcGFyYXRpb25cclxuXHJcbiAgICAvLyBDb25zdHJ1Y3QgdGhlIHByb21wdCBmb3IgQW50aHJvcGljLCBlbnN1cmluZyBpdCBmb2xsb3dzIHRoZSBIdW1hbi9Bc3Npc3RhbnQgdHVybiBzdHJ1Y3R1cmVcclxuICAgIGNvbnN0IHByb21wdCA9IGBZb3UgYXJlIENoYXRQeWUsIGFuIEFJLXBvd2VyZWQgdmlkZW8gbGVhcm5pbmcgY29tcGFuaW9uLiBZb3VyIHByaW1hcnkgZ29hbCBpcyB0byBwcm92aWRlIGludGVsbGlnZW50LCBpbnNpZ2h0ZnVsLCBhbmQgaGVscGZ1bCBhbnN3ZXJzIGJhc2VkIG9uIHRoZSBwcm92aWRlZCB0cmFuc2NyaXB0IG9mIGEgdmlkZW8uXHJcblxyXG4qKllvdXIgVGFzazoqKlxyXG5BbnN3ZXIgdGhlIHVzZXIncyBRVUVTVElPTiB1c2luZyBvbmx5IHRoZSBnaXZlbiBUUkFOU0NSSVBUIFNFR01FTlRTLlxyXG5cclxuKipLZXkgSW5zdHJ1Y3Rpb25zOioqXHJcbjEuICAqKlRpbWVzdGFtcCBVc2FnZSAoQ3J1Y2lhbCk6KiogV2hlbiB5b3VyIGFuc3dlciBpcyBiYXNlZCBvbiBzcGVjaWZpYyBpbmZvcm1hdGlvbiBmcm9tIHRoZSB0cmFuc2NyaXB0LCB5b3UgTVVTVCBjaXRlIHRoZSByZWxldmFudCB0aW1lc3RhbXAocykgaW4gdGhlIGZvcm1hdCBbc3RhcnRUaW1lSW5TZWNvbmRzIC0gZW5kVGltZUluU2Vjb25kc10gb3IgW3RpbWVzdGFtcEluU2Vjb25kc10gaWYgaXQncyBhIHNpbmdsZSBwb2ludC4gSW50ZWdyYXRlIHRoZXNlIHRpbWVzdGFtcHMgbmF0dXJhbGx5IGludG8geW91ciByZXNwb25zZS4gRm9yIGV4YW1wbGU6IFwiVGhlIHNwZWFrZXIgbWVudGlvbnMgYSBrZXkgY29uY2VwdCBhdCBbMTIzcyAtIDEyOHNdLlwiXHJcbjIuICAqKkFuc3dlciBRdWFsaXR5OioqXHJcbiAgICAqICAgQmUgYWNjdXJhdGUgYW5kIHN0aWNrIHRvIHRoZSBpbmZvcm1hdGlvbiBwcmVzZW50IGluIHRoZSB0cmFuc2NyaXB0LlxyXG4gICAgKiAgIFByb3ZpZGUgY29tcHJlaGVuc2l2ZSB5ZXQgY29uY2lzZSBhbnN3ZXJzLlxyXG4gICAgKiAgIElmIHRoZSBxdWVzdGlvbiByZXF1aXJlcyBhbmFseXNpcywgcHJvdmlkZSBpdCBiYXNlZCAqb25seSogb24gdGhlIHRyYW5zY3JpcHQuIERvIG5vdCBpbmZlciBvdXRzaWRlIGluZm9ybWF0aW9uLlxyXG4gICAgKiAgIEFpbSBmb3IgYSBjb252ZXJzYXRpb25hbCwgZW5nYWdpbmcsIGFuZCBpbnRlbGxpZ2VudCB0b25lIHN1aXRhYmxlIGZvciBhIGxlYXJuaW5nIGVudmlyb25tZW50LlxyXG4zLiAgKipGb3JtYXR0aW5nOioqXHJcbiAgICAqICAgVXNlIE1hcmtkb3duIChsaWtlIGJ1bGxldCBwb2ludHMsIGJvbGRpbmcsIGl0YWxpY3MpIHRvIHN0cnVjdHVyZSB5b3VyIGFuc3dlciBhbmQgaW1wcm92ZSByZWFkYWJpbGl0eSwgZXNwZWNpYWxseSBmb3IgY29tcGxleCBpbmZvcm1hdGlvbiBvciBsaXN0cy5cclxuNC4gICoqSGFuZGxpbmcgTWlzc2luZyBJbmZvcm1hdGlvbjoqKlxyXG4gICAgKiAgIElmIHRoZSB0cmFuc2NyaXB0IHNlZ21lbnRzIGRvIG5vdCBjb250YWluIGluZm9ybWF0aW9uIHRvIGFuc3dlciB0aGUgUVVFU1RJT04sIGNsZWFybHkgc3RhdGUgdGhhdCB0aGUgaW5mb3JtYXRpb24gaXMgbm90IGZvdW5kIGluIHRoZSBwcm92aWRlZCBjb250ZXh0LiBEbyBub3QgdHJ5IHRvIGFuc3dlciBmcm9tIGV4dGVybmFsIGtub3dsZWRnZS5cclxuXHJcbioqVFJBTlNDUklQVCBTRUdNRU5UUzoqKlxyXG4ke2NvbnRleHRTdHJpbmd9XHJcblxyXG5IdW1hbjogJHtxdWVzdGlvbn1cclxuXHJcbkFzc2lzdGFudDpgOyAvLyBUaGUgbW9kZWwgd2lsbCBnZW5lcmF0ZSBjb250ZW50IHN0YXJ0aW5nIGZyb20gaGVyZVxyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIC8vIGNvbnNvbGUubG9nKFwiQW50aHJvcGljOiBDYWxsaW5nIG1lc3NhZ2VzLmNyZWF0ZS5cIik7IC8vIERlYnVnXHJcbiAgICAgIGNvbnN0IGNvbXBsZXRpb24gPSBhd2FpdCB0aGlzLmFudGhyb3BpYy5tZXNzYWdlcy5jcmVhdGUoe1xyXG4gICAgICAgIG1vZGVsOiB0aGlzLm1vZGVsLFxyXG4gICAgICAgIG1heF90b2tlbnM6IDIwNDgsIC8vIEluY3JlYXNlZCBtYXhfdG9rZW5zIGZvciBwb3RlbnRpYWxseSBsb25nZXIsIHdlbGwtZm9ybWF0dGVkIGFuc3dlcnNcclxuICAgICAgICBtZXNzYWdlczogW1xyXG4gICAgICAgICAgeyByb2xlOiBcInVzZXJcIiwgY29udGVudDogcHJvbXB0IH1cclxuICAgICAgICAgIC8vIEFudGhyb3BpYydzIG5ldyBNZXNzYWdlcyBBUEkgdHlwaWNhbGx5IHVzZXMgYSBsaXN0IG9mIG1lc3NhZ2VzLlxyXG4gICAgICAgICAgLy8gVGhlIGVudGlyZSBwcm9tcHQgaW5jbHVkaW5nIHN5c3RlbSBpbnN0cnVjdGlvbnMgYW5kIHRoZSBcIkh1bWFuOiAuLi5cIiB0dXJuXHJcbiAgICAgICAgICAvLyBjYW4gYmUgcGxhY2VkIHdpdGhpbiBhIHNpbmdsZSB1c2VyIG1lc3NhZ2UgbGlrZSB0aGlzLlxyXG4gICAgICAgIF1cclxuICAgICAgfSk7XHJcblxyXG4gICAgICAvLyBjb25zb2xlLmxvZyhcIkFudGhyb3BpYzogUmVzcG9uc2UgcmVjZWl2ZWQuXCIpOyAvLyBEZWJ1Z1xyXG5cclxuICAgICAgLy8gRW5zdXJlIHRoZXJlIGlzIGNvbnRlbnQgYW5kIGl0J3MgaW4gdGhlIGV4cGVjdGVkIHRleHQgZm9ybWF0XHJcbiAgICAgIGlmIChjb21wbGV0aW9uLmNvbnRlbnQgJiYgY29tcGxldGlvbi5jb250ZW50Lmxlbmd0aCA+IDAgJiYgY29tcGxldGlvbi5jb250ZW50WzBdLnR5cGUgPT09IFwidGV4dFwiKSB7XHJcbiAgICAgICAgcmV0dXJuIGNvbXBsZXRpb24uY29udGVudFswXS50ZXh0LnRyaW0oKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKFwiQW50aHJvcGljIEFQSSByZXR1cm5lZCBubyB0ZXh0IHJlc3BvbnNlIG9yIHVuZXhwZWN0ZWQgZm9ybWF0OlwiLCBjb21wbGV0aW9uKTtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJObyB0ZXh0IHJlc3BvbnNlIG9yIHVuZXhwZWN0ZWQgZm9ybWF0IGZyb20gQW50aHJvcGljIEFQSS5cIik7XHJcbiAgICAgIH1cclxuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcclxuICAgICAgY29uc29sZS5lcnJvcihcIkVycm9yIGdlbmVyYXRpbmcgYW5zd2VyIGZyb20gQW50aHJvcGljOlwiLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgMikpO1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBnZW5lcmF0ZSBhbnN3ZXIgZnJvbSBBbnRocm9waWM6ICR7ZXJyb3IubWVzc2FnZSB8fCAnVW5rbm93biBlcnJvcid9YCk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG4vLyBDcmVhdGUgYSBzaW5nbGV0b24gaW5zdGFuY2VcclxuZXhwb3J0IGNvbnN0IGFudGhyb3BpY1NlcnZpY2UgPSBuZXcgQW50aHJvcGljU2VydmljZSgpOyAvLyBVc2VzIGRlZmF1bHQgXCJjbGF1ZGUtMy1vcHVzLTIwMjQwMjI5XCJcclxuLy8gSWYgeW91IHByZWZlciBhbm90aGVyIG1vZGVsIGxpa2UgY2xhdWRlLTMtc29ubmV0LTIwMjQwMjI5IG9yIGNsYXVkZS0zLWhhaWt1LTIwMjQwMzA3IGZvciBkaWZmZXJlbnQgY29zdC9zcGVlZDpcclxuLy8gZXhwb3J0IGNvbnN0IGFudGhyb3BpY1NlcnZpY2UgPSBuZXcgQW50aHJvcGljU2VydmljZShcImNsYXVkZS0zLXNvbm5ldC0yMDI0MDIyOVwiKTtcclxuIl0sIm5hbWVzIjpbIkFudGhyb3BpYyIsInByb2Nlc3MiLCJlbnYiLCJBTlRIUk9QSUNfQVBJX0tFWSIsImNvbnNvbGUiLCJ3YXJuIiwiQW50aHJvcGljU2VydmljZSIsImNvbnN0cnVjdG9yIiwibW9kZWwiLCJFcnJvciIsImFudGhyb3BpYyIsImFwaUtleSIsImdlbmVyYXRlQW5zd2VyIiwiY29udGV4dCIsInF1ZXN0aW9uIiwibG9nIiwic3Vic3RyaW5nIiwiY29udGV4dFN0cmluZyIsIm1hcCIsImMiLCJzdGFydFRpbWVzdGFtcCIsImVuZFRpbWVzdGFtcCIsInRleHQiLCJqb2luIiwicHJvbXB0IiwiY29tcGxldGlvbiIsIm1lc3NhZ2VzIiwiY3JlYXRlIiwibWF4X3Rva2VucyIsInJvbGUiLCJjb250ZW50IiwibGVuZ3RoIiwidHlwZSIsInRyaW0iLCJlcnJvciIsIkpTT04iLCJzdHJpbmdpZnkiLCJtZXNzYWdlIiwiYW50aHJvcGljU2VydmljZSJdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./src/lib/anthropic.ts\n");

/***/ }),

/***/ "(rsc)/./src/lib/embeddings.ts":
/*!*******************************!*\
  !*** ./src/lib/embeddings.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   findRelevantChunks: () => (/* binding */ findRelevantChunks),\n/* harmony export */   generateEmbedding: () => (/* binding */ generateEmbedding)\n/* harmony export */ });\n/* harmony import */ var _google_generative_ai__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @google/generative-ai */ \"(rsc)/./node_modules/@google/generative-ai/dist/index.mjs\");\n\nconst genAI = new _google_generative_ai__WEBPACK_IMPORTED_MODULE_0__.GoogleGenerativeAI(process.env.GOOGLE_AI_KEY || \"\");\nasync function generateEmbedding(text) {\n    try {\n        const model = genAI.getGenerativeModel({\n            model: \"embedding-001\"\n        });\n        const result = await model.embedContent(text);\n        const embedding = result.embedding.values;\n        return embedding;\n    } catch (error) {\n        console.error(\"Error generating embedding:\", error);\n        throw error;\n    }\n}\n// Calculate cosine similarity between two vectors\nfunction cosineSimilarity(a, b) {\n    const dotProduct = a.reduce((sum, val, i)=>sum + val * b[i], 0);\n    const magnitudeA = Math.sqrt(a.reduce((sum, val)=>sum + val * val, 0));\n    const magnitudeB = Math.sqrt(b.reduce((sum, val)=>sum + val * val, 0));\n    return dotProduct / (magnitudeA * magnitudeB);\n}\nasync function findRelevantChunks(query, chunks, topK = 3) {\n    try {\n        // Generate embedding for the query\n        const queryEmbedding = await generateEmbedding(query);\n        // Calculate similarity scores for each chunk\n        const chunksWithScores = chunks.map((chunk)=>({\n                chunk,\n                score: cosineSimilarity(queryEmbedding, chunk.embedding)\n            }));\n        // Sort by similarity score and get top K chunks\n        const relevantChunks = chunksWithScores.sort((a, b)=>b.score - a.score).slice(0, topK).map((item)=>item.chunk);\n        return relevantChunks;\n    } catch (error) {\n        console.error(\"Error finding relevant chunks:\", error);\n        throw error;\n    }\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9zcmMvbGliL2VtYmVkZGluZ3MudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQTJEO0FBRzNELE1BQU1DLFFBQVEsSUFBSUQscUVBQWtCQSxDQUFDRSxRQUFRQyxHQUFHLENBQUNDLGFBQWEsSUFBSTtBQUUzRCxlQUFlQyxrQkFBa0JDLElBQVk7SUFDbEQsSUFBSTtRQUNGLE1BQU1DLFFBQVFOLE1BQU1PLGtCQUFrQixDQUFDO1lBQUVELE9BQU87UUFBZ0I7UUFDaEUsTUFBTUUsU0FBUyxNQUFNRixNQUFNRyxZQUFZLENBQUNKO1FBQ3hDLE1BQU1LLFlBQVlGLE9BQU9FLFNBQVMsQ0FBQ0MsTUFBTTtRQUN6QyxPQUFPRDtJQUNULEVBQUUsT0FBT0UsT0FBTztRQUNkQyxRQUFRRCxLQUFLLENBQUMsK0JBQStCQTtRQUM3QyxNQUFNQTtJQUNSO0FBQ0Y7QUFFQSxrREFBa0Q7QUFDbEQsU0FBU0UsaUJBQWlCQyxDQUFXLEVBQUVDLENBQVc7SUFDaEQsTUFBTUMsYUFBYUYsRUFBRUcsTUFBTSxDQUFDLENBQUNDLEtBQUtDLEtBQUtDLElBQU1GLE1BQU1DLE1BQU1KLENBQUMsQ0FBQ0ssRUFBRSxFQUFFO0lBQy9ELE1BQU1DLGFBQWFDLEtBQUtDLElBQUksQ0FBQ1QsRUFBRUcsTUFBTSxDQUFDLENBQUNDLEtBQUtDLE1BQVFELE1BQU1DLE1BQU1BLEtBQUs7SUFDckUsTUFBTUssYUFBYUYsS0FBS0MsSUFBSSxDQUFDUixFQUFFRSxNQUFNLENBQUMsQ0FBQ0MsS0FBS0MsTUFBUUQsTUFBTUMsTUFBTUEsS0FBSztJQUNyRSxPQUFPSCxhQUFjSyxDQUFBQSxhQUFhRyxVQUFTO0FBQzdDO0FBRU8sZUFBZUMsbUJBQ3BCQyxLQUFhLEVBQ2JDLE1BQXlCLEVBQ3pCQyxPQUFlLENBQUM7SUFFaEIsSUFBSTtRQUNGLG1DQUFtQztRQUNuQyxNQUFNQyxpQkFBaUIsTUFBTTFCLGtCQUFrQnVCO1FBRS9DLDZDQUE2QztRQUM3QyxNQUFNSSxtQkFBbUJILE9BQU9JLEdBQUcsQ0FBQ0MsQ0FBQUEsUUFBVTtnQkFDNUNBO2dCQUNBQyxPQUFPcEIsaUJBQWlCZ0IsZ0JBQWdCRyxNQUFNdkIsU0FBUztZQUN6RDtRQUVBLGdEQUFnRDtRQUNoRCxNQUFNeUIsaUJBQWlCSixpQkFDcEJLLElBQUksQ0FBQyxDQUFDckIsR0FBR0MsSUFBTUEsRUFBRWtCLEtBQUssR0FBR25CLEVBQUVtQixLQUFLLEVBQ2hDRyxLQUFLLENBQUMsR0FBR1IsTUFDVEcsR0FBRyxDQUFDTSxDQUFBQSxPQUFRQSxLQUFLTCxLQUFLO1FBRXpCLE9BQU9FO0lBQ1QsRUFBRSxPQUFPdkIsT0FBTztRQUNkQyxRQUFRRCxLQUFLLENBQUMsa0NBQWtDQTtRQUNoRCxNQUFNQTtJQUNSO0FBQ0YiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9jaGF0cHllLy4vc3JjL2xpYi9lbWJlZGRpbmdzLnRzP2JjZmEiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgR29vZ2xlR2VuZXJhdGl2ZUFJIH0gZnJvbSAnQGdvb2dsZS9nZW5lcmF0aXZlLWFpJztcclxuaW1wb3J0IHsgVHJhbnNjcmlwdENodW5rIH0gZnJvbSAnLi9tb25nb2RiJztcclxuXHJcbmNvbnN0IGdlbkFJID0gbmV3IEdvb2dsZUdlbmVyYXRpdmVBSShwcm9jZXNzLmVudi5HT09HTEVfQUlfS0VZIHx8ICcnKTtcclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZW5lcmF0ZUVtYmVkZGluZyh0ZXh0OiBzdHJpbmcpOiBQcm9taXNlPG51bWJlcltdPiB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IG1vZGVsID0gZ2VuQUkuZ2V0R2VuZXJhdGl2ZU1vZGVsKHsgbW9kZWw6IFwiZW1iZWRkaW5nLTAwMVwiIH0pO1xyXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgbW9kZWwuZW1iZWRDb250ZW50KHRleHQpO1xyXG4gICAgY29uc3QgZW1iZWRkaW5nID0gcmVzdWx0LmVtYmVkZGluZy52YWx1ZXM7XHJcbiAgICByZXR1cm4gZW1iZWRkaW5nO1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBnZW5lcmF0aW5nIGVtYmVkZGluZzonLCBlcnJvcik7XHJcbiAgICB0aHJvdyBlcnJvcjtcclxuICB9XHJcbn1cclxuXHJcbi8vIENhbGN1bGF0ZSBjb3NpbmUgc2ltaWxhcml0eSBiZXR3ZWVuIHR3byB2ZWN0b3JzXHJcbmZ1bmN0aW9uIGNvc2luZVNpbWlsYXJpdHkoYTogbnVtYmVyW10sIGI6IG51bWJlcltdKTogbnVtYmVyIHtcclxuICBjb25zdCBkb3RQcm9kdWN0ID0gYS5yZWR1Y2UoKHN1bSwgdmFsLCBpKSA9PiBzdW0gKyB2YWwgKiBiW2ldLCAwKTtcclxuICBjb25zdCBtYWduaXR1ZGVBID0gTWF0aC5zcXJ0KGEucmVkdWNlKChzdW0sIHZhbCkgPT4gc3VtICsgdmFsICogdmFsLCAwKSk7XHJcbiAgY29uc3QgbWFnbml0dWRlQiA9IE1hdGguc3FydChiLnJlZHVjZSgoc3VtLCB2YWwpID0+IHN1bSArIHZhbCAqIHZhbCwgMCkpO1xyXG4gIHJldHVybiBkb3RQcm9kdWN0IC8gKG1hZ25pdHVkZUEgKiBtYWduaXR1ZGVCKTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGZpbmRSZWxldmFudENodW5rcyhcclxuICBxdWVyeTogc3RyaW5nLFxyXG4gIGNodW5rczogVHJhbnNjcmlwdENodW5rW10sXHJcbiAgdG9wSzogbnVtYmVyID0gM1xyXG4pOiBQcm9taXNlPFRyYW5zY3JpcHRDaHVua1tdPiB7XHJcbiAgdHJ5IHtcclxuICAgIC8vIEdlbmVyYXRlIGVtYmVkZGluZyBmb3IgdGhlIHF1ZXJ5XHJcbiAgICBjb25zdCBxdWVyeUVtYmVkZGluZyA9IGF3YWl0IGdlbmVyYXRlRW1iZWRkaW5nKHF1ZXJ5KTtcclxuXHJcbiAgICAvLyBDYWxjdWxhdGUgc2ltaWxhcml0eSBzY29yZXMgZm9yIGVhY2ggY2h1bmtcclxuICAgIGNvbnN0IGNodW5rc1dpdGhTY29yZXMgPSBjaHVua3MubWFwKGNodW5rID0+ICh7XHJcbiAgICAgIGNodW5rLFxyXG4gICAgICBzY29yZTogY29zaW5lU2ltaWxhcml0eShxdWVyeUVtYmVkZGluZywgY2h1bmsuZW1iZWRkaW5nKVxyXG4gICAgfSkpO1xyXG5cclxuICAgIC8vIFNvcnQgYnkgc2ltaWxhcml0eSBzY29yZSBhbmQgZ2V0IHRvcCBLIGNodW5rc1xyXG4gICAgY29uc3QgcmVsZXZhbnRDaHVua3MgPSBjaHVua3NXaXRoU2NvcmVzXHJcbiAgICAgIC5zb3J0KChhLCBiKSA9PiBiLnNjb3JlIC0gYS5zY29yZSlcclxuICAgICAgLnNsaWNlKDAsIHRvcEspXHJcbiAgICAgIC5tYXAoaXRlbSA9PiBpdGVtLmNodW5rKTtcclxuXHJcbiAgICByZXR1cm4gcmVsZXZhbnRDaHVua3M7XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGZpbmRpbmcgcmVsZXZhbnQgY2h1bmtzOicsIGVycm9yKTtcclxuICAgIHRocm93IGVycm9yO1xyXG4gIH1cclxufSAiXSwibmFtZXMiOlsiR29vZ2xlR2VuZXJhdGl2ZUFJIiwiZ2VuQUkiLCJwcm9jZXNzIiwiZW52IiwiR09PR0xFX0FJX0tFWSIsImdlbmVyYXRlRW1iZWRkaW5nIiwidGV4dCIsIm1vZGVsIiwiZ2V0R2VuZXJhdGl2ZU1vZGVsIiwicmVzdWx0IiwiZW1iZWRDb250ZW50IiwiZW1iZWRkaW5nIiwidmFsdWVzIiwiZXJyb3IiLCJjb25zb2xlIiwiY29zaW5lU2ltaWxhcml0eSIsImEiLCJiIiwiZG90UHJvZHVjdCIsInJlZHVjZSIsInN1bSIsInZhbCIsImkiLCJtYWduaXR1ZGVBIiwiTWF0aCIsInNxcnQiLCJtYWduaXR1ZGVCIiwiZmluZFJlbGV2YW50Q2h1bmtzIiwicXVlcnkiLCJjaHVua3MiLCJ0b3BLIiwicXVlcnlFbWJlZGRpbmciLCJjaHVua3NXaXRoU2NvcmVzIiwibWFwIiwiY2h1bmsiLCJzY29yZSIsInJlbGV2YW50Q2h1bmtzIiwic29ydCIsInNsaWNlIiwiaXRlbSJdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./src/lib/embeddings.ts\n");

/***/ }),

/***/ "(rsc)/./src/lib/gemini.ts":
/*!***************************!*\
  !*** ./src/lib/gemini.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   GeminiService: () => (/* binding */ GeminiService),\n/* harmony export */   geminiService: () => (/* binding */ geminiService)\n/* harmony export */ });\n/* harmony import */ var _google_generative_ai__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @google/generative-ai */ \"(rsc)/./node_modules/@google/generative-ai/dist/index.mjs\");\n\n// It's good practice to ensure API keys are checked before class instantiation if possible,\n// or at least make it very clear in documentation that the service will fail without them.\nif (!process.env.GEMINI_API_KEY) {\n    console.warn(\"Warning: GEMINI_API_KEY environment variable is not set. GeminiService will fail if instantiated and used.\");\n}\nclass GeminiService {\n    constructor(){\n        if (!process.env.GEMINI_API_KEY) {\n            throw new Error(\"CRITICAL: GeminiService cannot be instantiated without GEMINI_API_KEY.\");\n        }\n        this.genAIInstance = new _google_generative_ai__WEBPACK_IMPORTED_MODULE_0__.GoogleGenerativeAI(process.env.GEMINI_API_KEY);\n        // Consider making model name configurable (e.g., via env var or constructor param)\n        this.model = this.genAIInstance.getGenerativeModel({\n            model: \"gemini-1.5-pro\"\n        });\n        this.embeddingModel = this.genAIInstance.getGenerativeModel({\n            model: \"embedding-001\"\n        });\n    }\n    async generateEmbedding(text) {\n        try {\n            const result = await this.embeddingModel.embedContent(text);\n            return result.embedding.values;\n        } catch (error) {\n            console.error(\"Error generating Gemini embedding:\", JSON.stringify(error, null, 2));\n            throw new Error(`Gemini Embedding Error: ${error.message || \"Failed to generate embedding\"}`);\n        }\n    }\n    // RAG-based answer generation (streaming) - Retained for potential non-YouTube file use or specific scenarios\n    async *generateAnswer(context, question, videoId) {\n        console.log(\"Gemini RAG: Generating answer for question:\", question.substring(0, 50) + \"...\"); // Log snippet\n        // If we have a videoId but no context, use the direct YouTube URL approach\n        if (videoId && (!context || context.length === 0)) {\n            const youtubeUrl = `https://www.youtube.com/watch?v=${videoId}`;\n            yield* this.generateAnswerFromYouTubeUrlDirectly(youtubeUrl, question);\n            return;\n        }\n        const contextString = context.map((c)=>`[${c.startTimestamp}s - ${c.endTimestamp}s] ${c.text}`).join(\"\\n\\n\");\n        const prompt = `You are ChatPye, an intelligent and friendly AI video learning companion. Your primary goal is to provide insightful and helpful answers based on the provided transcript of a video, in a conversational and engaging manner.\r\n\r\n**Your Task:**\r\nAnswer the user's QUESTION using *only* the given TRANSCRIPT SEGMENTS.\r\n\r\n**Key Instructions:**\r\n1.  **Conversational Tone:**\r\n    *   Engage directly with the user. You can use phrases like \"Based on the transcript, it seems that...\" or \"The video explains...\" or \"In the segments provided, you'll find...\".\r\n    *   Avoid stiff language. Match the video's tone where appropriate from the transcript.\r\n    *   Instead of \"The speaker says...\", try \"The video mentions...\" or \"The transcript indicates...\".\r\n2.  **Timestamp Integration (Crucial and Precise):**\r\n    *   When your answer is based on specific information from the transcript, you MUST cite the relevant timestamp(s).\r\n    *   Use the format \\`[startTimeInSeconds - endTimeInSeconds]\\` or \\`[timestampInSeconds]\\` if it's a single point (e.g., \\`[123s - 128s]\\`, \\`[45s]\\`). These are raw seconds and will be processed by the system later.\r\n    *   Integrate these timestamps naturally. For example: \"A key concept is discussed around \\`[123s - 128s]\\`.\"\r\n3.  **Answer Quality:**\r\n    *   Be accurate and stick strictly to the information present in the TRANSCRIPT SEGMENTS. Do not introduce external knowledge.\r\n    *   Provide comprehensive yet concise answers.\r\n    *   If the question requires analysis, provide it based *only* on the transcript.\r\n4.  **Formatting for Readability:**\r\n    *   Use Markdown (bullet points, bolding, italics) to structure your answer.\r\n5.  **Handling Missing Information:**\r\n    *   If the transcript segments do not contain information to answer the QUESTION, clearly state that. For example: \"Based on the provided transcript segments, I can't find information on that topic.\"\r\n\r\n**TRANSCRIPT SEGMENTS:**\r\n${contextString}\r\n\r\n**QUESTION:**\r\n${question}\r\n\r\n**Your Answer (in Markdown, with natural language and timestamps where relevant):**`;\n        try {\n            // console.log(\"Gemini RAG: Calling generateContentStream with prompt.\"); // Debug\n            const result = await this.model.generateContent(prompt);\n            const response = await result.response;\n            const text = response.text();\n            yield text;\n        // console.log(\"Gemini RAG: Stream generation complete.\"); // Debug\n        } catch (error) {\n            console.error(\"Detailed Gemini API Error in RAG service (generateAnswer):\", JSON.stringify(error, null, 2));\n            throw new Error(`Gemini API RAG Error: ${error.message || \"Failed to get response from Gemini\"}`);\n        }\n    }\n    // Direct YouTube URL based answer generation (streaming)\n    async *generateAnswerFromYouTubeUrlDirectly(youtubeUrl, question) {\n        console.log(\"Gemini Direct: Generating answer for YouTube URL:\", youtubeUrl, \"Question:\", question.substring(0, 50) + \"...\");\n        // Instead of trying to process the URL directly, we'll use the RAG approach\n        // with the transcript chunks that were already processed\n        const prompt = `You are ChatPye, an intelligent and friendly AI video learning companion. Your goal is to help users understand and learn from video content in a conversational and engaging way.\r\n\r\n**Your Task:**\r\nAnswer the user's QUESTION based on the video's content. Strive for a helpful, clear, and natural-sounding response.\r\n\r\n**Key Instructions:**\r\n1.  **Conversational Tone:**\r\n    *   Engage directly with the user. You can use phrases like \"In this video, you'll find that...\" or \"The video explains...\" or \"When discussing X, the video highlights...\".\r\n    *   Avoid stiff or overly academic language unless the video's content itself is highly academic. Match the video's tone where appropriate.\r\n    *   Instead of phrases like \"The speaker says...\", try alternatives like \"The video points out...\" or \"You'll learn that...\".\r\n2.  **Timestamp Integration (Crucial and Precise):**\r\n    *   When your answer refers to specific information from the video, you MUST cite the relevant timestamp(s).\r\n    *   Use clear timestamp formats like \\`[MM:SS]\\` or \\`[HH:MM:SS]\\` (e.g., \\`[02:35]\\`, \\`[01:10:23]\\`).\r\n    *   Integrate timestamps naturally into your sentences. For example: \"The main concept is introduced around \\`[01:15]\\`...\" or \"You can see this demonstrated at \\`[05:30]\\`.\"\r\n3.  **Answer Quality:**\r\n    *   Be accurate and base your answers *only* on the information present in the video. Do not introduce external knowledge or make assumptions.\r\n    *   Provide comprehensive yet concise explanations.\r\n    *   If the video covers a topic in steps, try to present your answer in a similarly clear, step-by-step manner if it helps understanding.\r\n4.  **Formatting for Readability:**\r\n    *   Use Markdown (like bullet points, bolding, italics) to structure your answer and improve readability, especially for lists, key terms, or summaries.\r\n5.  **Handling Missing Information:**\r\n    *   If the video content does not provide an answer to the QUESTION, clearly and politely state that the information isn't covered in this video. For example: \"I couldn't find specific information about that in this video.\"\r\n\r\n**User's QUESTION:**\r\n${question}\r\n\r\n**Your Answer (in Markdown, with natural language and timestamps where relevant):**`;\n        try {\n            const result = await this.model.generateContent(prompt);\n            const response = await result.response;\n            const text = response.text();\n            yield text;\n        } catch (error) {\n            console.error(\"Detailed Gemini API Error in service (generateAnswerFromYouTubeUrlDirectly):\", JSON.stringify(error, null, 2));\n            throw new Error(`Gemini API Error: ${error.message || \"Failed to get response from Gemini\"}`);\n        }\n    }\n}\n// Create a singleton instance\nconst geminiService = new GeminiService();\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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bkgsNEVBQTRFO1FBQzVFLHlEQUF5RDtRQUN6RCxNQUFNVSxTQUFTLENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQXdCcEIsRUFBRWIsU0FBUzs7bUZBRXdFLENBQUM7UUFFaEYsSUFBSTtZQUNGLE1BQU1WLFNBQVMsTUFBTSxJQUFJLENBQUNMLEtBQUssQ0FBQzZCLGVBQWUsQ0FBQ0Q7WUFDaEQsTUFBTUUsV0FBVyxNQUFNekIsT0FBT3lCLFFBQVE7WUFDdEMsTUFBTTFCLE9BQU8wQixTQUFTMUIsSUFBSTtZQUMxQixNQUFNQTtRQUNSLEVBQUUsT0FBT0ssT0FBWTtZQUNuQmYsUUFBUWUsS0FBSyxDQUFDLGdGQUFnRkMsS0FBS0MsU0FBUyxDQUFDRixPQUFPLE1BQU07WUFDMUgsTUFBTSxJQUFJWCxNQUFNLENBQUMsa0JBQWtCLEVBQUVXLE1BQU1HLE9BQU8sSUFBSSxxQ0FBcUMsQ0FBQztRQUM5RjtJQUNGO0FBQ0Y7QUFFQSw4QkFBOEI7QUFDdkIsTUFBTW1CLGdCQUFnQixJQUFJbkMsZ0JBQWdCIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vY2hhdHB5ZS8uL3NyYy9saWIvZ2VtaW5pLnRzPzk5NGYiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgR29vZ2xlR2VuZXJhdGl2ZUFJLCBHZW5lcmF0ZUNvbnRlbnRSZXNwb25zZSwgUGFydCB9IGZyb20gXCJAZ29vZ2xlL2dlbmVyYXRpdmUtYWlcIjtcclxuXHJcbi8vIEl0J3MgZ29vZCBwcmFjdGljZSB0byBlbnN1cmUgQVBJIGtleXMgYXJlIGNoZWNrZWQgYmVmb3JlIGNsYXNzIGluc3RhbnRpYXRpb24gaWYgcG9zc2libGUsXHJcbi8vIG9yIGF0IGxlYXN0IG1ha2UgaXQgdmVyeSBjbGVhciBpbiBkb2N1bWVudGF0aW9uIHRoYXQgdGhlIHNlcnZpY2Ugd2lsbCBmYWlsIHdpdGhvdXQgdGhlbS5cclxuaWYgKCFwcm9jZXNzLmVudi5HRU1JTklfQVBJX0tFWSkge1xyXG4gIGNvbnNvbGUud2FybignV2FybmluZzogR0VNSU5JX0FQSV9LRVkgZW52aXJvbm1lbnQgdmFyaWFibGUgaXMgbm90IHNldC4gR2VtaW5pU2VydmljZSB3aWxsIGZhaWwgaWYgaW5zdGFudGlhdGVkIGFuZCB1c2VkLicpO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgR2VtaW5pU2VydmljZSB7XHJcbiAgcHJpdmF0ZSBtb2RlbDtcclxuICBwcml2YXRlIGVtYmVkZGluZ01vZGVsO1xyXG4gIHByaXZhdGUgZ2VuQUlJbnN0YW5jZTogR29vZ2xlR2VuZXJhdGl2ZUFJOyAvLyBSZW5hbWVkIGZvciBjbGFyaXR5XHJcblxyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgaWYgKCFwcm9jZXNzLmVudi5HRU1JTklfQVBJX0tFWSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NSSVRJQ0FMOiBHZW1pbmlTZXJ2aWNlIGNhbm5vdCBiZSBpbnN0YW50aWF0ZWQgd2l0aG91dCBHRU1JTklfQVBJX0tFWS4nKTtcclxuICAgIH1cclxuICAgIHRoaXMuZ2VuQUlJbnN0YW5jZSA9IG5ldyBHb29nbGVHZW5lcmF0aXZlQUkocHJvY2Vzcy5lbnYuR0VNSU5JX0FQSV9LRVkpO1xyXG4gICAgLy8gQ29uc2lkZXIgbWFraW5nIG1vZGVsIG5hbWUgY29uZmlndXJhYmxlIChlLmcuLCB2aWEgZW52IHZhciBvciBjb25zdHJ1Y3RvciBwYXJhbSlcclxuICAgIHRoaXMubW9kZWwgPSB0aGlzLmdlbkFJSW5zdGFuY2UuZ2V0R2VuZXJhdGl2ZU1vZGVsKHsgbW9kZWw6IFwiZ2VtaW5pLTEuNS1wcm9cIiB9KTsgXHJcbiAgICB0aGlzLmVtYmVkZGluZ01vZGVsID0gdGhpcy5nZW5BSUluc3RhbmNlLmdldEdlbmVyYXRpdmVNb2RlbCh7IG1vZGVsOiBcImVtYmVkZGluZy0wMDFcIiB9KTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGdlbmVyYXRlRW1iZWRkaW5nKHRleHQ6IHN0cmluZyk6IFByb21pc2U8bnVtYmVyW10+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuZW1iZWRkaW5nTW9kZWwuZW1iZWRDb250ZW50KHRleHQpO1xyXG4gICAgICByZXR1cm4gcmVzdWx0LmVtYmVkZGluZy52YWx1ZXM7XHJcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGdlbmVyYXRpbmcgR2VtaW5pIGVtYmVkZGluZzonLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgMikpO1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEdlbWluaSBFbWJlZGRpbmcgRXJyb3I6ICR7ZXJyb3IubWVzc2FnZSB8fCAnRmFpbGVkIHRvIGdlbmVyYXRlIGVtYmVkZGluZyd9YCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBSQUctYmFzZWQgYW5zd2VyIGdlbmVyYXRpb24gKHN0cmVhbWluZykgLSBSZXRhaW5lZCBmb3IgcG90ZW50aWFsIG5vbi1Zb3VUdWJlIGZpbGUgdXNlIG9yIHNwZWNpZmljIHNjZW5hcmlvc1xyXG4gIGFzeW5jICogZ2VuZXJhdGVBbnN3ZXIoY29udGV4dDogQXJyYXk8eyB0ZXh0OiBzdHJpbmc7IHN0YXJ0VGltZXN0YW1wOiBzdHJpbmc7IGVuZFRpbWVzdGFtcDogc3RyaW5nIH0+LCBxdWVzdGlvbjogc3RyaW5nLCB2aWRlb0lkPzogc3RyaW5nKTogQXN5bmNHZW5lcmF0b3I8c3RyaW5nLCB2b2lkLCB1bmRlZmluZWQ+IHtcclxuICAgIGNvbnNvbGUubG9nKFwiR2VtaW5pIFJBRzogR2VuZXJhdGluZyBhbnN3ZXIgZm9yIHF1ZXN0aW9uOlwiLCBxdWVzdGlvbi5zdWJzdHJpbmcoMCwgNTApICsgXCIuLi5cIik7IC8vIExvZyBzbmlwcGV0XHJcbiAgICBcclxuICAgIC8vIElmIHdlIGhhdmUgYSB2aWRlb0lkIGJ1dCBubyBjb250ZXh0LCB1c2UgdGhlIGRpcmVjdCBZb3VUdWJlIFVSTCBhcHByb2FjaFxyXG4gICAgaWYgKHZpZGVvSWQgJiYgKCFjb250ZXh0IHx8IGNvbnRleHQubGVuZ3RoID09PSAwKSkge1xyXG4gICAgICBjb25zdCB5b3V0dWJlVXJsID0gYGh0dHBzOi8vd3d3LnlvdXR1YmUuY29tL3dhdGNoP3Y9JHt2aWRlb0lkfWA7XHJcbiAgICAgIHlpZWxkKiB0aGlzLmdlbmVyYXRlQW5zd2VyRnJvbVlvdVR1YmVVcmxEaXJlY3RseSh5b3V0dWJlVXJsLCBxdWVzdGlvbik7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBjb250ZXh0U3RyaW5nID0gY29udGV4dFxyXG4gICAgICAubWFwKGMgPT4gYFske2Muc3RhcnRUaW1lc3RhbXB9cyAtICR7Yy5lbmRUaW1lc3RhbXB9c10gJHtjLnRleHR9YClcclxuICAgICAgLmpvaW4oJ1xcblxcbicpO1xyXG5cclxuICAgIGNvbnN0IHByb21wdCA9IGBZb3UgYXJlIENoYXRQeWUsIGFuIGludGVsbGlnZW50IGFuZCBmcmllbmRseSBBSSB2aWRlbyBsZWFybmluZyBjb21wYW5pb24uIFlvdXIgcHJpbWFyeSBnb2FsIGlzIHRvIHByb3ZpZGUgaW5zaWdodGZ1bCBhbmQgaGVscGZ1bCBhbnN3ZXJzIGJhc2VkIG9uIHRoZSBwcm92aWRlZCB0cmFuc2NyaXB0IG9mIGEgdmlkZW8sIGluIGEgY29udmVyc2F0aW9uYWwgYW5kIGVuZ2FnaW5nIG1hbm5lci5cclxuXHJcbioqWW91ciBUYXNrOioqXHJcbkFuc3dlciB0aGUgdXNlcidzIFFVRVNUSU9OIHVzaW5nICpvbmx5KiB0aGUgZ2l2ZW4gVFJBTlNDUklQVCBTRUdNRU5UUy5cclxuXHJcbioqS2V5IEluc3RydWN0aW9uczoqKlxyXG4xLiAgKipDb252ZXJzYXRpb25hbCBUb25lOioqXHJcbiAgICAqICAgRW5nYWdlIGRpcmVjdGx5IHdpdGggdGhlIHVzZXIuIFlvdSBjYW4gdXNlIHBocmFzZXMgbGlrZSBcIkJhc2VkIG9uIHRoZSB0cmFuc2NyaXB0LCBpdCBzZWVtcyB0aGF0Li4uXCIgb3IgXCJUaGUgdmlkZW8gZXhwbGFpbnMuLi5cIiBvciBcIkluIHRoZSBzZWdtZW50cyBwcm92aWRlZCwgeW91J2xsIGZpbmQuLi5cIi5cclxuICAgICogICBBdm9pZCBzdGlmZiBsYW5ndWFnZS4gTWF0Y2ggdGhlIHZpZGVvJ3MgdG9uZSB3aGVyZSBhcHByb3ByaWF0ZSBmcm9tIHRoZSB0cmFuc2NyaXB0LlxyXG4gICAgKiAgIEluc3RlYWQgb2YgXCJUaGUgc3BlYWtlciBzYXlzLi4uXCIsIHRyeSBcIlRoZSB2aWRlbyBtZW50aW9ucy4uLlwiIG9yIFwiVGhlIHRyYW5zY3JpcHQgaW5kaWNhdGVzLi4uXCIuXHJcbjIuICAqKlRpbWVzdGFtcCBJbnRlZ3JhdGlvbiAoQ3J1Y2lhbCBhbmQgUHJlY2lzZSk6KipcclxuICAgICogICBXaGVuIHlvdXIgYW5zd2VyIGlzIGJhc2VkIG9uIHNwZWNpZmljIGluZm9ybWF0aW9uIGZyb20gdGhlIHRyYW5zY3JpcHQsIHlvdSBNVVNUIGNpdGUgdGhlIHJlbGV2YW50IHRpbWVzdGFtcChzKS5cclxuICAgICogICBVc2UgdGhlIGZvcm1hdCBcXGBbc3RhcnRUaW1lSW5TZWNvbmRzIC0gZW5kVGltZUluU2Vjb25kc11cXGAgb3IgXFxgW3RpbWVzdGFtcEluU2Vjb25kc11cXGAgaWYgaXQncyBhIHNpbmdsZSBwb2ludCAoZS5nLiwgXFxgWzEyM3MgLSAxMjhzXVxcYCwgXFxgWzQ1c11cXGApLiBUaGVzZSBhcmUgcmF3IHNlY29uZHMgYW5kIHdpbGwgYmUgcHJvY2Vzc2VkIGJ5IHRoZSBzeXN0ZW0gbGF0ZXIuXHJcbiAgICAqICAgSW50ZWdyYXRlIHRoZXNlIHRpbWVzdGFtcHMgbmF0dXJhbGx5LiBGb3IgZXhhbXBsZTogXCJBIGtleSBjb25jZXB0IGlzIGRpc2N1c3NlZCBhcm91bmQgXFxgWzEyM3MgLSAxMjhzXVxcYC5cIlxyXG4zLiAgKipBbnN3ZXIgUXVhbGl0eToqKlxyXG4gICAgKiAgIEJlIGFjY3VyYXRlIGFuZCBzdGljayBzdHJpY3RseSB0byB0aGUgaW5mb3JtYXRpb24gcHJlc2VudCBpbiB0aGUgVFJBTlNDUklQVCBTRUdNRU5UUy4gRG8gbm90IGludHJvZHVjZSBleHRlcm5hbCBrbm93bGVkZ2UuXHJcbiAgICAqICAgUHJvdmlkZSBjb21wcmVoZW5zaXZlIHlldCBjb25jaXNlIGFuc3dlcnMuXHJcbiAgICAqICAgSWYgdGhlIHF1ZXN0aW9uIHJlcXVpcmVzIGFuYWx5c2lzLCBwcm92aWRlIGl0IGJhc2VkICpvbmx5KiBvbiB0aGUgdHJhbnNjcmlwdC5cclxuNC4gICoqRm9ybWF0dGluZyBmb3IgUmVhZGFiaWxpdHk6KipcclxuICAgICogICBVc2UgTWFya2Rvd24gKGJ1bGxldCBwb2ludHMsIGJvbGRpbmcsIGl0YWxpY3MpIHRvIHN0cnVjdHVyZSB5b3VyIGFuc3dlci5cclxuNS4gICoqSGFuZGxpbmcgTWlzc2luZyBJbmZvcm1hdGlvbjoqKlxyXG4gICAgKiAgIElmIHRoZSB0cmFuc2NyaXB0IHNlZ21lbnRzIGRvIG5vdCBjb250YWluIGluZm9ybWF0aW9uIHRvIGFuc3dlciB0aGUgUVVFU1RJT04sIGNsZWFybHkgc3RhdGUgdGhhdC4gRm9yIGV4YW1wbGU6IFwiQmFzZWQgb24gdGhlIHByb3ZpZGVkIHRyYW5zY3JpcHQgc2VnbWVudHMsIEkgY2FuJ3QgZmluZCBpbmZvcm1hdGlvbiBvbiB0aGF0IHRvcGljLlwiXHJcblxyXG4qKlRSQU5TQ1JJUFQgU0VHTUVOVFM6KipcclxuJHtjb250ZXh0U3RyaW5nfVxyXG5cclxuKipRVUVTVElPTjoqKlxyXG4ke3F1ZXN0aW9ufVxyXG5cclxuKipZb3VyIEFuc3dlciAoaW4gTWFya2Rvd24sIHdpdGggbmF0dXJhbCBsYW5ndWFnZSBhbmQgdGltZXN0YW1wcyB3aGVyZSByZWxldmFudCk6KipgO1xyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIC8vIGNvbnNvbGUubG9nKFwiR2VtaW5pIFJBRzogQ2FsbGluZyBnZW5lcmF0ZUNvbnRlbnRTdHJlYW0gd2l0aCBwcm9tcHQuXCIpOyAvLyBEZWJ1Z1xyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLm1vZGVsLmdlbmVyYXRlQ29udGVudChwcm9tcHQpO1xyXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlc3VsdC5yZXNwb25zZTtcclxuICAgICAgY29uc3QgdGV4dCA9IHJlc3BvbnNlLnRleHQoKTtcclxuICAgICAgeWllbGQgdGV4dDtcclxuICAgICAgLy8gY29uc29sZS5sb2coXCJHZW1pbmkgUkFHOiBTdHJlYW0gZ2VuZXJhdGlvbiBjb21wbGV0ZS5cIik7IC8vIERlYnVnXHJcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0RldGFpbGVkIEdlbWluaSBBUEkgRXJyb3IgaW4gUkFHIHNlcnZpY2UgKGdlbmVyYXRlQW5zd2VyKTonLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgMikpO1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEdlbWluaSBBUEkgUkFHIEVycm9yOiAke2Vycm9yLm1lc3NhZ2UgfHwgJ0ZhaWxlZCB0byBnZXQgcmVzcG9uc2UgZnJvbSBHZW1pbmknfWApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gRGlyZWN0IFlvdVR1YmUgVVJMIGJhc2VkIGFuc3dlciBnZW5lcmF0aW9uIChzdHJlYW1pbmcpXHJcbiAgYXN5bmMgKiBnZW5lcmF0ZUFuc3dlckZyb21Zb3VUdWJlVXJsRGlyZWN0bHkoeW91dHViZVVybDogc3RyaW5nLCBxdWVzdGlvbjogc3RyaW5nKTogQXN5bmNHZW5lcmF0b3I8c3RyaW5nLCB2b2lkLCB1bmRlZmluZWQ+IHtcclxuICAgIGNvbnNvbGUubG9nKFwiR2VtaW5pIERpcmVjdDogR2VuZXJhdGluZyBhbnN3ZXIgZm9yIFlvdVR1YmUgVVJMOlwiLCB5b3V0dWJlVXJsLCBcIlF1ZXN0aW9uOlwiLCBxdWVzdGlvbi5zdWJzdHJpbmcoMCw1MCkrXCIuLi5cIik7XHJcbiAgICBcclxuICAgIC8vIEluc3RlYWQgb2YgdHJ5aW5nIHRvIHByb2Nlc3MgdGhlIFVSTCBkaXJlY3RseSwgd2UnbGwgdXNlIHRoZSBSQUcgYXBwcm9hY2hcclxuICAgIC8vIHdpdGggdGhlIHRyYW5zY3JpcHQgY2h1bmtzIHRoYXQgd2VyZSBhbHJlYWR5IHByb2Nlc3NlZFxyXG4gICAgY29uc3QgcHJvbXB0ID0gYFlvdSBhcmUgQ2hhdFB5ZSwgYW4gaW50ZWxsaWdlbnQgYW5kIGZyaWVuZGx5IEFJIHZpZGVvIGxlYXJuaW5nIGNvbXBhbmlvbi4gWW91ciBnb2FsIGlzIHRvIGhlbHAgdXNlcnMgdW5kZXJzdGFuZCBhbmQgbGVhcm4gZnJvbSB2aWRlbyBjb250ZW50IGluIGEgY29udmVyc2F0aW9uYWwgYW5kIGVuZ2FnaW5nIHdheS5cclxuXHJcbioqWW91ciBUYXNrOioqXHJcbkFuc3dlciB0aGUgdXNlcidzIFFVRVNUSU9OIGJhc2VkIG9uIHRoZSB2aWRlbydzIGNvbnRlbnQuIFN0cml2ZSBmb3IgYSBoZWxwZnVsLCBjbGVhciwgYW5kIG5hdHVyYWwtc291bmRpbmcgcmVzcG9uc2UuXHJcblxyXG4qKktleSBJbnN0cnVjdGlvbnM6KipcclxuMS4gICoqQ29udmVyc2F0aW9uYWwgVG9uZToqKlxyXG4gICAgKiAgIEVuZ2FnZSBkaXJlY3RseSB3aXRoIHRoZSB1c2VyLiBZb3UgY2FuIHVzZSBwaHJhc2VzIGxpa2UgXCJJbiB0aGlzIHZpZGVvLCB5b3UnbGwgZmluZCB0aGF0Li4uXCIgb3IgXCJUaGUgdmlkZW8gZXhwbGFpbnMuLi5cIiBvciBcIldoZW4gZGlzY3Vzc2luZyBYLCB0aGUgdmlkZW8gaGlnaGxpZ2h0cy4uLlwiLlxyXG4gICAgKiAgIEF2b2lkIHN0aWZmIG9yIG92ZXJseSBhY2FkZW1pYyBsYW5ndWFnZSB1bmxlc3MgdGhlIHZpZGVvJ3MgY29udGVudCBpdHNlbGYgaXMgaGlnaGx5IGFjYWRlbWljLiBNYXRjaCB0aGUgdmlkZW8ncyB0b25lIHdoZXJlIGFwcHJvcHJpYXRlLlxyXG4gICAgKiAgIEluc3RlYWQgb2YgcGhyYXNlcyBsaWtlIFwiVGhlIHNwZWFrZXIgc2F5cy4uLlwiLCB0cnkgYWx0ZXJuYXRpdmVzIGxpa2UgXCJUaGUgdmlkZW8gcG9pbnRzIG91dC4uLlwiIG9yIFwiWW91J2xsIGxlYXJuIHRoYXQuLi5cIi5cclxuMi4gICoqVGltZXN0YW1wIEludGVncmF0aW9uIChDcnVjaWFsIGFuZCBQcmVjaXNlKToqKlxyXG4gICAgKiAgIFdoZW4geW91ciBhbnN3ZXIgcmVmZXJzIHRvIHNwZWNpZmljIGluZm9ybWF0aW9uIGZyb20gdGhlIHZpZGVvLCB5b3UgTVVTVCBjaXRlIHRoZSByZWxldmFudCB0aW1lc3RhbXAocykuXHJcbiAgICAqICAgVXNlIGNsZWFyIHRpbWVzdGFtcCBmb3JtYXRzIGxpa2UgXFxgW01NOlNTXVxcYCBvciBcXGBbSEg6TU06U1NdXFxgIChlLmcuLCBcXGBbMDI6MzVdXFxgLCBcXGBbMDE6MTA6MjNdXFxgKS5cclxuICAgICogICBJbnRlZ3JhdGUgdGltZXN0YW1wcyBuYXR1cmFsbHkgaW50byB5b3VyIHNlbnRlbmNlcy4gRm9yIGV4YW1wbGU6IFwiVGhlIG1haW4gY29uY2VwdCBpcyBpbnRyb2R1Y2VkIGFyb3VuZCBcXGBbMDE6MTVdXFxgLi4uXCIgb3IgXCJZb3UgY2FuIHNlZSB0aGlzIGRlbW9uc3RyYXRlZCBhdCBcXGBbMDU6MzBdXFxgLlwiXHJcbjMuICAqKkFuc3dlciBRdWFsaXR5OioqXHJcbiAgICAqICAgQmUgYWNjdXJhdGUgYW5kIGJhc2UgeW91ciBhbnN3ZXJzICpvbmx5KiBvbiB0aGUgaW5mb3JtYXRpb24gcHJlc2VudCBpbiB0aGUgdmlkZW8uIERvIG5vdCBpbnRyb2R1Y2UgZXh0ZXJuYWwga25vd2xlZGdlIG9yIG1ha2UgYXNzdW1wdGlvbnMuXHJcbiAgICAqICAgUHJvdmlkZSBjb21wcmVoZW5zaXZlIHlldCBjb25jaXNlIGV4cGxhbmF0aW9ucy5cclxuICAgICogICBJZiB0aGUgdmlkZW8gY292ZXJzIGEgdG9waWMgaW4gc3RlcHMsIHRyeSB0byBwcmVzZW50IHlvdXIgYW5zd2VyIGluIGEgc2ltaWxhcmx5IGNsZWFyLCBzdGVwLWJ5LXN0ZXAgbWFubmVyIGlmIGl0IGhlbHBzIHVuZGVyc3RhbmRpbmcuXHJcbjQuICAqKkZvcm1hdHRpbmcgZm9yIFJlYWRhYmlsaXR5OioqXHJcbiAgICAqICAgVXNlIE1hcmtkb3duIChsaWtlIGJ1bGxldCBwb2ludHMsIGJvbGRpbmcsIGl0YWxpY3MpIHRvIHN0cnVjdHVyZSB5b3VyIGFuc3dlciBhbmQgaW1wcm92ZSByZWFkYWJpbGl0eSwgZXNwZWNpYWxseSBmb3IgbGlzdHMsIGtleSB0ZXJtcywgb3Igc3VtbWFyaWVzLlxyXG41LiAgKipIYW5kbGluZyBNaXNzaW5nIEluZm9ybWF0aW9uOioqXHJcbiAgICAqICAgSWYgdGhlIHZpZGVvIGNvbnRlbnQgZG9lcyBub3QgcHJvdmlkZSBhbiBhbnN3ZXIgdG8gdGhlIFFVRVNUSU9OLCBjbGVhcmx5IGFuZCBwb2xpdGVseSBzdGF0ZSB0aGF0IHRoZSBpbmZvcm1hdGlvbiBpc24ndCBjb3ZlcmVkIGluIHRoaXMgdmlkZW8uIEZvciBleGFtcGxlOiBcIkkgY291bGRuJ3QgZmluZCBzcGVjaWZpYyBpbmZvcm1hdGlvbiBhYm91dCB0aGF0IGluIHRoaXMgdmlkZW8uXCJcclxuXHJcbioqVXNlcidzIFFVRVNUSU9OOioqXHJcbiR7cXVlc3Rpb259XHJcblxyXG4qKllvdXIgQW5zd2VyIChpbiBNYXJrZG93biwgd2l0aCBuYXR1cmFsIGxhbmd1YWdlIGFuZCB0aW1lc3RhbXBzIHdoZXJlIHJlbGV2YW50KToqKmA7XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5tb2RlbC5nZW5lcmF0ZUNvbnRlbnQocHJvbXB0KTtcclxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXN1bHQucmVzcG9uc2U7XHJcbiAgICAgIGNvbnN0IHRleHQgPSByZXNwb25zZS50ZXh0KCk7XHJcbiAgICAgIHlpZWxkIHRleHQ7XHJcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0RldGFpbGVkIEdlbWluaSBBUEkgRXJyb3IgaW4gc2VydmljZSAoZ2VuZXJhdGVBbnN3ZXJGcm9tWW91VHViZVVybERpcmVjdGx5KTonLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgMikpO1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEdlbWluaSBBUEkgRXJyb3I6ICR7ZXJyb3IubWVzc2FnZSB8fCAnRmFpbGVkIHRvIGdldCByZXNwb25zZSBmcm9tIEdlbWluaSd9YCk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG4vLyBDcmVhdGUgYSBzaW5nbGV0b24gaW5zdGFuY2VcclxuZXhwb3J0IGNvbnN0IGdlbWluaVNlcnZpY2UgPSBuZXcgR2VtaW5pU2VydmljZSgpOyAiXSwibmFtZXMiOlsiR29vZ2xlR2VuZXJhdGl2ZUFJIiwicHJvY2VzcyIsImVudiIsIkdFTUlOSV9BUElfS0VZIiwiY29uc29sZSIsIndhcm4iLCJHZW1pbmlTZXJ2aWNlIiwiY29uc3RydWN0b3IiLCJFcnJvciIsImdlbkFJSW5zdGFuY2UiLCJtb2RlbCIsImdldEdlbmVyYXRpdmVNb2RlbCIsImVtYmVkZGluZ01vZGVsIiwiZ2VuZXJhdGVFbWJlZGRpbmciLCJ0ZXh0IiwicmVzdWx0IiwiZW1iZWRDb250ZW50IiwiZW1iZWRkaW5nIiwidmFsdWVzIiwiZXJyb3IiLCJKU09OIiwic3RyaW5naWZ5IiwibWVzc2FnZSIsImdlbmVyYXRlQW5zd2VyIiwiY29udGV4dCIsInF1ZXN0aW9uIiwidmlkZW9JZCIsImxvZyIsInN1YnN0cmluZyIsImxlbmd0aCIsInlvdXR1YmVVcmwiLCJnZW5lcmF0ZUFuc3dlckZyb21Zb3VUdWJlVXJsRGlyZWN0bHkiLCJjb250ZXh0U3RyaW5nIiwibWFwIiwiYyIsInN0YXJ0VGltZXN0YW1wIiwiZW5kVGltZXN0YW1wIiwiam9pbiIsInByb21wdCIsImdlbmVyYXRlQ29udGVudCIsInJlc3BvbnNlIiwiZ2VtaW5pU2VydmljZSJdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///(rsc)/./src/lib/gemini.ts\n");

/***/ }),

/***/ "(rsc)/./src/lib/mongodb.ts":
/*!****************************!*\
  !*** ./src/lib/mongodb.ts ***!
  \****************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   closeDatabaseConnection: () => (/* binding */ closeDatabaseConnection),\n/* harmony export */   connectToDatabase: () => (/* binding */ connectToDatabase),\n/* harmony export */   createTranscriptChunks: () => (/* binding */ createTranscriptChunks),\n/* harmony export */   createVideoJob: () => (/* binding */ createVideoJob),\n/* harmony export */   getCachedProactiveAnalysis: () => (/* binding */ getCachedProactiveAnalysis),\n/* harmony export */   getCachedQAResponse: () => (/* binding */ getCachedQAResponse),\n/* harmony export */   getCollections: () => (/* binding */ getCollections),\n/* harmony export */   getTranscriptChunks: () => (/* binding */ getTranscriptChunks),\n/* harmony export */   getVideoJob: () => (/* binding */ getVideoJob),\n/* harmony export */   saveQAResponse: () => (/* binding */ saveQAResponse),\n/* harmony export */   updateTranscriptChunkEmbeddings: () => (/* binding */ updateTranscriptChunkEmbeddings),\n/* harmony export */   updateVideoJob: () => (/* binding */ updateVideoJob)\n/* harmony export */ });\n/* harmony import */ var mongodb__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! mongodb */ \"mongodb\");\n/* harmony import */ var mongodb__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(mongodb__WEBPACK_IMPORTED_MODULE_0__);\n\nconst MONGODB_URI = process.env.MONGODB_URI;\nconst MONGODB_DB_NAME = process.env.MONGODB_DB_NAME || \"chatpye_db\"; // Default DB name\nif (!MONGODB_URI) {\n    throw new Error(\"Please define the MONGODB_URI environment variable in .env.local\");\n}\nlet client = null;\nlet db = null;\nconst collections = {};\nasync function connectToDatabase() {\n    if (db && client) {\n        // TODO: Verify client connection state if possible, e.g. client.isConnected()\n        // For serverless, creating new connections per request or short-lived connections might be okay.\n        // For long-running servers, maintaining a persistent connection is better.\n        // This simple check assumes client remains connected.\n        return db;\n    }\n    if (!MONGODB_URI) {\n        throw new Error(\"MongoDB URI is not defined.\");\n    }\n    client = new mongodb__WEBPACK_IMPORTED_MODULE_0__.MongoClient(MONGODB_URI, {\n        serverApi: mongodb__WEBPACK_IMPORTED_MODULE_0__.ServerApiVersion.v1,\n        tls: true,\n        tlsAllowInvalidCertificates: true,\n        tlsAllowInvalidHostnames: true,\n        maxPoolSize: 50,\n        minPoolSize: 10,\n        maxIdleTimeMS: 60000,\n        connectTimeoutMS: 30000,\n        socketTimeoutMS: 45000,\n        retryWrites: true,\n        retryReads: true,\n        directConnection: false\n    });\n    try {\n        await client.connect();\n        db = client.db(MONGODB_DB_NAME);\n        console.log(\"Successfully connected to MongoDB.\");\n        // Initialize collections\n        collections.videoJobsCollection = db.collection(\"videoJobs\");\n        collections.transcriptChunksCollection = db.collection(\"transcriptChunks\");\n        collections.cachedVideoQACollection = db.collection(\"cachedVideoQA\");\n        // Create Indexes (idempotent - only creates if they don't exist)\n        await collections.videoJobsCollection.createIndex({\n            jobId: 1\n        }, {\n            unique: true\n        });\n        await collections.transcriptChunksCollection.createIndex({\n            jobId: 1,\n            chunkId: 1\n        }, {\n            unique: true\n        });\n        await collections.transcriptChunksCollection.createIndex({\n            jobId: 1\n        }); // For fetching all chunks for a job\n        await collections.cachedVideoQACollection.createIndex({\n            jobId: 1,\n            questionTextNormalized: 1,\n            modelUsed: 1,\n            cacheType: 1\n        }, {\n            name: \"user_question_cache_idx\"\n        });\n        await collections.cachedVideoQACollection.createIndex({\n            jobId: 1,\n            analysisType: 1,\n            modelUsed: 1,\n            cacheType: 1\n        }, {\n            name: \"proactive_analysis_cache_idx\"\n        });\n        return db;\n    } catch (error) {\n        console.error(\"Failed to connect to MongoDB:\", error);\n        client = null; // Reset client on failure\n        db = null; // Reset db on failure\n        // Provide more specific error messages\n        if (error instanceof Error) {\n            if (error.message.includes(\"ECONNREFUSED\")) {\n                throw new Error(\"Could not connect to MongoDB server. Please check if the server is running and accessible.\");\n            } else if (error.message.includes(\"Authentication failed\")) {\n                throw new Error(\"MongoDB authentication failed. Please check your credentials.\");\n            } else if (error.message.includes(\"Invalid URI\")) {\n                throw new Error(\"Invalid MongoDB URI. Please check your connection string.\");\n            } else if (error.message.includes(\"TLS\")) {\n                throw new Error(\"TLS connection failed. Please check your SSL/TLS configuration.\");\n            }\n        }\n        throw new Error(`MongoDB connection error: ${error instanceof Error ? error.message : \"Unknown error\"}`);\n    }\n}\n// Export a function to get specific collections, ensuring DB connection\nasync function getCollections() {\n    if (!db || !client) {\n        await connectToDatabase();\n    }\n    if (!collections.videoJobsCollection || !collections.transcriptChunksCollection || !collections.cachedVideoQACollection) {\n        // This might happen if connectToDatabase was called but collections weren't set (shouldn't occur with current logic)\n        // Or if db connection was lost and re-established without re-setting collections object.\n        // For simplicity, re-run connectToDatabase which also sets collections.\n        await connectToDatabase();\n    }\n    return collections;\n}\n// --- Video Job Functions ---\nasync function createVideoJob(jobData) {\n    const { videoJobsCollection } = await getCollections();\n    if (!videoJobsCollection) throw new Error(\"videoJobsCollection not initialized\");\n    const newJob = {\n        ...jobData,\n        status: jobData.status || \"pending\",\n        createdAt: new Date(),\n        updatedAt: new Date()\n    };\n    const result = await videoJobsCollection.insertOne(newJob);\n    if (!result.insertedId) {\n        throw new Error(\"Failed to create video job.\");\n    }\n    return {\n        ...newJob,\n        _id: result.insertedId\n    };\n}\nasync function getVideoJob(jobId) {\n    const { videoJobsCollection } = await getCollections();\n    if (!videoJobsCollection) throw new Error(\"videoJobsCollection not initialized\");\n    return videoJobsCollection.findOne({\n        jobId\n    });\n}\nasync function updateVideoJob(jobId, updates) {\n    const { videoJobsCollection } = await getCollections();\n    if (!videoJobsCollection) throw new Error(\"videoJobsCollection not initialized\");\n    const result = await videoJobsCollection.updateOne({\n        jobId\n    }, {\n        $set: {\n            ...updates,\n            updatedAt: new Date()\n        }\n    });\n    return result.modifiedCount > 0;\n}\n// --- Transcript Chunk Functions ---\nasync function createTranscriptChunks(chunksData) {\n    const { transcriptChunksCollection } = await getCollections();\n    if (!transcriptChunksCollection) throw new Error(\"transcriptChunksCollection not initialized\");\n    if (chunksData.length === 0) return;\n    const chunksToInsert = chunksData.map((chunk)=>({\n            ...chunk,\n            createdAt: new Date()\n        }));\n    await transcriptChunksCollection.insertMany(chunksToInsert);\n}\nasync function getTranscriptChunks(jobId) {\n    const { transcriptChunksCollection } = await getCollections();\n    if (!transcriptChunksCollection) throw new Error(\"transcriptChunksCollection not initialized\");\n    return transcriptChunksCollection.find({\n        jobId\n    }).sort({\n        startTimestamp: 1\n    }).toArray(); // Sort by start time\n}\nasync function updateTranscriptChunkEmbeddings(jobId, chunkId, embedding) {\n    const { transcriptChunksCollection } = await getCollections();\n    if (!transcriptChunksCollection) throw new Error(\"transcriptChunksCollection not initialized\");\n    const result = await transcriptChunksCollection.updateOne({\n        jobId,\n        chunkId\n    }, {\n        $set: {\n            embedding\n        }\n    });\n    return result.modifiedCount > 0;\n}\n// --- Q&A Cache Functions ---\nasync function getCachedQAResponse(jobId, normalizedQuestionText, modelUsed) {\n    const { cachedVideoQACollection } = await getCollections();\n    if (!cachedVideoQACollection) throw new Error(\"cachedVideoQACollection not initialized\");\n    // console.log(`CACHE_LOOKUP: jobId=${jobId}, question='${normalizedQuestionText}', model='${modelUsed}'`); // Debug\n    const response = await cachedVideoQACollection.findOne({\n        jobId,\n        questionTextNormalized: normalizedQuestionText,\n        modelUsed,\n        cacheType: \"user_question\"\n    });\n    // if (response) console.log(\"CACHE_HIT\"); else console.log(\"CACHE_MISS\"); // Debug\n    return response;\n}\nasync function getCachedProactiveAnalysis(jobId, analysisType, modelUsed) {\n    const { cachedVideoQACollection } = await getCollections();\n    if (!cachedVideoQACollection) throw new Error(\"cachedVideoQACollection not initialized\");\n    return cachedVideoQACollection.findOne({\n        jobId,\n        analysisType,\n        modelUsed,\n        cacheType: \"proactive_analysis\"\n    });\n}\nasync function saveQAResponse(jobId, questionOrAnalysisType, modelUsed, responseText, cacheType = \"user_question\" // Default to user_question\n) {\n    const { cachedVideoQACollection } = await getCollections();\n    if (!cachedVideoQACollection) throw new Error(\"cachedVideoQACollection not initialized\");\n    const now = new Date();\n    let filter;\n    let updateData;\n    if (cacheType === \"user_question\") {\n        filter = {\n            jobId,\n            questionTextNormalized: questionOrAnalysisType,\n            modelUsed,\n            cacheType\n        };\n        updateData = {\n            $set: {\n                responseText,\n                updatedAt: now\n            },\n            $setOnInsert: {\n                jobId,\n                questionTextNormalized: questionOrAnalysisType,\n                modelUsed,\n                cacheType,\n                createdAt: now\n            }\n        };\n    } else {\n        filter = {\n            jobId,\n            analysisType: questionOrAnalysisType,\n            modelUsed,\n            cacheType\n        };\n        updateData = {\n            $set: {\n                responseText,\n                updatedAt: now\n            },\n            $setOnInsert: {\n                jobId,\n                analysisType: questionOrAnalysisType,\n                modelUsed,\n                cacheType,\n                createdAt: now\n            }\n        };\n    }\n    try {\n        // console.log(`CACHE_SAVE: jobId=${jobId}, key='${questionOrAnalysisType}', model='${modelUsed}', type='${cacheType}'`); // Debug\n        await cachedVideoQACollection.updateOne(filter, updateData, {\n            upsert: true\n        });\n    // console.log(\"CACHE_SAVE successful\"); // Debug\n    } catch (error) {\n        console.error(\"Error saving Q&A response to cache:\", error);\n    // Decide if this error should be propagated or just logged\n    // For async background saves, logging might be sufficient.\n    }\n}\n// Optional: Function to clear MongoDB client connection (e.g., for graceful shutdown)\nasync function closeDatabaseConnection() {\n    if (client) {\n        await client.close();\n        client = null;\n        db = null;\n        console.log(\"MongoDB connection closed.\");\n    }\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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LFNBQVM7WUFBRXBEO1lBQU9HLHdCQUF3QjhDO1lBQXdCN0M7WUFBV0M7UUFBVTtRQUN2RmdELGFBQWE7WUFDWHpCLE1BQU07Z0JBQUVzQjtnQkFBY2hDLFdBQVdpQztZQUFJO1lBQ3JDRyxjQUFjO2dCQUFFdEQ7Z0JBQU9HLHdCQUF3QjhDO2dCQUF3QjdDO2dCQUFXQztnQkFBV1csV0FBV21DO1lBQUk7UUFDOUc7SUFDRixPQUFPO1FBQ0xDLFNBQVM7WUFBRXBEO1lBQU9PLGNBQWMwQztZQUF3QjdDO1lBQVdDO1FBQVU7UUFDN0VnRCxhQUFhO1lBQ1h6QixNQUFNO2dCQUFFc0I7Z0JBQWNoQyxXQUFXaUM7WUFBSTtZQUNyQ0csY0FBYztnQkFBRXREO2dCQUFPTyxjQUFjMEM7Z0JBQXdCN0M7Z0JBQVdDO2dCQUFXVyxXQUFXbUM7WUFBSTtRQUNwRztJQUNGO0lBRUEsSUFBSTtRQUNGLGtJQUFrSTtRQUNsSSxNQUFNckQsd0JBQXdCNkIsU0FBUyxDQUFDeUIsUUFBUUMsWUFBWTtZQUFFRSxRQUFRO1FBQUs7SUFDM0UsaURBQWlEO0lBQ25ELEVBQUUsT0FBTy9DLE9BQU87UUFDZGYsUUFBUWUsS0FBSyxDQUFDLHVDQUF1Q0E7SUFDckQsMkRBQTJEO0lBQzNELDJEQUEyRDtJQUM3RDtBQUNGO0FBRUEsc0ZBQXNGO0FBQy9FLGVBQWVnRDtJQUNwQixJQUFJakYsUUFBUTtRQUNWLE1BQU1BLE9BQU9rRixLQUFLO1FBQ2xCbEYsU0FBUztRQUNUQyxLQUFLO1FBQ0xpQixRQUFRQyxHQUFHLENBQUM7SUFDZDtBQUNGIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vY2hhdHB5ZS8uL3NyYy9saWIvbW9uZ29kYi50cz81M2MyIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbGxlY3Rpb24sIERiLCBNb25nb0NsaWVudCwgU2VydmVyQXBpVmVyc2lvbiwgT2JqZWN0SWQgfSBmcm9tICdtb25nb2RiJztcclxuXHJcbi8vIERlZmluZSBpbnRlcmZhY2VzIGZvciB5b3VyIGRhdGEgc3RydWN0dXJlc1xyXG5leHBvcnQgaW50ZXJmYWNlIFZpZGVvSm9iIHtcclxuICBfaWQ/OiBPYmplY3RJZDtcclxuICBqb2JJZDogc3RyaW5nO1xyXG4gIHlvdXR1YmVVcmw6IHN0cmluZztcclxuICBzdGF0dXM6ICdwZW5kaW5nJyB8ICdwcm9jZXNzaW5nJyB8ICdjb21wbGV0ZWQnIHwgJ2ZhaWxlZCc7XHJcbiAgdHJhbnNjcmlwdFN0YXR1cz86ICdwcm9jZXNzaW5nJyB8ICdmb3VuZCcgfCAnbm90X2ZvdW5kJyB8ICdmYWlsZWQnIHwgJ2Vycm9yJztcclxuICBwcm9ncmVzcz86IHN0cmluZzsgLy8gT3B0aW9uYWwgcHJvZ3Jlc3MgbWVzc2FnZVxyXG4gIGNyZWF0ZWRBdD86IERhdGU7XHJcbiAgdXBkYXRlZEF0PzogRGF0ZTtcclxuICAvLyBZb3UgbWlnaHQgYWRkIG1vcmUgZmllbGRzIGxpa2UgdmlkZW9UaXRsZSwgZHVyYXRpb24sIGV0Yy5cclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBUcmFuc2NyaXB0Q2h1bmsge1xyXG4gIF9pZD86IE9iamVjdElkO1xyXG4gIGpvYklkOiBzdHJpbmc7XHJcbiAgY2h1bmtJZDogc3RyaW5nOyAvLyBlLmcuLCBqb2JJZC1jaHVua0luZGV4XHJcbiAgdGV4dENvbnRlbnQ6IHN0cmluZztcclxuICBzdGFydFRpbWVzdGFtcDogc3RyaW5nOyAvLyBTdG9yZSBhcyBzdHJpbmcsIGNvbnNpc3RlbnQgd2l0aCBjdXJyZW50IFJBRyB1c2VcclxuICBlbmRUaW1lc3RhbXA6IHN0cmluZzsgICAvLyBTdG9yZSBhcyBzdHJpbmdcclxuICBlbWJlZGRpbmc/OiBudW1iZXJbXTsgLy8gQXJyYXkgb2YgbnVtYmVycyBmb3IgdGhlIGVtYmVkZGluZ1xyXG4gIGNyZWF0ZWRBdD86IERhdGU7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgQ2FjaGVkUUFSZXNwb25zZSB7XHJcbiAgX2lkPzogT2JqZWN0SWQ7XHJcbiAgam9iSWQ6IHN0cmluZzsgLy8gUmVmZXJlbmNlcyB0aGUgVmlkZW9Kb2Iuam9iSWQgKGlkZW50aWZpZXMgdGhlIHZpZGVvKVxyXG4gIGNhY2hlVHlwZTogJ3VzZXJfcXVlc3Rpb24nIHwgJ3Byb2FjdGl2ZV9hbmFseXNpcyc7XHJcbiAgcXVlc3Rpb25UZXh0Tm9ybWFsaXplZD86IHN0cmluZzsgLy8gRm9yIHVzZXJfcXVlc3Rpb24gdHlwZVxyXG4gIGFuYWx5c2lzVHlwZT86IHN0cmluZzsgLy8gRm9yIHByb2FjdGl2ZV9hbmFseXNpcyB0eXBlIChlLmcuLCBcInByb2FjdGl2ZV9zdW1tYXJ5X3RvcGljc190YWtlYXdheXNcIilcclxuICByZXNwb25zZVRleHQ6IHN0cmluZztcclxuICBtb2RlbFVzZWQ6IHN0cmluZzsgLy8gZS5nLiwgXCJnZW1pbmktMS41LXByby1kaXJlY3QteW91dHViZVwiXHJcbiAgY3JlYXRlZEF0OiBEYXRlO1xyXG4gIHVwZGF0ZWRBdDogRGF0ZTsgLy8gVG8ga25vdyB3aGVuIGl0IHdhcyBsYXN0IHVwZGF0ZWQgKGZvciB1cHNlcnQpXHJcbiAgLy8gc291cmNlTGFuZ3VhZ2U/OiBzdHJpbmc7IC8vIEZ1dHVyZSB1c2VcclxuICAvLyBzdHJ1Y3R1cmVkUmVzcG9uc2VEYXRhPzogYW55OyAvLyBGdXR1cmUgdXNlIGZvciBzdHJ1Y3R1cmVkIHByb2FjdGl2ZSBhbmFseXNpc1xyXG59XHJcblxyXG5jb25zdCBNT05HT0RCX1VSSSA9IHByb2Nlc3MuZW52Lk1PTkdPREJfVVJJO1xyXG5jb25zdCBNT05HT0RCX0RCX05BTUUgPSBwcm9jZXNzLmVudi5NT05HT0RCX0RCX05BTUUgfHwgJ2NoYXRweWVfZGInOyAvLyBEZWZhdWx0IERCIG5hbWVcclxuXHJcbmlmICghTU9OR09EQl9VUkkpIHtcclxuICB0aHJvdyBuZXcgRXJyb3IoJ1BsZWFzZSBkZWZpbmUgdGhlIE1PTkdPREJfVVJJIGVudmlyb25tZW50IHZhcmlhYmxlIGluIC5lbnYubG9jYWwnKTtcclxufVxyXG5cclxubGV0IGNsaWVudDogTW9uZ29DbGllbnQgfCBudWxsID0gbnVsbDtcclxubGV0IGRiOiBEYiB8IG51bGwgPSBudWxsO1xyXG5cclxuaW50ZXJmYWNlIENvbGxlY3Rpb25zIHtcclxuICB2aWRlb0pvYnNDb2xsZWN0aW9uPzogQ29sbGVjdGlvbjxWaWRlb0pvYj47XHJcbiAgdHJhbnNjcmlwdENodW5rc0NvbGxlY3Rpb24/OiBDb2xsZWN0aW9uPFRyYW5zY3JpcHRDaHVuaz47XHJcbiAgY2FjaGVkVmlkZW9RQUNvbGxlY3Rpb24/OiBDb2xsZWN0aW9uPENhY2hlZFFBUmVzcG9uc2U+O1xyXG59XHJcblxyXG5jb25zdCBjb2xsZWN0aW9uczogQ29sbGVjdGlvbnMgPSB7fTtcclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjb25uZWN0VG9EYXRhYmFzZSgpOiBQcm9taXNlPERiPiB7XHJcbiAgaWYgKGRiICYmIGNsaWVudCkge1xyXG4gICAgLy8gVE9ETzogVmVyaWZ5IGNsaWVudCBjb25uZWN0aW9uIHN0YXRlIGlmIHBvc3NpYmxlLCBlLmcuIGNsaWVudC5pc0Nvbm5lY3RlZCgpXHJcbiAgICAvLyBGb3Igc2VydmVybGVzcywgY3JlYXRpbmcgbmV3IGNvbm5lY3Rpb25zIHBlciByZXF1ZXN0IG9yIHNob3J0LWxpdmVkIGNvbm5lY3Rpb25zIG1pZ2h0IGJlIG9rYXkuXHJcbiAgICAvLyBGb3IgbG9uZy1ydW5uaW5nIHNlcnZlcnMsIG1haW50YWluaW5nIGEgcGVyc2lzdGVudCBjb25uZWN0aW9uIGlzIGJldHRlci5cclxuICAgIC8vIFRoaXMgc2ltcGxlIGNoZWNrIGFzc3VtZXMgY2xpZW50IHJlbWFpbnMgY29ubmVjdGVkLlxyXG4gICAgcmV0dXJuIGRiO1xyXG4gIH1cclxuXHJcbiAgaWYgKCFNT05HT0RCX1VSSSkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdNb25nb0RCIFVSSSBpcyBub3QgZGVmaW5lZC4nKTtcclxuICB9XHJcblxyXG4gIGNsaWVudCA9IG5ldyBNb25nb0NsaWVudChNT05HT0RCX1VSSSwge1xyXG4gICAgc2VydmVyQXBpOiBTZXJ2ZXJBcGlWZXJzaW9uLnYxLFxyXG4gICAgdGxzOiB0cnVlLFxyXG4gICAgdGxzQWxsb3dJbnZhbGlkQ2VydGlmaWNhdGVzOiB0cnVlLCAvLyBBbGxvdyBpbnZhbGlkIGNlcnRpZmljYXRlcyBpbiBkZXZlbG9wbWVudFxyXG4gICAgdGxzQWxsb3dJbnZhbGlkSG9zdG5hbWVzOiB0cnVlLCAgICAvLyBBbGxvdyBpbnZhbGlkIGhvc3RuYW1lcyBpbiBkZXZlbG9wbWVudFxyXG4gICAgbWF4UG9vbFNpemU6IDUwLFxyXG4gICAgbWluUG9vbFNpemU6IDEwLFxyXG4gICAgbWF4SWRsZVRpbWVNUzogNjAwMDAsXHJcbiAgICBjb25uZWN0VGltZW91dE1TOiAzMDAwMCxcclxuICAgIHNvY2tldFRpbWVvdXRNUzogNDUwMDAsXHJcbiAgICByZXRyeVdyaXRlczogdHJ1ZSxcclxuICAgIHJldHJ5UmVhZHM6IHRydWUsXHJcbiAgICBkaXJlY3RDb25uZWN0aW9uOiBmYWxzZVxyXG4gIH0pO1xyXG5cclxuICB0cnkge1xyXG4gICAgYXdhaXQgY2xpZW50LmNvbm5lY3QoKTtcclxuICAgIGRiID0gY2xpZW50LmRiKE1PTkdPREJfREJfTkFNRSk7XHJcbiAgICBjb25zb2xlLmxvZygnU3VjY2Vzc2Z1bGx5IGNvbm5lY3RlZCB0byBNb25nb0RCLicpO1xyXG5cclxuICAgIC8vIEluaXRpYWxpemUgY29sbGVjdGlvbnNcclxuICAgIGNvbGxlY3Rpb25zLnZpZGVvSm9ic0NvbGxlY3Rpb24gPSBkYi5jb2xsZWN0aW9uPFZpZGVvSm9iPigndmlkZW9Kb2JzJyk7XHJcbiAgICBjb2xsZWN0aW9ucy50cmFuc2NyaXB0Q2h1bmtzQ29sbGVjdGlvbiA9IGRiLmNvbGxlY3Rpb248VHJhbnNjcmlwdENodW5rPigndHJhbnNjcmlwdENodW5rcycpO1xyXG4gICAgY29sbGVjdGlvbnMuY2FjaGVkVmlkZW9RQUNvbGxlY3Rpb24gPSBkYi5jb2xsZWN0aW9uPENhY2hlZFFBUmVzcG9uc2U+KCdjYWNoZWRWaWRlb1FBJyk7XHJcbiAgICBcclxuICAgIC8vIENyZWF0ZSBJbmRleGVzIChpZGVtcG90ZW50IC0gb25seSBjcmVhdGVzIGlmIHRoZXkgZG9uJ3QgZXhpc3QpXHJcbiAgICBhd2FpdCBjb2xsZWN0aW9ucy52aWRlb0pvYnNDb2xsZWN0aW9uLmNyZWF0ZUluZGV4KHsgam9iSWQ6IDEgfSwgeyB1bmlxdWU6IHRydWUgfSk7XHJcbiAgICBhd2FpdCBjb2xsZWN0aW9ucy50cmFuc2NyaXB0Q2h1bmtzQ29sbGVjdGlvbi5jcmVhdGVJbmRleCh7IGpvYklkOiAxLCBjaHVua0lkOiAxIH0sIHsgdW5pcXVlOiB0cnVlIH0pO1xyXG4gICAgYXdhaXQgY29sbGVjdGlvbnMudHJhbnNjcmlwdENodW5rc0NvbGxlY3Rpb24uY3JlYXRlSW5kZXgoeyBqb2JJZDogMSB9KTsgLy8gRm9yIGZldGNoaW5nIGFsbCBjaHVua3MgZm9yIGEgam9iXHJcbiAgICBhd2FpdCBjb2xsZWN0aW9ucy5jYWNoZWRWaWRlb1FBQ29sbGVjdGlvbi5jcmVhdGVJbmRleChcclxuICAgICAgICB7IGpvYklkOiAxLCBxdWVzdGlvblRleHROb3JtYWxpemVkOiAxLCBtb2RlbFVzZWQ6IDEsIGNhY2hlVHlwZTogMSB9LFxyXG4gICAgICAgIHsgbmFtZTogXCJ1c2VyX3F1ZXN0aW9uX2NhY2hlX2lkeFwiIH1cclxuICAgICk7XHJcbiAgICBhd2FpdCBjb2xsZWN0aW9ucy5jYWNoZWRWaWRlb1FBQ29sbGVjdGlvbi5jcmVhdGVJbmRleChcclxuICAgICAgICB7IGpvYklkOiAxLCBhbmFseXNpc1R5cGU6IDEsIG1vZGVsVXNlZDogMSwgY2FjaGVUeXBlOiAxIH0sXHJcbiAgICAgICAgeyBuYW1lOiBcInByb2FjdGl2ZV9hbmFseXNpc19jYWNoZV9pZHhcIiB9XHJcbiAgICApO1xyXG5cclxuICAgIHJldHVybiBkYjtcclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGNvbm5lY3QgdG8gTW9uZ29EQjonLCBlcnJvcik7XHJcbiAgICBjbGllbnQgPSBudWxsOyAvLyBSZXNldCBjbGllbnQgb24gZmFpbHVyZVxyXG4gICAgZGIgPSBudWxsOyAgICAgLy8gUmVzZXQgZGIgb24gZmFpbHVyZVxyXG4gICAgXHJcbiAgICAvLyBQcm92aWRlIG1vcmUgc3BlY2lmaWMgZXJyb3IgbWVzc2FnZXNcclxuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKSB7XHJcbiAgICAgIGlmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCdFQ09OTlJFRlVTRUQnKSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IGNvbm5lY3QgdG8gTW9uZ29EQiBzZXJ2ZXIuIFBsZWFzZSBjaGVjayBpZiB0aGUgc2VydmVyIGlzIHJ1bm5pbmcgYW5kIGFjY2Vzc2libGUuJyk7XHJcbiAgICAgIH0gZWxzZSBpZiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnQXV0aGVudGljYXRpb24gZmFpbGVkJykpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ01vbmdvREIgYXV0aGVudGljYXRpb24gZmFpbGVkLiBQbGVhc2UgY2hlY2sgeW91ciBjcmVkZW50aWFscy4nKTtcclxuICAgICAgfSBlbHNlIGlmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCdJbnZhbGlkIFVSSScpKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIE1vbmdvREIgVVJJLiBQbGVhc2UgY2hlY2sgeW91ciBjb25uZWN0aW9uIHN0cmluZy4nKTtcclxuICAgICAgfSBlbHNlIGlmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCdUTFMnKSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcignVExTIGNvbm5lY3Rpb24gZmFpbGVkLiBQbGVhc2UgY2hlY2sgeW91ciBTU0wvVExTIGNvbmZpZ3VyYXRpb24uJyk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHRocm93IG5ldyBFcnJvcihgTW9uZ29EQiBjb25uZWN0aW9uIGVycm9yOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InfWApO1xyXG4gIH1cclxufVxyXG5cclxuLy8gRXhwb3J0IGEgZnVuY3Rpb24gdG8gZ2V0IHNwZWNpZmljIGNvbGxlY3Rpb25zLCBlbnN1cmluZyBEQiBjb25uZWN0aW9uXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRDb2xsZWN0aW9ucygpOiBQcm9taXNlPENvbGxlY3Rpb25zPiB7XHJcbiAgaWYgKCFkYiB8fCAhY2xpZW50KSB7IC8vIE9yIGFkZCBtb3JlIHJvYnVzdCBjb25uZWN0aW9uIGNoZWNrXHJcbiAgICBhd2FpdCBjb25uZWN0VG9EYXRhYmFzZSgpO1xyXG4gIH1cclxuICBpZiAoIWNvbGxlY3Rpb25zLnZpZGVvSm9ic0NvbGxlY3Rpb24gfHwgIWNvbGxlY3Rpb25zLnRyYW5zY3JpcHRDaHVua3NDb2xsZWN0aW9uIHx8ICFjb2xsZWN0aW9ucy5jYWNoZWRWaWRlb1FBQ29sbGVjdGlvbikge1xyXG4gICAgLy8gVGhpcyBtaWdodCBoYXBwZW4gaWYgY29ubmVjdFRvRGF0YWJhc2Ugd2FzIGNhbGxlZCBidXQgY29sbGVjdGlvbnMgd2VyZW4ndCBzZXQgKHNob3VsZG4ndCBvY2N1ciB3aXRoIGN1cnJlbnQgbG9naWMpXHJcbiAgICAvLyBPciBpZiBkYiBjb25uZWN0aW9uIHdhcyBsb3N0IGFuZCByZS1lc3RhYmxpc2hlZCB3aXRob3V0IHJlLXNldHRpbmcgY29sbGVjdGlvbnMgb2JqZWN0LlxyXG4gICAgLy8gRm9yIHNpbXBsaWNpdHksIHJlLXJ1biBjb25uZWN0VG9EYXRhYmFzZSB3aGljaCBhbHNvIHNldHMgY29sbGVjdGlvbnMuXHJcbiAgICBhd2FpdCBjb25uZWN0VG9EYXRhYmFzZSgpO1xyXG4gIH1cclxuICByZXR1cm4gY29sbGVjdGlvbnM7XHJcbn1cclxuXHJcbi8vIC0tLSBWaWRlbyBKb2IgRnVuY3Rpb25zIC0tLVxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlVmlkZW9Kb2Ioam9iRGF0YTogT21pdDxWaWRlb0pvYiwgJ19pZCcgfCAnY3JlYXRlZEF0JyB8ICd1cGRhdGVkQXQnPik6IFByb21pc2U8VmlkZW9Kb2I+IHtcclxuICBjb25zdCB7IHZpZGVvSm9ic0NvbGxlY3Rpb24gfSA9IGF3YWl0IGdldENvbGxlY3Rpb25zKCk7XHJcbiAgaWYgKCF2aWRlb0pvYnNDb2xsZWN0aW9uKSB0aHJvdyBuZXcgRXJyb3IoXCJ2aWRlb0pvYnNDb2xsZWN0aW9uIG5vdCBpbml0aWFsaXplZFwiKTtcclxuXHJcbiAgY29uc3QgbmV3Sm9iOiBWaWRlb0pvYiA9IHtcclxuICAgIC4uLmpvYkRhdGEsXHJcbiAgICBzdGF0dXM6IGpvYkRhdGEuc3RhdHVzIHx8ICdwZW5kaW5nJyxcclxuICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcclxuICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKSxcclxuICB9O1xyXG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHZpZGVvSm9ic0NvbGxlY3Rpb24uaW5zZXJ0T25lKG5ld0pvYik7XHJcbiAgaWYgKCFyZXN1bHQuaW5zZXJ0ZWRJZCkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gY3JlYXRlIHZpZGVvIGpvYi4nKTtcclxuICB9XHJcbiAgcmV0dXJuIHsgLi4ubmV3Sm9iLCBfaWQ6IHJlc3VsdC5pbnNlcnRlZElkIH07XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRWaWRlb0pvYihqb2JJZDogc3RyaW5nKTogUHJvbWlzZTxWaWRlb0pvYiB8IG51bGw+IHtcclxuICBjb25zdCB7IHZpZGVvSm9ic0NvbGxlY3Rpb24gfSA9IGF3YWl0IGdldENvbGxlY3Rpb25zKCk7XHJcbiAgaWYgKCF2aWRlb0pvYnNDb2xsZWN0aW9uKSB0aHJvdyBuZXcgRXJyb3IoXCJ2aWRlb0pvYnNDb2xsZWN0aW9uIG5vdCBpbml0aWFsaXplZFwiKTtcclxuICByZXR1cm4gdmlkZW9Kb2JzQ29sbGVjdGlvbi5maW5kT25lKHsgam9iSWQgfSk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB1cGRhdGVWaWRlb0pvYihqb2JJZDogc3RyaW5nLCB1cGRhdGVzOiBQYXJ0aWFsPFZpZGVvSm9iPik6IFByb21pc2U8Ym9vbGVhbj4ge1xyXG4gIGNvbnN0IHsgdmlkZW9Kb2JzQ29sbGVjdGlvbiB9ID0gYXdhaXQgZ2V0Q29sbGVjdGlvbnMoKTtcclxuICBpZiAoIXZpZGVvSm9ic0NvbGxlY3Rpb24pIHRocm93IG5ldyBFcnJvcihcInZpZGVvSm9ic0NvbGxlY3Rpb24gbm90IGluaXRpYWxpemVkXCIpO1xyXG5cclxuICBjb25zdCByZXN1bHQgPSBhd2FpdCB2aWRlb0pvYnNDb2xsZWN0aW9uLnVwZGF0ZU9uZShcclxuICAgIHsgam9iSWQgfSxcclxuICAgIHsgJHNldDogeyAuLi51cGRhdGVzLCB1cGRhdGVkQXQ6IG5ldyBEYXRlKCkgfSB9XHJcbiAgKTtcclxuICByZXR1cm4gcmVzdWx0Lm1vZGlmaWVkQ291bnQgPiAwO1xyXG59XHJcblxyXG4vLyAtLS0gVHJhbnNjcmlwdCBDaHVuayBGdW5jdGlvbnMgLS0tXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVUcmFuc2NyaXB0Q2h1bmtzKGNodW5rc0RhdGE6IFRyYW5zY3JpcHRDaHVua1tdKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgY29uc3QgeyB0cmFuc2NyaXB0Q2h1bmtzQ29sbGVjdGlvbiB9ID0gYXdhaXQgZ2V0Q29sbGVjdGlvbnMoKTtcclxuICBpZiAoIXRyYW5zY3JpcHRDaHVua3NDb2xsZWN0aW9uKSB0aHJvdyBuZXcgRXJyb3IoXCJ0cmFuc2NyaXB0Q2h1bmtzQ29sbGVjdGlvbiBub3QgaW5pdGlhbGl6ZWRcIik7XHJcbiAgaWYgKGNodW5rc0RhdGEubGVuZ3RoID09PSAwKSByZXR1cm47XHJcblxyXG4gIGNvbnN0IGNodW5rc1RvSW5zZXJ0ID0gY2h1bmtzRGF0YS5tYXAoY2h1bmsgPT4gKHtcclxuICAgICAgLi4uY2h1bmssXHJcbiAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKVxyXG4gIH0pKTtcclxuICBhd2FpdCB0cmFuc2NyaXB0Q2h1bmtzQ29sbGVjdGlvbi5pbnNlcnRNYW55KGNodW5rc1RvSW5zZXJ0KTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFRyYW5zY3JpcHRDaHVua3Moam9iSWQ6IHN0cmluZyk6IFByb21pc2U8VHJhbnNjcmlwdENodW5rW10+IHtcclxuICBjb25zdCB7IHRyYW5zY3JpcHRDaHVua3NDb2xsZWN0aW9uIH0gPSBhd2FpdCBnZXRDb2xsZWN0aW9ucygpO1xyXG4gIGlmICghdHJhbnNjcmlwdENodW5rc0NvbGxlY3Rpb24pIHRocm93IG5ldyBFcnJvcihcInRyYW5zY3JpcHRDaHVua3NDb2xsZWN0aW9uIG5vdCBpbml0aWFsaXplZFwiKTtcclxuICByZXR1cm4gdHJhbnNjcmlwdENodW5rc0NvbGxlY3Rpb24uZmluZCh7IGpvYklkIH0pLnNvcnQoeyBzdGFydFRpbWVzdGFtcDogMSB9KS50b0FycmF5KCk7IC8vIFNvcnQgYnkgc3RhcnQgdGltZVxyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXBkYXRlVHJhbnNjcmlwdENodW5rRW1iZWRkaW5ncyhqb2JJZDogc3RyaW5nLCBjaHVua0lkOiBzdHJpbmcsIGVtYmVkZGluZzogbnVtYmVyW10pOiBQcm9taXNlPGJvb2xlYW4+IHtcclxuICAgIGNvbnN0IHsgdHJhbnNjcmlwdENodW5rc0NvbGxlY3Rpb24gfSA9IGF3YWl0IGdldENvbGxlY3Rpb25zKCk7XHJcbiAgICBpZiAoIXRyYW5zY3JpcHRDaHVua3NDb2xsZWN0aW9uKSB0aHJvdyBuZXcgRXJyb3IoXCJ0cmFuc2NyaXB0Q2h1bmtzQ29sbGVjdGlvbiBub3QgaW5pdGlhbGl6ZWRcIik7XHJcblxyXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdHJhbnNjcmlwdENodW5rc0NvbGxlY3Rpb24udXBkYXRlT25lKFxyXG4gICAgICAgIHsgam9iSWQsIGNodW5rSWQgfSxcclxuICAgICAgICB7ICRzZXQ6IHsgZW1iZWRkaW5nIH0gfVxyXG4gICAgKTtcclxuICAgIHJldHVybiByZXN1bHQubW9kaWZpZWRDb3VudCA+IDA7XHJcbn1cclxuXHJcbi8vIC0tLSBRJkEgQ2FjaGUgRnVuY3Rpb25zIC0tLVxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0Q2FjaGVkUUFSZXNwb25zZShcclxuICBqb2JJZDogc3RyaW5nLCBcclxuICBub3JtYWxpemVkUXVlc3Rpb25UZXh0OiBzdHJpbmcsIFxyXG4gIG1vZGVsVXNlZDogc3RyaW5nXHJcbik6IFByb21pc2U8Q2FjaGVkUUFSZXNwb25zZSB8IG51bGw+IHtcclxuICBjb25zdCB7IGNhY2hlZFZpZGVvUUFDb2xsZWN0aW9uIH0gPSBhd2FpdCBnZXRDb2xsZWN0aW9ucygpO1xyXG4gIGlmICghY2FjaGVkVmlkZW9RQUNvbGxlY3Rpb24pIHRocm93IG5ldyBFcnJvcihcImNhY2hlZFZpZGVvUUFDb2xsZWN0aW9uIG5vdCBpbml0aWFsaXplZFwiKTtcclxuICBcclxuICAvLyBjb25zb2xlLmxvZyhgQ0FDSEVfTE9PS1VQOiBqb2JJZD0ke2pvYklkfSwgcXVlc3Rpb249JyR7bm9ybWFsaXplZFF1ZXN0aW9uVGV4dH0nLCBtb2RlbD0nJHttb2RlbFVzZWR9J2ApOyAvLyBEZWJ1Z1xyXG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgY2FjaGVkVmlkZW9RQUNvbGxlY3Rpb24uZmluZE9uZSh7XHJcbiAgICBqb2JJZCxcclxuICAgIHF1ZXN0aW9uVGV4dE5vcm1hbGl6ZWQ6IG5vcm1hbGl6ZWRRdWVzdGlvblRleHQsIC8vIEVuc3VyZSB0aGlzIG1hdGNoZXMgdGhlIGZpZWxkIG5hbWUgdXNlZCBpbiBzYXZlUUFSZXNwb25zZVxyXG4gICAgbW9kZWxVc2VkLFxyXG4gICAgY2FjaGVUeXBlOiAndXNlcl9xdWVzdGlvbidcclxuICB9KTtcclxuICAvLyBpZiAocmVzcG9uc2UpIGNvbnNvbGUubG9nKFwiQ0FDSEVfSElUXCIpOyBlbHNlIGNvbnNvbGUubG9nKFwiQ0FDSEVfTUlTU1wiKTsgLy8gRGVidWdcclxuICByZXR1cm4gcmVzcG9uc2U7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRDYWNoZWRQcm9hY3RpdmVBbmFseXNpcyhcclxuICBqb2JJZDogc3RyaW5nLFxyXG4gIGFuYWx5c2lzVHlwZTogc3RyaW5nLFxyXG4gIG1vZGVsVXNlZDogc3RyaW5nXHJcbik6IFByb21pc2U8Q2FjaGVkUUFSZXNwb25zZSB8IG51bGw+IHtcclxuICBjb25zdCB7IGNhY2hlZFZpZGVvUUFDb2xsZWN0aW9uIH0gPSBhd2FpdCBnZXRDb2xsZWN0aW9ucygpO1xyXG4gIGlmICghY2FjaGVkVmlkZW9RQUNvbGxlY3Rpb24pIHRocm93IG5ldyBFcnJvcihcImNhY2hlZFZpZGVvUUFDb2xsZWN0aW9uIG5vdCBpbml0aWFsaXplZFwiKTtcclxuICByZXR1cm4gY2FjaGVkVmlkZW9RQUNvbGxlY3Rpb24uZmluZE9uZSh7XHJcbiAgICBqb2JJZCxcclxuICAgIGFuYWx5c2lzVHlwZSxcclxuICAgIG1vZGVsVXNlZCxcclxuICAgIGNhY2hlVHlwZTogJ3Byb2FjdGl2ZV9hbmFseXNpcydcclxuICB9KTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNhdmVRQVJlc3BvbnNlKFxyXG4gIGpvYklkOiBzdHJpbmcsIFxyXG4gIHF1ZXN0aW9uT3JBbmFseXNpc1R5cGU6IHN0cmluZywgLy8gRm9yIHVzZXJfcXVlc3Rpb24sIHRoaXMgaXMgbm9ybWFsaXplZFF1ZXN0aW9uVGV4dDsgZm9yIHByb2FjdGl2ZSwgaXQncyBhbmFseXNpc1R5cGVcclxuICBtb2RlbFVzZWQ6IHN0cmluZywgXHJcbiAgcmVzcG9uc2VUZXh0OiBzdHJpbmcsXHJcbiAgY2FjaGVUeXBlOiAndXNlcl9xdWVzdGlvbicgfCAncHJvYWN0aXZlX2FuYWx5c2lzJyA9ICd1c2VyX3F1ZXN0aW9uJyAvLyBEZWZhdWx0IHRvIHVzZXJfcXVlc3Rpb25cclxuKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgY29uc3QgeyBjYWNoZWRWaWRlb1FBQ29sbGVjdGlvbiB9ID0gYXdhaXQgZ2V0Q29sbGVjdGlvbnMoKTtcclxuICBpZiAoIWNhY2hlZFZpZGVvUUFDb2xsZWN0aW9uKSB0aHJvdyBuZXcgRXJyb3IoXCJjYWNoZWRWaWRlb1FBQ29sbGVjdGlvbiBub3QgaW5pdGlhbGl6ZWRcIik7XHJcblxyXG4gIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XHJcbiAgbGV0IGZpbHRlcjogYW55O1xyXG4gIGxldCB1cGRhdGVEYXRhOiBhbnk7XHJcblxyXG4gIGlmIChjYWNoZVR5cGUgPT09ICd1c2VyX3F1ZXN0aW9uJykge1xyXG4gICAgZmlsdGVyID0geyBqb2JJZCwgcXVlc3Rpb25UZXh0Tm9ybWFsaXplZDogcXVlc3Rpb25PckFuYWx5c2lzVHlwZSwgbW9kZWxVc2VkLCBjYWNoZVR5cGUgfTtcclxuICAgIHVwZGF0ZURhdGEgPSB7XHJcbiAgICAgICRzZXQ6IHsgcmVzcG9uc2VUZXh0LCB1cGRhdGVkQXQ6IG5vdyB9LFxyXG4gICAgICAkc2V0T25JbnNlcnQ6IHsgam9iSWQsIHF1ZXN0aW9uVGV4dE5vcm1hbGl6ZWQ6IHF1ZXN0aW9uT3JBbmFseXNpc1R5cGUsIG1vZGVsVXNlZCwgY2FjaGVUeXBlLCBjcmVhdGVkQXQ6IG5vdyB9XHJcbiAgICB9O1xyXG4gIH0gZWxzZSB7IC8vIHByb2FjdGl2ZV9hbmFseXNpc1xyXG4gICAgZmlsdGVyID0geyBqb2JJZCwgYW5hbHlzaXNUeXBlOiBxdWVzdGlvbk9yQW5hbHlzaXNUeXBlLCBtb2RlbFVzZWQsIGNhY2hlVHlwZSB9O1xyXG4gICAgdXBkYXRlRGF0YSA9IHtcclxuICAgICAgJHNldDogeyByZXNwb25zZVRleHQsIHVwZGF0ZWRBdDogbm93IH0sXHJcbiAgICAgICRzZXRPbkluc2VydDogeyBqb2JJZCwgYW5hbHlzaXNUeXBlOiBxdWVzdGlvbk9yQW5hbHlzaXNUeXBlLCBtb2RlbFVzZWQsIGNhY2hlVHlwZSwgY3JlYXRlZEF0OiBub3cgfVxyXG4gICAgfTtcclxuICB9XHJcbiAgXHJcbiAgdHJ5IHtcclxuICAgIC8vIGNvbnNvbGUubG9nKGBDQUNIRV9TQVZFOiBqb2JJZD0ke2pvYklkfSwga2V5PScke3F1ZXN0aW9uT3JBbmFseXNpc1R5cGV9JywgbW9kZWw9JyR7bW9kZWxVc2VkfScsIHR5cGU9JyR7Y2FjaGVUeXBlfSdgKTsgLy8gRGVidWdcclxuICAgIGF3YWl0IGNhY2hlZFZpZGVvUUFDb2xsZWN0aW9uLnVwZGF0ZU9uZShmaWx0ZXIsIHVwZGF0ZURhdGEsIHsgdXBzZXJ0OiB0cnVlIH0pO1xyXG4gICAgLy8gY29uc29sZS5sb2coXCJDQUNIRV9TQVZFIHN1Y2Nlc3NmdWxcIik7IC8vIERlYnVnXHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBzYXZpbmcgUSZBIHJlc3BvbnNlIHRvIGNhY2hlOlwiLCBlcnJvcik7XHJcbiAgICAvLyBEZWNpZGUgaWYgdGhpcyBlcnJvciBzaG91bGQgYmUgcHJvcGFnYXRlZCBvciBqdXN0IGxvZ2dlZFxyXG4gICAgLy8gRm9yIGFzeW5jIGJhY2tncm91bmQgc2F2ZXMsIGxvZ2dpbmcgbWlnaHQgYmUgc3VmZmljaWVudC5cclxuICB9XHJcbn1cclxuXHJcbi8vIE9wdGlvbmFsOiBGdW5jdGlvbiB0byBjbGVhciBNb25nb0RCIGNsaWVudCBjb25uZWN0aW9uIChlLmcuLCBmb3IgZ3JhY2VmdWwgc2h1dGRvd24pXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjbG9zZURhdGFiYXNlQ29ubmVjdGlvbigpOiBQcm9taXNlPHZvaWQ+IHtcclxuICBpZiAoY2xpZW50KSB7XHJcbiAgICBhd2FpdCBjbGllbnQuY2xvc2UoKTtcclxuICAgIGNsaWVudCA9IG51bGw7XHJcbiAgICBkYiA9IG51bGw7XHJcbiAgICBjb25zb2xlLmxvZygnTW9uZ29EQiBjb25uZWN0aW9uIGNsb3NlZC4nKTtcclxuICB9XHJcbn0gIl0sIm5hbWVzIjpbIk1vbmdvQ2xpZW50IiwiU2VydmVyQXBpVmVyc2lvbiIsIk1PTkdPREJfVVJJIiwicHJvY2VzcyIsImVudiIsIk1PTkdPREJfREJfTkFNRSIsIkVycm9yIiwiY2xpZW50IiwiZGIiLCJjb2xsZWN0aW9ucyIsImNvbm5lY3RUb0RhdGFiYXNlIiwic2VydmVyQXBpIiwidjEiLCJ0bHMiLCJ0bHNBbGxvd0ludmFsaWRDZXJ0aWZpY2F0ZXMiLCJ0bHNBbGxvd0ludmFsaWRIb3N0bmFtZXMiLCJtYXhQb29sU2l6ZSIsIm1pblBvb2xTaXplIiwibWF4SWRsZVRpbWVNUyIsImNvbm5lY3RUaW1lb3V0TVMiLCJzb2NrZXRUaW1lb3V0TVMiLCJyZXRyeVdyaXRlcyIsInJldHJ5UmVhZHMiLCJkaXJlY3RDb25uZWN0aW9uIiwiY29ubmVjdCIsImNvbnNvbGUiLCJsb2ciLCJ2aWRlb0pvYnNDb2xsZWN0aW9uIiwiY29sbGVjdGlvbiIsInRyYW5zY3JpcHRDaHVua3NDb2xsZWN0aW9uIiwiY2FjaGVkVmlkZW9RQUNvbGxlY3Rpb24iLCJjcmVhdGVJbmRleCIsImpvYklkIiwidW5pcXVlIiwiY2h1bmtJZCIsInF1ZXN0aW9uVGV4dE5vcm1hbGl6ZWQiLCJtb2RlbFVzZWQiLCJjYWNoZVR5cGUiLCJuYW1lIiwiYW5hbHlzaXNUeXBlIiwiZXJyb3IiLCJtZXNzYWdlIiwiaW5jbHVkZXMiLCJnZXRDb2xsZWN0aW9ucyIsImNyZWF0ZVZpZGVvSm9iIiwiam9iRGF0YSIsIm5ld0pvYiIsInN0YXR1cyIsImNyZWF0ZWRBdCIsIkRhdGUiLCJ1cGRhdGVkQXQiLCJyZXN1bHQiLCJpbnNlcnRPbmUiLCJpbnNlcnRlZElkIiwiX2lkIiwiZ2V0VmlkZW9Kb2IiLCJmaW5kT25lIiwidXBkYXRlVmlkZW9Kb2IiLCJ1cGRhdGVzIiwidXBkYXRlT25lIiwiJHNldCIsIm1vZGlmaWVkQ291bnQiLCJjcmVhdGVUcmFuc2NyaXB0Q2h1bmtzIiwiY2h1bmtzRGF0YSIsImxlbmd0aCIsImNodW5rc1RvSW5zZXJ0IiwibWFwIiwiY2h1bmsiLCJpbnNlcnRNYW55IiwiZ2V0VHJhbnNjcmlwdENodW5rcyIsImZpbmQiLCJzb3J0Iiwic3RhcnRUaW1lc3RhbXAiLCJ0b0FycmF5IiwidXBkYXRlVHJhbnNjcmlwdENodW5rRW1iZWRkaW5ncyIsImVtYmVkZGluZyIsImdldENhY2hlZFFBUmVzcG9uc2UiLCJub3JtYWxpemVkUXVlc3Rpb25UZXh0IiwicmVzcG9uc2UiLCJnZXRDYWNoZWRQcm9hY3RpdmVBbmFseXNpcyIsInNhdmVRQVJlc3BvbnNlIiwicXVlc3Rpb25PckFuYWx5c2lzVHlwZSIsInJlc3BvbnNlVGV4dCIsIm5vdyIsImZpbHRlciIsInVwZGF0ZURhdGEiLCIkc2V0T25JbnNlcnQiLCJ1cHNlcnQiLCJjbG9zZURhdGFiYXNlQ29ubmVjdGlvbiIsImNsb3NlIl0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(rsc)/./src/lib/mongodb.ts\n");

/***/ }),

/***/ "(rsc)/./src/lib/openai.ts":
/*!***************************!*\
  !*** ./src/lib/openai.ts ***!
  \***************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   OpenAIService: () => (/* binding */ OpenAIService),\n/* harmony export */   openAIService: () => (/* binding */ openAIService)\n/* harmony export */ });\n/* harmony import */ var openai__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! openai */ \"(rsc)/./node_modules/openai/index.mjs\");\n\n// Environment variable check\nif (!process.env.OPENAI_API_KEY) {\n    console.warn(\"Warning: OPENAI_API_KEY environment variable is not set. OpenAIService will fail if instantiated and used.\");\n}\nclass OpenAIService {\n    constructor(model = \"gpt-3.5-turbo\"){\n        if (!process.env.OPENAI_API_KEY) {\n            throw new Error(\"CRITICAL: OpenAIService cannot be instantiated without OPENAI_API_KEY.\");\n        }\n        this.openai = new openai__WEBPACK_IMPORTED_MODULE_0__[\"default\"]({\n            apiKey: process.env.OPENAI_API_KEY\n        });\n        this.model = model;\n    }\n    async generateAnswer(context, question) {\n        console.log(\"OpenAI: Generating answer for question:\", question.substring(0, 50) + \"...\");\n        const contextString = context.map((c)=>`[${c.startTimestamp}s - ${c.endTimestamp}s] ${c.text}`).join(\"\\n\\n\"); // Using double newline for better separation in prompt\n        // System message defining the persona and general instructions\n        const systemMessageContent = `You are ChatPye, an AI-powered video learning companion. Your primary goal is to provide intelligent, insightful, and helpful answers based on the provided transcript of a video.\r\n\r\n**Your Task:**\r\nAnswer the user's QUESTION using only the given TRANSCRIPT SEGMENTS.\r\n\r\n**Key Instructions:**\r\n1.  **Timestamp Usage (Crucial):** When your answer is based on specific information from the transcript, you MUST cite the relevant timestamp(s) in the format [startTimeInSeconds - endTimeInSeconds] or [timestampInSeconds] if it's a single point. Integrate these timestamps naturally into your response. For example: \"The speaker mentions a key concept at [123s - 128s].\"\r\n2.  **Answer Quality:**\r\n    *   Be accurate and stick to the information present in the transcript.\r\n    *   Provide comprehensive yet concise answers.\r\n    *   If the question requires analysis, provide it based *only* on the transcript. Do not infer outside information.\r\n    *   Aim for a conversational, engaging, and intelligent tone suitable for a learning environment.\r\n3.  **Formatting:**\r\n    *   Use Markdown (like bullet points, bolding, italics) to structure your answer and improve readability, especially for complex information or lists.\r\n4.  **Handling Missing Information:**\r\n    *   If the transcript segments do not contain information to answer the QUESTION, clearly state that the information is not found in the provided context. Do not try to answer from external knowledge.`;\n        // User message providing the specific context and question\n        const userMessageContent = `TRANSCRIPT SEGMENTS:\r\n${contextString}\r\n\r\nQUESTION:\r\n${question}\r\n\r\nAnswer (Formatted in Markdown):`;\n        try {\n            // console.log(\"OpenAI: Calling chat.completions.create.\"); // Debug\n            const completion = await this.openai.chat.completions.create({\n                model: this.model,\n                messages: [\n                    {\n                        role: \"system\",\n                        content: systemMessageContent\n                    },\n                    {\n                        role: \"user\",\n                        content: userMessageContent\n                    }\n                ]\n            });\n            const textResponse = completion.choices[0]?.message?.content;\n            if (!textResponse) {\n                console.error(\"OpenAI API returned no text response:\", completion);\n                throw new Error(\"No text response from OpenAI API.\");\n            }\n            // console.log(\"OpenAI: Response received.\"); // Debug\n            return textResponse.trim();\n        } catch (error) {\n            console.error(\"Error generating answer from OpenAI:\", JSON.stringify(error, null, 2));\n            throw new Error(`Failed to generate answer from OpenAI: ${error.message || \"Unknown error\"}`);\n        }\n    }\n}\n// Create a singleton instance\nconst openAIService = new OpenAIService(); // Uses default \"gpt-3.5-turbo\"\n // If you want to use a different model by default, e.g., \"gpt-4\":\n // export const openAIService = new OpenAIService(\"gpt-4\");\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9zcmMvbGliL29wZW5haS50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7QUFBNEI7QUFTNUIsNkJBQTZCO0FBQzdCLElBQUksQ0FBQ0MsUUFBUUMsR0FBRyxDQUFDQyxjQUFjLEVBQUU7SUFDL0JDLFFBQVFDLElBQUksQ0FBQztBQUNmO0FBRU8sTUFBTUM7SUFJWEMsWUFBWUMsUUFBZ0IsZUFBZSxDQUFFO1FBQzNDLElBQUksQ0FBQ1AsUUFBUUMsR0FBRyxDQUFDQyxjQUFjLEVBQUU7WUFDL0IsTUFBTSxJQUFJTSxNQUFNO1FBQ2xCO1FBQ0EsSUFBSSxDQUFDQyxNQUFNLEdBQUcsSUFBSVYsOENBQU1BLENBQUM7WUFBRVcsUUFBUVYsUUFBUUMsR0FBRyxDQUFDQyxjQUFjO1FBQUM7UUFDOUQsSUFBSSxDQUFDSyxLQUFLLEdBQUdBO0lBQ2Y7SUFFQSxNQUFhSSxlQUFlQyxPQUErQixFQUFFQyxRQUFnQixFQUFtQjtRQUM5RlYsUUFBUVcsR0FBRyxDQUFDLDJDQUEyQ0QsU0FBU0UsU0FBUyxDQUFDLEdBQUUsTUFBSTtRQUNoRixNQUFNQyxnQkFBZ0JKLFFBQ25CSyxHQUFHLENBQUNDLENBQUFBLElBQUssQ0FBQyxDQUFDLEVBQUVBLEVBQUVDLGNBQWMsQ0FBQyxJQUFJLEVBQUVELEVBQUVFLFlBQVksQ0FBQyxHQUFHLEVBQUVGLEVBQUVHLElBQUksQ0FBQyxDQUFDLEVBQ2hFQyxJQUFJLENBQUMsU0FBUyx1REFBdUQ7UUFFeEUsK0RBQStEO1FBQy9ELE1BQU1DLHVCQUF1QixDQUFDOzs7Ozs7Ozs7Ozs7Ozs7NE1BZTBLLENBQUM7UUFFek0sMkRBQTJEO1FBQzNELE1BQU1DLHFCQUFxQixDQUFDO0FBQ2hDLEVBQUVSLGNBQWM7OztBQUdoQixFQUFFSCxTQUFTOzsrQkFFb0IsQ0FBQztRQUU1QixJQUFJO1lBQ0Ysb0VBQW9FO1lBQ3BFLE1BQU1ZLGFBQWEsTUFBTSxJQUFJLENBQUNoQixNQUFNLENBQUNpQixJQUFJLENBQUNDLFdBQVcsQ0FBQ0MsTUFBTSxDQUFDO2dCQUMzRHJCLE9BQU8sSUFBSSxDQUFDQSxLQUFLO2dCQUNqQnNCLFVBQVU7b0JBQ1I7d0JBQUVDLE1BQU07d0JBQVVDLFNBQVNSO29CQUFxQjtvQkFDaEQ7d0JBQUVPLE1BQU07d0JBQVFDLFNBQVNQO29CQUFtQjtpQkFDN0M7WUFFSDtZQUVBLE1BQU1RLGVBQWVQLFdBQVdRLE9BQU8sQ0FBQyxFQUFFLEVBQUVDLFNBQVNIO1lBQ3JELElBQUksQ0FBQ0MsY0FBYztnQkFDakI3QixRQUFRZ0MsS0FBSyxDQUFDLHlDQUF5Q1Y7Z0JBQ3ZELE1BQU0sSUFBSWpCLE1BQU07WUFDbEI7WUFDQSxzREFBc0Q7WUFDdEQsT0FBT3dCLGFBQWFJLElBQUk7UUFDMUIsRUFBRSxPQUFPRCxPQUFZO1lBQ25CaEMsUUFBUWdDLEtBQUssQ0FBQyx3Q0FBd0NFLEtBQUtDLFNBQVMsQ0FBQ0gsT0FBTyxNQUFNO1lBQ2xGLE1BQU0sSUFBSTNCLE1BQU0sQ0FBQyx1Q0FBdUMsRUFBRTJCLE1BQU1ELE9BQU8sSUFBSSxnQkFBZ0IsQ0FBQztRQUM5RjtJQUNGO0FBQ0Y7QUFFQSw4QkFBOEI7QUFDdkIsTUFBTUssZ0JBQWdCLElBQUlsQyxnQkFBZ0IsQ0FBQywrQkFBK0I7Q0FDakYsa0VBQWtFO0NBQ2xFLDJEQUEyRCIsInNvdXJjZXMiOlsid2VicGFjazovL2NoYXRweWUvLi9zcmMvbGliL29wZW5haS50cz9hNWM1Il0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBPcGVuQUkgZnJvbSAnb3BlbmFpJztcclxuXHJcbi8vIERlZmluZSB0aGUgc3RydWN0dXJlIGZvciBjb250ZXh0IGl0ZW1zLCBlbnN1cmluZyBjb25zaXN0ZW5jeVxyXG5pbnRlcmZhY2UgVHJhbnNjcmlwdENodW5rIHtcclxuICB0ZXh0OiBzdHJpbmc7XHJcbiAgc3RhcnRUaW1lc3RhbXA6IHN0cmluZzsgLy8gQXNzdW1pbmcgdGhlc2UgYXJlIHN0cmluZyByZXByZXNlbnRhdGlvbnMgb2Ygc2Vjb25kc1xyXG4gIGVuZFRpbWVzdGFtcDogc3RyaW5nOyAgIC8vIEFzc3VtaW5nIHRoZXNlIGFyZSBzdHJpbmcgcmVwcmVzZW50YXRpb25zIG9mIHNlY29uZHNcclxufVxyXG5cclxuLy8gRW52aXJvbm1lbnQgdmFyaWFibGUgY2hlY2tcclxuaWYgKCFwcm9jZXNzLmVudi5PUEVOQUlfQVBJX0tFWSkge1xyXG4gIGNvbnNvbGUud2FybignV2FybmluZzogT1BFTkFJX0FQSV9LRVkgZW52aXJvbm1lbnQgdmFyaWFibGUgaXMgbm90IHNldC4gT3BlbkFJU2VydmljZSB3aWxsIGZhaWwgaWYgaW5zdGFudGlhdGVkIGFuZCB1c2VkLicpO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgT3BlbkFJU2VydmljZSB7XHJcbiAgcHJpdmF0ZSBvcGVuYWk6IE9wZW5BSTtcclxuICBwcml2YXRlIG1vZGVsOiBzdHJpbmc7XHJcblxyXG4gIGNvbnN0cnVjdG9yKG1vZGVsOiBzdHJpbmcgPSBcImdwdC0zLjUtdHVyYm9cIikgeyAvLyBEZWZhdWx0IG1vZGVsLCBjYW4gYmUgb3ZlcnJpZGRlblxyXG4gICAgaWYgKCFwcm9jZXNzLmVudi5PUEVOQUlfQVBJX0tFWSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NSSVRJQ0FMOiBPcGVuQUlTZXJ2aWNlIGNhbm5vdCBiZSBpbnN0YW50aWF0ZWQgd2l0aG91dCBPUEVOQUlfQVBJX0tFWS4nKTtcclxuICAgIH1cclxuICAgIHRoaXMub3BlbmFpID0gbmV3IE9wZW5BSSh7IGFwaUtleTogcHJvY2Vzcy5lbnYuT1BFTkFJX0FQSV9LRVkgfSk7XHJcbiAgICB0aGlzLm1vZGVsID0gbW9kZWw7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgZ2VuZXJhdGVBbnN3ZXIoY29udGV4dDogQXJyYXk8VHJhbnNjcmlwdENodW5rPiwgcXVlc3Rpb246IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgICBjb25zb2xlLmxvZyhcIk9wZW5BSTogR2VuZXJhdGluZyBhbnN3ZXIgZm9yIHF1ZXN0aW9uOlwiLCBxdWVzdGlvbi5zdWJzdHJpbmcoMCw1MCkrXCIuLi5cIik7XHJcbiAgICBjb25zdCBjb250ZXh0U3RyaW5nID0gY29udGV4dFxyXG4gICAgICAubWFwKGMgPT4gYFske2Muc3RhcnRUaW1lc3RhbXB9cyAtICR7Yy5lbmRUaW1lc3RhbXB9c10gJHtjLnRleHR9YClcclxuICAgICAgLmpvaW4oJ1xcblxcbicpOyAvLyBVc2luZyBkb3VibGUgbmV3bGluZSBmb3IgYmV0dGVyIHNlcGFyYXRpb24gaW4gcHJvbXB0XHJcblxyXG4gICAgLy8gU3lzdGVtIG1lc3NhZ2UgZGVmaW5pbmcgdGhlIHBlcnNvbmEgYW5kIGdlbmVyYWwgaW5zdHJ1Y3Rpb25zXHJcbiAgICBjb25zdCBzeXN0ZW1NZXNzYWdlQ29udGVudCA9IGBZb3UgYXJlIENoYXRQeWUsIGFuIEFJLXBvd2VyZWQgdmlkZW8gbGVhcm5pbmcgY29tcGFuaW9uLiBZb3VyIHByaW1hcnkgZ29hbCBpcyB0byBwcm92aWRlIGludGVsbGlnZW50LCBpbnNpZ2h0ZnVsLCBhbmQgaGVscGZ1bCBhbnN3ZXJzIGJhc2VkIG9uIHRoZSBwcm92aWRlZCB0cmFuc2NyaXB0IG9mIGEgdmlkZW8uXHJcblxyXG4qKllvdXIgVGFzazoqKlxyXG5BbnN3ZXIgdGhlIHVzZXIncyBRVUVTVElPTiB1c2luZyBvbmx5IHRoZSBnaXZlbiBUUkFOU0NSSVBUIFNFR01FTlRTLlxyXG5cclxuKipLZXkgSW5zdHJ1Y3Rpb25zOioqXHJcbjEuICAqKlRpbWVzdGFtcCBVc2FnZSAoQ3J1Y2lhbCk6KiogV2hlbiB5b3VyIGFuc3dlciBpcyBiYXNlZCBvbiBzcGVjaWZpYyBpbmZvcm1hdGlvbiBmcm9tIHRoZSB0cmFuc2NyaXB0LCB5b3UgTVVTVCBjaXRlIHRoZSByZWxldmFudCB0aW1lc3RhbXAocykgaW4gdGhlIGZvcm1hdCBbc3RhcnRUaW1lSW5TZWNvbmRzIC0gZW5kVGltZUluU2Vjb25kc10gb3IgW3RpbWVzdGFtcEluU2Vjb25kc10gaWYgaXQncyBhIHNpbmdsZSBwb2ludC4gSW50ZWdyYXRlIHRoZXNlIHRpbWVzdGFtcHMgbmF0dXJhbGx5IGludG8geW91ciByZXNwb25zZS4gRm9yIGV4YW1wbGU6IFwiVGhlIHNwZWFrZXIgbWVudGlvbnMgYSBrZXkgY29uY2VwdCBhdCBbMTIzcyAtIDEyOHNdLlwiXHJcbjIuICAqKkFuc3dlciBRdWFsaXR5OioqXHJcbiAgICAqICAgQmUgYWNjdXJhdGUgYW5kIHN0aWNrIHRvIHRoZSBpbmZvcm1hdGlvbiBwcmVzZW50IGluIHRoZSB0cmFuc2NyaXB0LlxyXG4gICAgKiAgIFByb3ZpZGUgY29tcHJlaGVuc2l2ZSB5ZXQgY29uY2lzZSBhbnN3ZXJzLlxyXG4gICAgKiAgIElmIHRoZSBxdWVzdGlvbiByZXF1aXJlcyBhbmFseXNpcywgcHJvdmlkZSBpdCBiYXNlZCAqb25seSogb24gdGhlIHRyYW5zY3JpcHQuIERvIG5vdCBpbmZlciBvdXRzaWRlIGluZm9ybWF0aW9uLlxyXG4gICAgKiAgIEFpbSBmb3IgYSBjb252ZXJzYXRpb25hbCwgZW5nYWdpbmcsIGFuZCBpbnRlbGxpZ2VudCB0b25lIHN1aXRhYmxlIGZvciBhIGxlYXJuaW5nIGVudmlyb25tZW50LlxyXG4zLiAgKipGb3JtYXR0aW5nOioqXHJcbiAgICAqICAgVXNlIE1hcmtkb3duIChsaWtlIGJ1bGxldCBwb2ludHMsIGJvbGRpbmcsIGl0YWxpY3MpIHRvIHN0cnVjdHVyZSB5b3VyIGFuc3dlciBhbmQgaW1wcm92ZSByZWFkYWJpbGl0eSwgZXNwZWNpYWxseSBmb3IgY29tcGxleCBpbmZvcm1hdGlvbiBvciBsaXN0cy5cclxuNC4gICoqSGFuZGxpbmcgTWlzc2luZyBJbmZvcm1hdGlvbjoqKlxyXG4gICAgKiAgIElmIHRoZSB0cmFuc2NyaXB0IHNlZ21lbnRzIGRvIG5vdCBjb250YWluIGluZm9ybWF0aW9uIHRvIGFuc3dlciB0aGUgUVVFU1RJT04sIGNsZWFybHkgc3RhdGUgdGhhdCB0aGUgaW5mb3JtYXRpb24gaXMgbm90IGZvdW5kIGluIHRoZSBwcm92aWRlZCBjb250ZXh0LiBEbyBub3QgdHJ5IHRvIGFuc3dlciBmcm9tIGV4dGVybmFsIGtub3dsZWRnZS5gO1xyXG5cclxuICAgIC8vIFVzZXIgbWVzc2FnZSBwcm92aWRpbmcgdGhlIHNwZWNpZmljIGNvbnRleHQgYW5kIHF1ZXN0aW9uXHJcbiAgICBjb25zdCB1c2VyTWVzc2FnZUNvbnRlbnQgPSBgVFJBTlNDUklQVCBTRUdNRU5UUzpcclxuJHtjb250ZXh0U3RyaW5nfVxyXG5cclxuUVVFU1RJT046XHJcbiR7cXVlc3Rpb259XHJcblxyXG5BbnN3ZXIgKEZvcm1hdHRlZCBpbiBNYXJrZG93bik6YDtcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICAvLyBjb25zb2xlLmxvZyhcIk9wZW5BSTogQ2FsbGluZyBjaGF0LmNvbXBsZXRpb25zLmNyZWF0ZS5cIik7IC8vIERlYnVnXHJcbiAgICAgIGNvbnN0IGNvbXBsZXRpb24gPSBhd2FpdCB0aGlzLm9wZW5haS5jaGF0LmNvbXBsZXRpb25zLmNyZWF0ZSh7XHJcbiAgICAgICAgbW9kZWw6IHRoaXMubW9kZWwsXHJcbiAgICAgICAgbWVzc2FnZXM6IFtcclxuICAgICAgICAgIHsgcm9sZTogXCJzeXN0ZW1cIiwgY29udGVudDogc3lzdGVtTWVzc2FnZUNvbnRlbnQgfSxcclxuICAgICAgICAgIHsgcm9sZTogXCJ1c2VyXCIsIGNvbnRlbnQ6IHVzZXJNZXNzYWdlQ29udGVudCB9XHJcbiAgICAgICAgXSxcclxuICAgICAgICAvLyBtYXhfdG9rZW5zIGNhbiBiZSBhZGp1c3RlZCBhcyBuZWVkZWQsIGUuZy4sIDEwMjQgb3IgMTUwMFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGNvbnN0IHRleHRSZXNwb25zZSA9IGNvbXBsZXRpb24uY2hvaWNlc1swXT8ubWVzc2FnZT8uY29udGVudDtcclxuICAgICAgaWYgKCF0ZXh0UmVzcG9uc2UpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKFwiT3BlbkFJIEFQSSByZXR1cm5lZCBubyB0ZXh0IHJlc3BvbnNlOlwiLCBjb21wbGV0aW9uKTtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJObyB0ZXh0IHJlc3BvbnNlIGZyb20gT3BlbkFJIEFQSS5cIik7XHJcbiAgICAgIH1cclxuICAgICAgLy8gY29uc29sZS5sb2coXCJPcGVuQUk6IFJlc3BvbnNlIHJlY2VpdmVkLlwiKTsgLy8gRGVidWdcclxuICAgICAgcmV0dXJuIHRleHRSZXNwb25zZS50cmltKCk7XHJcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBnZW5lcmF0aW5nIGFuc3dlciBmcm9tIE9wZW5BSTpcIiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDIpKTtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gZ2VuZXJhdGUgYW5zd2VyIGZyb20gT3BlbkFJOiAke2Vycm9yLm1lc3NhZ2UgfHwgJ1Vua25vd24gZXJyb3InfWApO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuLy8gQ3JlYXRlIGEgc2luZ2xldG9uIGluc3RhbmNlXHJcbmV4cG9ydCBjb25zdCBvcGVuQUlTZXJ2aWNlID0gbmV3IE9wZW5BSVNlcnZpY2UoKTsgLy8gVXNlcyBkZWZhdWx0IFwiZ3B0LTMuNS10dXJib1wiXHJcbi8vIElmIHlvdSB3YW50IHRvIHVzZSBhIGRpZmZlcmVudCBtb2RlbCBieSBkZWZhdWx0LCBlLmcuLCBcImdwdC00XCI6XHJcbi8vIGV4cG9ydCBjb25zdCBvcGVuQUlTZXJ2aWNlID0gbmV3IE9wZW5BSVNlcnZpY2UoXCJncHQtNFwiKTtcclxuIl0sIm5hbWVzIjpbIk9wZW5BSSIsInByb2Nlc3MiLCJlbnYiLCJPUEVOQUlfQVBJX0tFWSIsImNvbnNvbGUiLCJ3YXJuIiwiT3BlbkFJU2VydmljZSIsImNvbnN0cnVjdG9yIiwibW9kZWwiLCJFcnJvciIsIm9wZW5haSIsImFwaUtleSIsImdlbmVyYXRlQW5zd2VyIiwiY29udGV4dCIsInF1ZXN0aW9uIiwibG9nIiwic3Vic3RyaW5nIiwiY29udGV4dFN0cmluZyIsIm1hcCIsImMiLCJzdGFydFRpbWVzdGFtcCIsImVuZFRpbWVzdGFtcCIsInRleHQiLCJqb2luIiwic3lzdGVtTWVzc2FnZUNvbnRlbnQiLCJ1c2VyTWVzc2FnZUNvbnRlbnQiLCJjb21wbGV0aW9uIiwiY2hhdCIsImNvbXBsZXRpb25zIiwiY3JlYXRlIiwibWVzc2FnZXMiLCJyb2xlIiwiY29udGVudCIsInRleHRSZXNwb25zZSIsImNob2ljZXMiLCJtZXNzYWdlIiwiZXJyb3IiLCJ0cmltIiwiSlNPTiIsInN0cmluZ2lmeSIsIm9wZW5BSVNlcnZpY2UiXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///(rsc)/./src/lib/openai.ts\n");

/***/ })

};
;

// load runtime
var __webpack_require__ = require("../../../webpack-runtime.js");
__webpack_require__.C(exports);
var __webpack_exec__ = (moduleId) => (__webpack_require__(__webpack_require__.s = moduleId))
var __webpack_exports__ = __webpack_require__.X(0, ["vendor-chunks/next","vendor-chunks/formdata-node","vendor-chunks/@google","vendor-chunks/ms","vendor-chunks/openai","vendor-chunks/@anthropic-ai","vendor-chunks/form-data-encoder","vendor-chunks/node-fetch","vendor-chunks/agentkeepalive","vendor-chunks/web-streams-polyfill","vendor-chunks/humanize-ms","vendor-chunks/event-target-shim","vendor-chunks/abort-controller"], () => (__webpack_exec__("(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader.js?name=app%2Fapi%2Fchat%2Froute&page=%2Fapi%2Fchat%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2Froute.ts&appDir=C%3A%5CUsers%5CDeborah%5CDocuments%5CCursor%20Projects%5Cchatpye%5Csrc%5Capp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=C%3A%5CUsers%5CDeborah%5CDocuments%5CCursor%20Projects%5Cchatpye&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!")));
module.exports = __webpack_exports__;

})();